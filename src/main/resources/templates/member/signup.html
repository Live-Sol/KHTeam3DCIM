<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입</title>
    <link rel="stylesheet" th:href="@{/css/memberStyle.css}">
</head>
<body>

<div class="container">
    <h2>회원가입</h2>

    <div th:if="${error}" style="color:red; margin-bottom: 15px;">
        <p th:text="${error}"></p>
    </div>

    <form id="signupForm" th:action="@{/members}" method="POST">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <!-- 아이디 -->
        <div>
            <label for="memberId">아이디</label>
            <div class="id-check-group">
                <input type="text" id="memberId" name="memberId" required>
                <button type="button" id="checkIdBtn">중복 확인</button>
            </div>

            <span id="idCheckMsg"></span>
            <div id="memberIdPatternError" style="color:red; display:none;">
                아이디는 영문자와 숫자만 사용하여 4~20자여야 합니다.
            </div>
            <div id="memberIdCheckError" style="color:red; display:none;">
                이미 사용 중인 아이디입니다.
            </div>
            <div id="memberIdCheckSuccess" style="color:green; display:none;">
                사용 가능한 아이디입니다.
            </div>
        </div>



        <!-- 비밀번호 -->
        <div>
            <label for="password">비밀번호</label>
            <input type="password" id="password" name="password" required>
            <div id="passwordError" style="color:red; display:none;">
                비밀번호는 영문자와 숫자를 모두 포함하여 5~20자여야 합니다.
            </div>
        </div>

        <!-- 비밀번호 확인 -->
        <div>
            <label for="passwordConfirm">비밀번호 확인</label>
            <input type="password" id="passwordConfirm" required>
            <div id="passwordConfirmError" style="color:red; display:none;">
                비밀번호가 일치하지 않습니다.
            </div>
        </div>

        <!-- 이름 -->
        <div>
            <label for="name">담당자 성함</label>
            <input type="text" id="name" name="name" required>
            <div id="nameError" style="color:red; display:none;">
                이름은 한글과 알파벳만 가능하며, 2~10글자여야 합니다.
            </div>
        </div>

        <!-- 담당자 번호 -->
        <div>
            <label for="contact">담당자 번호</label>
            <input type="text" id="contact" name="contact" placeholder="010-0000-0000" required>
            <div id="contactError" style="color:red; display:none;">
                전화번호 형식은 000-0000-0000 입니다.
            </div>
        </div>

        <!-- 이메일 -->
        <div>
            <label for="email">담당자 이메일</label>
            <input type="email" id="email" name="email" required>
            <div id="emailError" style="color:red; display:none;">
                올바른 이메일 형식이 아닙니다.
            </div>
        </div>

        <!-- 회사명 -->
        <div>
            <label for="companyName">회사명</label>
            <input type="text" id="companyName" name="companyName" placeholder="KH전자" required>
            <div id="companyNameError" style="color:red; display:none;">
                회사명은 2~30자의 한글, 영문, 숫자만 가능합니다.
            </div>
        </div>

        <!-- 회사 대표 번호 -->
        <div>
            <label for="companyPhone">회사 대표 번호</label>
            <input type="text" id="companyPhone" name="companyPhone" placeholder="052-000-0000" required>
            <div id="companyPhoneError" style="color:red; display:none;">
                회사 대표 번호 형식이 올바르지 않습니다.
            </div>
        </div>

        <input type="hidden" name="role" value="USER">

        <div>
            <button type="submit">회원가입</button>
        </div>
    </form>
</div>

<script>
    /* ======================
   공통 변수
====================== */
    const memberIdInput = document.getElementById('memberId');
    const memberIdPatternError = document.getElementById('memberIdPatternError');
    const memberIdCheckError = document.getElementById('memberIdCheckError');
    const memberIdCheckSuccess = document.getElementById('memberIdCheckSuccess');
    const checkIdBtn = document.getElementById('checkIdBtn');

    let isMemberIdAvailable = false;

    /* ======================
       아이디 변경 시 중복확인 무효화
    ====================== */
    memberIdInput.addEventListener('input', function () {
        isMemberIdAvailable = false;
        memberIdCheckSuccess.style.display = 'none';
        memberIdCheckError.style.display = 'none';
        // 입력이 시작되면 패턴 오류 메시지를 숨겨서 사용자에게 부담을 줄여줌
        memberIdPatternError.style.display = 'none';
    });

    /* ======================
       아이디 중복 검사 (버튼 클릭)
    ====================== */
    checkIdBtn.addEventListener('click', function () {
        const memberId = memberIdInput.value.trim();
        const pattern = /^[a-zA-Z0-9]{4,20}$/;

        if (!pattern.test(memberId)) {
            memberIdPatternError.style.display = 'block';
            memberIdInput.focus();
            // 패턴 오류 시 중복 확인 관련 메시지는 모두 숨김
            memberIdCheckSuccess.style.display = 'none';
            memberIdCheckError.style.display = 'none';
            return;
        }

        memberIdPatternError.style.display = 'none';
        memberIdCheckError.style.display = 'none'; // 새 검사 시작 시 기존 오류 메시지 숨김

        // fetch 오류 처리 강화 (이전 답변에서 권장한 내용 적용)
        fetch(`/members/check-id?memberId=${memberId}`)
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                if (data.available) {
                    memberIdCheckSuccess.style.display = 'block';
                    memberIdCheckError.style.display = 'none';
                    isMemberIdAvailable = true;
                } else {
                    memberIdCheckError.style.display = 'block';
                    memberIdCheckSuccess.style.display = 'none';
                    isMemberIdAvailable = false;
                }
            })
            .catch(error => {
                console.error("아이디 중복 검사 중 오류 발생:", error);
                alert("서버 연결에 실패했거나 예기치 않은 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.");
                memberIdCheckError.style.display = 'block';
                memberIdCheckSuccess.style.display = 'none';
                isMemberIdAvailable = false;
            });
    });

    /* ======================
       폼 제출 시 최종 검증 (수정된 핵심 로직)
    ====================== */
    document.getElementById('signupForm').addEventListener('submit', function(event) {
        let valid = true; // 현재까지 오류가 없는지 추적

        /* 1. 아이디 (패턴 + 중복 확인) */
        const memberId = memberIdInput.value.trim();
        const memberIdPattern = /^[a-zA-Z0-9]{4,20}$/;

        // 1-1. 아이디 패턴 검사
        if (!memberIdPattern.test(memberId)) {
            memberIdPatternError.style.display = 'block';
            if (valid) { // 첫 번째 오류 필드에만 focus
                memberIdInput.focus();
            }
            valid = false;
        } else {
            memberIdPatternError.style.display = 'none';

            // 1-2. 패턴이 유효할 경우에만 중복 확인 여부 검사
            if (!isMemberIdAvailable) {
                memberIdCheckError.style.display = 'block'; // 중복 확인 실패 또는 미완료 메시지 표시 (기존의 alert 대신)
                alert("사용 가능한 아이디인지 중복 확인을 완료해야 합니다.");
                if (valid) {
                    memberIdInput.focus();
                }
                valid = false;
            } else {
                memberIdCheckError.style.display = 'none';
            }
        }


        /* 2. 비밀번호 */
        const password = document.getElementById('password').value;
        const passwordPattern = /^(?=.*[a-zA-Z])(?=.*\d)[a-zA-Z\d]{5,20}$/;
        const passwordError = document.getElementById('passwordError');

        if (!passwordPattern.test(password)) {
            passwordError.style.display = 'block';
            if (valid) {
                document.getElementById('password').focus();
            }
            valid = false;
        } else {
            passwordError.style.display = 'none';
        }

        /* 3. 비밀번호 확인 */
        const passwordConfirm = document.getElementById('passwordConfirm').value;
        const passwordConfirmError = document.getElementById('passwordConfirmError');

        if (password !== passwordConfirm) {
            passwordConfirmError.style.display = 'block';
            if (valid) {
                document.getElementById('passwordConfirm').focus();
            }
            valid = false;
        } else {
            passwordConfirmError.style.display = 'none';
        }

        /* 4. 이름 */
        const name = document.getElementById('name').value.trim();
        const namePattern = /^[a-zA-Z가-힣]{2,10}$/;
        const nameError = document.getElementById('nameError');

        if (!namePattern.test(name)) {
            nameError.style.display = 'block';
            if (valid) {
                document.getElementById('name').focus();
            }
            valid = false;
        } else {
            nameError.style.display = 'none';
        }

        /* 5. 전화번호 (담당자, 회사 공통 패턴) */
        const phonePattern = /^\d{2,3}-\d{3,4}-\d{4}$/;

        /* 6. 담당자 번호 */
        const contact = document.getElementById('contact').value.trim();
        const contactError = document.getElementById('contactError');

        if (!phonePattern.test(contact)) {
            contactError.style.display = 'block';
            if (valid) {
                document.getElementById('contact').focus();
            }
            valid = false;
        } else {
            contactError.style.display = 'none';
        }

        /* 7. 이메일 */
        const email = document.getElementById('email').value.trim();
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const emailError = document.getElementById('emailError');

        if (!emailPattern.test(email)) {
            emailError.style.display = 'block';
            if (valid) {
                document.getElementById('email').focus();
            }
            valid = false;
        } else {
            emailError.style.display = 'none';
        }

        /* 8. 회사명 */
        const companyName = document.getElementById('companyName').value.trim();
        // \s(공백) 허용 여부에 따라 패턴을 조정하세요. (현재 패턴은 공백을 허용합니다.)
        const companyNamePattern = /^[a-zA-Z0-9가-힣\s]{2,30}$/;
        const companyNameError = document.getElementById('companyNameError');

        if (!companyNamePattern.test(companyName)) {
            companyNameError.style.display = 'block';
            if (valid) {
                document.getElementById('companyName').focus();
            }
            valid = false;
        } else {
            companyNameError.style.display = 'none';
        }

        /* 9. 회사 대표 번호 */
        const companyPhone = document.getElementById('companyPhone').value.trim();
        const companyPhoneError = document.getElementById('companyPhoneError');

        if (!phonePattern.test(companyPhone)) {
            companyPhoneError.style.display = 'block';
            if (valid) {
                document.getElementById('companyPhone').focus();
            }
            valid = false;
        } else {
            companyPhoneError.style.display = 'none';
        }

        if (!valid) {
            event.preventDefault(); // 유효성 검사 실패 시 폼 제출 방지
        }
    });
</script>

<!--
아이디 - 형식 + 서버 중복 검사
비밀번호 - 영문+숫자 조합, 5~20자
비밀번호 확인 - 비밀번호와 일치 여부
담당자 이름 - 한글/영문, 2~10자
담당자 번호 - 전화번호 형식
담당자 이메일 - 이메일 기본 형식
회사명 - 한글/영문/숫자, 2~30자
회사 대표 번호 -  전화번호 형식
-->
</body>
</html>
