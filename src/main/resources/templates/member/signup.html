<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StarRoot - Registration</title>

    <!-- 공통 라이브러리 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">

    <!-- 스타일 시트 -->
    <link href="/css/index.css" rel="stylesheet">
    <link href="/css/memberStyle.css" rel="stylesheet">
</head>
<body class="login-body">

<!-- 1. 네비게이션 헤더 -->
<div th:replace="~{fragments/header :: header}"></div>

<!-- 2. 회원가입 메인 섹션 -->
<div class="login-wrapper">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-xl-7">

                <!-- Glassmorphism Card -->
                <div class="card login-card">
                    <div class="card-body p-5">

                        <!-- Title -->
                        <div class="text-center mb-5">
                            <h2 class="login-title">NEW AGENT REGISTRATION</h2>
                            <p class="text-white-50 small">Create your identity to access StarRoot DCIM.</p>
                        </div>

                        <!-- Global Error Message -->
                        <div th:if="${error}" class="alert alert-custom mb-4" role="alert">
                            <i class="bi bi-exclamation-octagon-fill me-2"></i>
                            <span th:text="${error}">회원가입 중 문제가 발생했습니다.</span>
                        </div>

                        <form id="signupForm" th:action="@{/members}" method="POST">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                            <!-- 섹션 1: 계정 정보 -->
                            <h6 class="text-white-50 border-bottom border-secondary border-opacity-25 pb-2 mb-4">
                                <i class="bi bi-shield-lock me-2"></i>Account Credentials
                            </h6>

                            <!-- 아이디 + 중복확인 -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="input-group">
                                        <div class="form-floating flex-grow-1">
                                            <input type="text" class="form-control form-control-custom rounded-end-0" id="memberId" name="memberId" placeholder="User ID" required>
                                            <label for="memberId">User ID</label>
                                        </div>
                                        <button type="button" class="btn btn-check-custom px-4" id="checkIdBtn">
                                            <i class="bi bi-check2-circle me-1"></i> Check
                                        </button>
                                    </div>
                                    <!-- 메시지 영역 -->
                                    <div id="memberIdPatternError" class="validation-msg text-error" style="display:none;">
                                        <i class="bi bi-x-circle"></i> 영문자와 숫자만 사용하여 4~20자여야 합니다.
                                    </div>
                                    <div id="memberIdCheckError" class="validation-msg text-error" style="display:none;">
                                        <i class="bi bi-x-circle"></i> 이미 사용 중인 아이디입니다.
                                    </div>
                                    <div id="memberIdCheckSuccess" class="validation-msg text-success-custom" style="display:none;">
                                        <i class="bi bi-check-circle-fill"></i> 사용 가능한 아이디입니다.
                                    </div>
                                </div>
                            </div>

                            <!-- 비밀번호 & 확인 (2단 배열) -->
                            <div class="row mb-4">
                                <div class="col-md-6 mb-4 mb-md-0">
                                    <div class="form-floating">
                                        <input type="password" class="form-control form-control-custom" id="password" name="password" placeholder="Password" required>
                                        <label for="password">Password</label>
                                    </div>
                                    <div id="passwordError" class="validation-msg text-error" style="display:none;">
                                        <i class="bi bi-info-circle"></i> 영문+숫자 포함 5~20자
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="password" class="form-control form-control-custom" id="passwordConfirm" placeholder="Confirm Password" required>
                                        <label for="passwordConfirm">Confirm Password</label>
                                    </div>
                                    <div id="passwordConfirmError" class="validation-msg text-error" style="display:none;">
                                        <i class="bi bi-exclamation-triangle"></i> 비밀번호가 일치하지 않습니다.
                                    </div>
                                </div>
                            </div>

                            <!-- 섹션 2: 개인 정보 -->
                            <h6 class="text-white-50 border-bottom border-secondary border-opacity-25 pb-2 mb-4 mt-2">
                                <i class="bi bi-person-vcard me-2"></i>Personal Info
                            </h6>

                            <!-- 이름 & 연락처 -->
                            <div class="row mb-4">
                                <div class="col-md-6 mb-4 mb-md-0">
                                    <div class="form-floating">
                                        <input type="text" class="form-control form-control-custom" id="name" name="name" placeholder="Name" required>
                                        <label for="name">Name</label>
                                    </div>
                                    <div id="nameError" class="validation-msg text-error" style="display:none;">
                                        <i class="bi bi-x-circle"></i> 한글/영문 2~10자
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control form-control-custom" id="contact" name="contact" placeholder="010-0000-0000" required>
                                        <label for="contact">Phone (010-0000-0000)</label>
                                    </div>
                                    <div id="contactError" class="validation-msg text-error" style="display:none;">
                                        <i class="bi bi-x-circle"></i> 형식이 올바르지 않습니다.
                                    </div>
                                </div>
                            </div>

                            <!-- 이메일 -->
                            <div class="mb-4">
                                <div class="form-floating">
                                    <input type="email" class="form-control form-control-custom" id="email" name="email" placeholder="Email" required>
                                    <label for="email">Email Address</label>
                                </div>
                                <div id="emailError" class="validation-msg text-error" style="display:none;">
                                    <i class="bi bi-x-circle"></i> 올바른 이메일 형식이 아닙니다.
                                </div>
                            </div>

                            <!-- 섹션 3: 회사 정보 -->
                            <h6 class="text-white-50 border-bottom border-secondary border-opacity-25 pb-2 mb-4 mt-2">
                                <i class="bi bi-building me-2"></i>Company Info
                            </h6>

                            <div class="row mb-4">
                                <div class="col-md-6 mb-4 mb-md-0">
                                    <div class="form-floating">
                                        <input type="text" class="form-control form-control-custom" id="companyName" name="companyName" placeholder="Company Name" required>
                                        <label for="companyName">Company Name</label>
                                    </div>
                                    <div id="companyNameError" class="validation-msg text-error" style="display:none;">
                                        <i class="bi bi-x-circle"></i> 2~30자 (특수문자 제외)
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control form-control-custom" id="companyPhone" name="companyPhone" placeholder="052-000-0000" required>
                                        <label for="companyPhone">Company Phone</label>
                                    </div>
                                    <div id="companyPhoneError" class="validation-msg text-error" style="display:none;">
                                        <i class="bi bi-x-circle"></i> 번호 형식이 올바르지 않습니다.
                                    </div>
                                </div>
                            </div>

                            <input type="hidden" name="role" value="USER">

                            <!-- Submit Button -->
                            <div class="d-grid gap-2 mt-5">
                                <button type="submit" class="btn btn-login btn-lg">
                                    REGISTER IDENTITY <i class="bi bi-arrow-right-short"></i>
                                </button>
                            </div>

                            <div class="text-center mt-3">
                                <p class="text-white-50 small">
                                    Already have an account? <a th:href="@{/members/login}" class="link-cyan fw-bold">Log In</a>
                                </p>
                            </div>
                        </form>
                    </div>

                    <!-- Decorative Element -->
                    <div class="card-footer-glow"></div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- 3. 푸터 -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- 4. 기능 스크립트 (기존 로직 유지) -->
<script>
    /* ======================
       공통 변수
    ====================== */
    const memberIdInput = document.getElementById('memberId');
    const memberIdPatternError = document.getElementById('memberIdPatternError');
    const memberIdCheckError = document.getElementById('memberIdCheckError');
    const memberIdCheckSuccess = document.getElementById('memberIdCheckSuccess');
    const checkIdBtn = document.getElementById('checkIdBtn');

    let isMemberIdAvailable = false;

    /* ======================
       아이디 변경 시 중복확인 무효화
    ====================== */
    memberIdInput.addEventListener('input', function () {
        isMemberIdAvailable = false;
        memberIdCheckSuccess.style.display = 'none';
        memberIdCheckError.style.display = 'none';
        memberIdPatternError.style.display = 'none';
    });

    /* ======================
       아이디 중복 검사 (버튼 클릭)
    ====================== */
    checkIdBtn.addEventListener('click', function () {
        const memberId = memberIdInput.value.trim();
        const pattern = /^[a-zA-Z0-9]{4,20}$/;

        if (!pattern.test(memberId)) {
            memberIdPatternError.style.display = 'flex'; // flex로 변경 (아이콘 정렬)
            memberIdInput.focus();
            memberIdCheckSuccess.style.display = 'none';
            memberIdCheckError.style.display = 'none';
            return;
        }

        memberIdPatternError.style.display = 'none';
        memberIdCheckError.style.display = 'none';

        // Fetch API
        fetch(`/members/check-id?memberId=${memberId}`)
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                if (data.available) {
                    memberIdCheckSuccess.style.display = 'flex';
                    memberIdCheckError.style.display = 'none';
                    isMemberIdAvailable = true;
                } else {
                    memberIdCheckError.style.display = 'flex';
                    memberIdCheckSuccess.style.display = 'none';
                    isMemberIdAvailable = false;
                }
            })
            .catch(error => {
                console.error("아이디 중복 검사 중 오류 발생:", error);
                alert("서버 연결에 실패했습니다. 잠시 후 다시 시도해 주세요.");
                memberIdCheckError.style.display = 'flex';
                memberIdCheckSuccess.style.display = 'none';
                isMemberIdAvailable = false;
            });
    });

    /* ======================
       폼 제출 시 최종 검증
    ====================== */
    document.getElementById('signupForm').addEventListener('submit', function(event) {
        let valid = true;

        /* 1. 아이디 (패턴 + 중복 확인) */
        const memberId = memberIdInput.value.trim();
        const memberIdPattern = /^[a-zA-Z0-9]{4,20}$/;

        if (!memberIdPattern.test(memberId)) {
            memberIdPatternError.style.display = 'flex';
            if (valid) memberIdInput.focus();
            valid = false;
        } else {
            memberIdPatternError.style.display = 'none';
            if (!isMemberIdAvailable) {
                alert("아이디 중복 확인을 완료해주세요.");
                if (valid) memberIdInput.focus();
                valid = false;
            }
        }

        /* 2. 비밀번호 */
        const password = document.getElementById('password').value;
        const passwordPattern = /^(?=.*[a-zA-Z])(?=.*\d)[a-zA-Z\d]{5,20}$/;
        const passwordError = document.getElementById('passwordError');

        if (!passwordPattern.test(password)) {
            passwordError.style.display = 'flex';
            if (valid) document.getElementById('password').focus();
            valid = false;
        } else {
            passwordError.style.display = 'none';
        }

        /* 3. 비밀번호 확인 */
        const passwordConfirm = document.getElementById('passwordConfirm').value;
        const passwordConfirmError = document.getElementById('passwordConfirmError');

        if (password !== passwordConfirm) {
            passwordConfirmError.style.display = 'flex';
            if (valid) document.getElementById('passwordConfirm').focus();
            valid = false;
        } else {
            passwordConfirmError.style.display = 'none';
        }

        /* 4. 이름 */
        const name = document.getElementById('name').value.trim();
        const namePattern = /^[a-zA-Z가-힣]{2,10}$/;
        const nameError = document.getElementById('nameError');

        if (!namePattern.test(name)) {
            nameError.style.display = 'flex';
            if (valid) document.getElementById('name').focus();
            valid = false;
        } else {
            nameError.style.display = 'none';
        }

        /* 5. 담당자 번호 */
        const phonePattern = /^\d{2,3}-\d{3,4}-\d{4}$/;
        const contact = document.getElementById('contact').value.trim();
        const contactError = document.getElementById('contactError');

        if (!phonePattern.test(contact)) {
            contactError.style.display = 'flex';
            if (valid) document.getElementById('contact').focus();
            valid = false;
        } else {
            contactError.style.display = 'none';
        }

        /* 6. 이메일 */
        const email = document.getElementById('email').value.trim();
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const emailError = document.getElementById('emailError');

        if (!emailPattern.test(email)) {
            emailError.style.display = 'flex';
            if (valid) document.getElementById('email').focus();
            valid = false;
        } else {
            emailError.style.display = 'none';
        }

        /* 7. 회사명 */
        const companyName = document.getElementById('companyName').value.trim();
        const companyNamePattern = /^[a-zA-Z0-9가-힣\s]{2,30}$/;
        const companyNameError = document.getElementById('companyNameError');

        if (!companyNamePattern.test(companyName)) {
            companyNameError.style.display = 'flex';
            if (valid) document.getElementById('companyName').focus();
            valid = false;
        } else {
            companyNameError.style.display = 'none';
        }

        /* 8. 회사 대표 번호 */
        const companyPhone = document.getElementById('companyPhone').value.trim();
        const companyPhoneError = document.getElementById('companyPhoneError');

        if (!phonePattern.test(companyPhone)) {
            companyPhoneError.style.display = 'flex';
            if (valid) document.getElementById('companyPhone').focus();
            valid = false;
        } else {
            companyPhoneError.style.display = 'none';
        }

        if (!valid) {
            event.preventDefault();
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>