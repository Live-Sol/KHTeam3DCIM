<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>StarRoot - Password Recovery</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="/css/index.css" rel="stylesheet">
    <link href="/css/memberStyle.css" rel="stylesheet">
</head>
<body class="login-body">

<!-- 1. 네비게이션 헤더 (모듈화) -->
<div th:replace="~{fragments/header :: header}"></div>

<!-- 2. 메인 컨텐츠 래퍼 -->
<div class="login-wrapper">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6 col-xl-5">

                <!-- [디자인] Glassmorphism 카드 UI -->
                <div class="card login-card">
                    <div class="card-body p-5">

                        <!-- 타이틀 영역 -->
                        <div class="text-center mb-5">
                            <h2 class="login-title">STAR-ROOT<br>ACCOUNT RECOVERY</h2>
                            <p class="text-white-50 small">비밀번호 재설정을 위해 이메일 인증을 진행합니다.</p>
                        </div>

                        <!--
                           [서버 에러 메시지]
                           - 백엔드에서 검증 실패 시(정보 불일치 등) 리다이렉트와 함께 전달된 에러 메시지 출력
                        -->
                        <div th:if="${error}" class="alert alert-custom mb-4" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <span th:text="${error}">정보가 일치하지 않습니다.</span>
                        </div>

                        <!--
                           [비밀번호 재설정 폼]
                           - action: /members/forgot-password (POST) -> 최종적으로 비밀번호를 변경하는 요청
                           - id="resetForm": JS 제어용 ID
                        -->
                        <form th:action="@{/members/forgot-password}" method="post" id="resetForm">

                            <!--
                               [보안] CSRF 토큰 설정
                               1. 폼 전송용 hidden input
                               2. AJAX 요청용 hidden input (id="csrfToken")
                            -->
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <input type="hidden" id="csrfToken" th:value="${_csrf.token}">

                            <!-- =============================================
                                 STEP 1: 계정 정보 인증 (AJAX)
                                 - 사용자가 입력한 ID, 이름, 이메일이 일치하는지 확인하고 인증번호를 발송합니다.
                            ============================================= -->
                            <h6 class="text-white-50 border-bottom border-secondary border-opacity-25 pb-2 mb-4">
                                <i class="bi bi-person-check me-2"></i>계정 인증
                            </h6>

                            <!-- 아이디 -->
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control form-control-custom" id="memberId" name="memberId" placeholder="User ID" required>
                                <label for="memberId">아이디</label>
                            </div>

                            <!-- 이름 (본인 확인용) -->
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control form-control-custom" id="name" name="name" placeholder="Name" required>
                                <label for="name">담당자 성함</label>
                            </div>

                            <!-- 이메일 + 발송 버튼 -->
                            <div class="input-group mb-3">
                                <div class="form-floating flex-grow-1">
                                    <input type="email" class="form-control form-control-custom rounded-end-0" id="email" name="email" placeholder="Email" required>
                                    <label for="email">담당자 이메일</label>
                                </div>
                                <!--
                                   [UX] type="button"
                                   - 폼을 제출하지 않고 자바스크립트 함수만 실행하기 위해 submit이 아닌 button 타입을 사용합니다.
                                -->
                                <button type="button" class="btn btn-check-custom px-3" id="sendCodeBtn">
                                    <i class="bi bi-send me-1"></i> 인증번호 발송
                                </button>
                            </div>

                            <!-- =============================================
                                 STEP 2: 인증번호 입력 (초기 숨김)
                                 - 이메일 발송 성공 시 JS로 display: block 처리됩니다.
                            ============================================= -->
                            <div id="verifySection" style="display:none;" class="mb-4">
                                <div class="input-group">
                                    <div class="form-floating flex-grow-1">
                                        <input type="text" class="form-control form-control-custom rounded-end-0" id="authCode" placeholder="Code">
                                        <label for="authCode">인증번호 6자리</label>
                                    </div>
                                    <button type="button" class="btn btn-primary px-4" id="verifyBtn">
                                        확인
                                    </button>
                                </div>
                                <!-- 인증 결과 피드백 메시지 -->
                                <div class="mt-2">
                                    <small class="text-success-custom fw-bold" id="verifySuccessMsg" style="display:none;">
                                        <i class="bi bi-check-circle-fill me-1"></i> 인증되었습니다. 비밀번호를 변경하세요.
                                    </small>
                                    <small class="text-danger fw-bold" id="verifyErrorMsg" style="display:none;">
                                        <i class="bi bi-x-circle-fill me-1"></i> 인증번호가 일치하지 않습니다.
                                    </small>
                                </div>
                            </div>

                            <!-- =============================================
                                 STEP 3: 새 비밀번호 설정 (초기 비활성화)
                                 - 인증 성공 시 JS로 disabled 속성이 제거됩니다.
                            ============================================= -->
                            <h6 class="text-white-50 border-bottom border-secondary border-opacity-25 pb-2 mb-4 mt-2">
                                <i class="bi bi-key me-2"></i>새 비밀번호 설정
                            </h6>

                            <!-- 새 비밀번호 -->
                            <div class="form-floating mb-3">
                                <input type="password" class="form-control form-control-custom" id="newPassword" name="newPassword" placeholder="New Password" required disabled>
                                <label for="newPassword">새로운 비밀번호</label>
                                <!-- 유효성 검사 에러 메시지 -->
                                <div id="passwordError" class="validation-msg text-error" style="display:none;">
                                    <i class="bi bi-info-circle"></i> 영문+숫자 포함 5~20자
                                </div>
                            </div>

                            <!-- 비밀번호 재확인 -->
                            <div class="form-floating mb-4">
                                <input type="password" class="form-control form-control-custom" id="confirmPassword" placeholder="Confirm Password" required disabled>
                                <label for="confirmPassword">비밀번호 재확인</label>
                                <div id="passwordConfirmError" class="validation-msg text-error" style="display:none;">
                                    <i class="bi bi-exclamation-triangle"></i> 비밀번호가 일치하지 않습니다.
                                </div>
                            </div>

                            <!--
                               [최종 제출 버튼]
                               - 인증 전에는 비활성화(disabled) 상태입니다.
                               - 클릭 시 /members/forgot-password로 폼 데이터를 전송합니다.
                            -->
                            <div class="d-grid gap-2 mt-5">
                                <button type="submit" class="btn btn-login btn-lg" id="submitBtn" disabled>
                                    비밀번호 변경하기 <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>

                            <!-- 하단 링크 -->
                            <div class="text-center mt-4">
                                <a th:href="@{/members/login}" class="link-cyan small">
                                    <i class="bi bi-arrow-left"></i> 로그인 페이지로 돌아가기
                                </a>
                            </div>

                        </form>
                    </div>

                    <!-- 장식용 하단 발광 효과 -->
                    <div class="card-footer-glow"></div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- 3. 푸터 -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- 4. 모달: 비밀번호 변경 성공 -->
<div class="modal fade modal-custom" id="successModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <button type="button" class="btn-close btn-close-white" onclick="location.href='/members/login'"></button>
            </div>

            <div class="modal-body text-center p-5 pt-0">
                <div class="mb-4">
                    <div class="rounded-circle d-inline-flex align-items-center justify-content-center"
                         style="width: 80px; height: 80px; background: rgba(0, 210, 211, 0.1); border: 2px solid #00d2d3;">
                        <i class="bi bi-check-lg" style="font-size: 40px; color: #00d2d3;"></i>
                    </div>
                </div>

                <h4 class="text-white fw-bold mb-3">비밀번호 변경 완료!</h4>
                <p class="text-white-50 mb-4">
                    비밀번호가 안전하게 변경되었습니다.<br>
                    새로운 비밀번호로 로그인해 주세요.
                </p>

                <div class="d-grid gap-2">
                    <a th:href="@{/members/login}" class="btn btn-login btn-lg">
                        로그인 하러가기 <i class="bi bi-box-arrow-in-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!--
    [기능 스크립트]
    1. 이메일 인증번호 발송 (AJAX)
    2. 인증번호 검증 (AJAX)
    3. UI 상태 제어 (입력창 잠금/해제)
    4. 최종 비밀번호 유효성 검사
-->
<script>
    /* =========================================
       DOM 요소 캐싱
       ========================================= */
    const csrfToken = document.getElementById('csrfToken').value;
    const sendCodeBtn = document.getElementById('sendCodeBtn');
    const verifySection = document.getElementById('verifySection');
    const verifyBtn = document.getElementById('verifyBtn');

    // 입력 필드들
    const memberIdInput = document.getElementById('memberId');
    const nameInput = document.getElementById('name');
    const emailInput = document.getElementById('email');
    const authCodeInput = document.getElementById('authCode');
    const newPwInput = document.getElementById('newPassword');
    const confirmPwInput = document.getElementById('confirmPassword');
    const submitBtn = document.getElementById('submitBtn');

    // 메시지 영역
    const verifySuccessMsg = document.getElementById('verifySuccessMsg');
    const verifyErrorMsg = document.getElementById('verifyErrorMsg');

    /* =========================================
       1. 인증번호 발송 요청
       - MemberController.sendVerificationCode() 호출
       ========================================= */
    sendCodeBtn.addEventListener('click', function() {
        const memberId = memberIdInput.value.trim();
        const email = emailInput.value.trim();
        const name = nameInput.value.trim();

        // 필수 정보 입력 확인
        if(!memberId || !email || !name) {
            alert('아이디, 이름, 이메일을 모두 입력해주세요.');
            return;
        }

        // [UX] 버튼 로딩 상태 전환 (중복 클릭 방지)
        const originalBtnText = sendCodeBtn.innerHTML;
        sendCodeBtn.disabled = true;
        sendCodeBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 발송 중...';

        // AJAX 요청
        fetch('/members/send-verification-code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': csrfToken // Spring Security CSRF 토큰 필수
            },
            // [참고] 현재 백엔드 로직에 맞춰 memberId와 email 전송 (필요 시 name 추가 가능)
            body: JSON.stringify({ memberId: memberId, email: email })
        })
        .then(async res => {
            const isJson = res.headers.get('content-type')?.includes('application/json');
            const data = isJson ? await res.json() : null;

            if (!res.ok) {
                // 에러 발생 시 서버 메시지 또는 기본 메시지 출력
                throw new Error((data && data.message) || "서버 통신 오류가 발생했습니다.");
            }
            return data;
        })
        .then(data => {
            // 성공 시 로직
            alert(data.message); // "인증번호가 발송되었습니다."
            verifySection.style.display = 'block'; // 인증번호 입력창 표시
            authCodeInput.focus();
        })
        .catch(err => {
            console.error(err);
            alert(err.message); // 사용자에게 에러 알림
        })
        .finally(() => {
            // 통신 종료 후 버튼 복구
            sendCodeBtn.disabled = false;
            sendCodeBtn.innerHTML = originalBtnText;
        });
    });

    /* =========================================
       2. 인증번호 검증 요청
       - MemberController.verifyCode() 호출
       ========================================= */
    verifyBtn.addEventListener('click', function() {
        const code = authCodeInput.value.trim();

        if(!code) {
            alert("인증번호를 입력해주세요.");
            return;
        }

        fetch('/members/verify-code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': csrfToken
            },
            body: JSON.stringify({ code: code })
        })
        .then(async res => {
            const isJson = res.headers.get('content-type')?.includes('application/json');
            const data = isJson ? await res.json() : null;

            if (!res.ok) {
                throw new Error((data && data.message) || '인증에 실패했습니다.');
            }
            return data;
        })
        .then(data => {
            // 인증 성공 처리
            verifySuccessMsg.style.display = 'inline-block';
            verifyErrorMsg.style.display = 'none';

            // [UX] 인증된 정보 수정 방지 (readOnly 처리)
            // readOnly 필드는 폼 전송 시 데이터가 서버로 전달됩니다. (disabled는 전달 안됨)
            memberIdInput.readOnly = true;
            emailInput.readOnly = true;
            nameInput.readOnly = true;
            authCodeInput.readOnly = true;

            // 인증 버튼들 비활성화
            verifyBtn.disabled = true;
            sendCodeBtn.disabled = true;

            // 비밀번호 변경 섹션 활성화 (disabled 제거)
            newPwInput.disabled = false;
            confirmPwInput.disabled = false;
            submitBtn.disabled = false;

            newPwInput.focus(); // 편의성을 위해 포커스 이동
        })
        .catch(err => {
            // 인증 실패 처리
            verifyErrorMsg.innerText = err.message || '인증번호 불일치';
            verifyErrorMsg.style.display = 'inline-block';
            verifySuccessMsg.style.display = 'none';
        });
    });

    /* =========================================
       3. 폼 제출 및 비밀번호 변경 요청 (AJAX + Modal)
       ========================================= */
    const resetForm = document.getElementById('resetForm');

    resetForm.addEventListener('submit', function(event) {
        // 1. 기본 폼 제출 동작(페이지 이동) 중단
        event.preventDefault();

        let valid = true;

        // (1) 비밀번호 정규식 검사
        const password = newPwInput.value;
        const passwordPattern = /^(?=.*[a-zA-Z])(?=.*\d)[a-zA-Z\d]{5,20}$/;
        const passwordError = document.getElementById('passwordError');

        if (!passwordPattern.test(password)) {
            passwordError.style.display = 'flex';
            if(valid) newPwInput.focus();
            valid = false;
        } else {
            passwordError.style.display = 'none';
        }

        // (2) 비밀번호 재확인 일치 검사
        const confirm = confirmPwInput.value;
        const confirmError = document.getElementById('passwordConfirmError');

        if (password !== confirm) {
            confirmError.style.display = 'flex';
            if(valid) confirmPwInput.focus();
            valid = false;
        } else {
            confirmError.style.display = 'none';
        }

        // 유효성 검사 실패 시 중단
        if (!valid) return;

        // --------------------------------------------------------
        // [수정됨] 유효성 통과 시 AJAX로 데이터 전송 및 모달 호출
        // --------------------------------------------------------

        // 버튼 로딩 상태로 변경
        const originalBtnHTML = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 변경 중...';

        // 폼 데이터 수집
        // 주의: 백엔드가 @RequestParam을 받는지 @RequestBody(JSON)를 받는지에 따라 다름
        // 여기서는 th:action이 있는 폼이므로 FormData를 사용하여 전송 (기존 Controller 호환성 유지)
        const formData = new FormData(resetForm);

        fetch(resetForm.action, {
            method: 'POST',
            // FormData 사용 시 Content-Type 헤더는 자동 설정되므로 생략하거나,
            // CSRF 토큰만 추가하면 됩니다.
            headers: {
                'X-CSRF-TOKEN': csrfToken
            },
            body: formData
        })
        .then(res => {
            if (res.ok) {
                // 성공 시 (HTTP 200)
                // 1초 딜레이 후 모달 띄우기 (UX 효과)
                setTimeout(() => {
                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    successModal.show();
                }, 500);
            } else {
                // 실패 시
                return res.text().then(text => { throw new Error(text || '비밀번호 변경 실패'); });
            }
        })
        .catch(err => {
            console.error(err);
            alert('비밀번호 변경 중 오류가 발생했습니다.\n다시 시도해 주세요.');
            // 버튼 원상복구
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnHTML;
        });
    });
</script>

</body>
</html>