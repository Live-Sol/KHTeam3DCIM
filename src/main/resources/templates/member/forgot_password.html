<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>StarRoot - Password Recovery</title>
    <!-- 공통 라이브러리 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">

    <!-- 스타일 시트 -->
    <link href="/css/index.css" rel="stylesheet">
    <link href="/css/memberStyle.css" rel="stylesheet">
</head>
<body class="login-body">

<!-- 네비게이션 헤더 -->
<div th:replace="~{fragments/header :: header}"></div>

<!-- 메인 섹션 -->
<div class="login-wrapper">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6 col-xl-5">

                <!-- Glassmorphism Card -->
                <div class="card login-card">
                    <div class="card-body p-5">

                        <!-- Title -->
                        <div class="text-center mb-5">
                            <h2 class="login-title">STAR-ROOT<br>ACCOUNT RECOVERY</h2>
                            <p class="text-white-50 small">비밀번호 재설정을 위해 이메일 인증을 진행합니다.</p>
                        </div>

                        <!-- Error Message (Server Side) -->
                        <div th:if="${error}" class="alert alert-custom mb-4" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <span th:text="${error}">정보가 일치하지 않습니다.</span>
                        </div>

                        <form th:action="@{/members/forgot-password}" method="post" id="resetForm">
                            <!-- CSRF Token -->
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <input type="hidden" id="csrfToken" th:value="${_csrf.token}">

                            <!-- 섹션 1: 계정 인증 -->
                            <h6 class="text-white-50 border-bottom border-secondary border-opacity-25 pb-2 mb-4">
                                <i class="bi bi-person-check me-2"></i>계정 인증
                            </h6>

                            <!-- 아이디 입력 -->
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control form-control-custom" id="memberId" name="memberId" placeholder="User ID" required>
                                <label for="memberId">아이디</label>
                            </div>

                            <!-- 이름 입력 -->
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control form-control-custom" id="name" name="name" placeholder="Name" required>
                                <label for="name">담당자 성함</label>
                            </div>

                            <!-- 이메일 입력 + 인증번호 발송 버튼 -->
                            <div class="input-group mb-3">
                                <div class="form-floating flex-grow-1">
                                    <input type="email" class="form-control form-control-custom rounded-end-0" id="email" name="email" placeholder="Email" required>
                                    <label for="email">담당자 이메일</label>
                                </div>
                                <button type="button" class="btn btn-check-custom px-3" id="sendCodeBtn">
                                    <i class="bi bi-send me-1"></i> 인증번호 발송
                                </button>
                            </div>

                            <!-- 인증번호 입력 섹션 (초기 숨김) -->
                            <div id="verifySection" style="display:none;" class="mb-4">
                                <div class="input-group">
                                    <div class="form-floating flex-grow-1">
                                        <input type="text" class="form-control form-control-custom rounded-end-0" id="authCode" placeholder="Code">
                                        <label for="authCode">인증번호 6자리</label>
                                    </div>
                                    <button type="button" class="btn btn-primary px-4" id="verifyBtn">
                                        확인
                                    </button>
                                </div>
                                <!-- 인증 결과 메시지 -->
                                <div class="mt-2">
                                    <small class="text-success-custom fw-bold" id="verifySuccessMsg" style="display:none;">
                                        <i class="bi bi-check-circle-fill me-1"></i> 인증되었습니다. 비밀번호를 변경하세요.
                                    </small>
                                    <small class="text-danger fw-bold" id="verifyErrorMsg" style="display:none;">
                                        <i class="bi bi-x-circle-fill me-1"></i> 인증번호가 일치하지 않습니다.
                                    </small>
                                </div>
                            </div>

                            <!-- 섹션 2: 새 비밀번호 설정 -->
                            <h6 class="text-white-50 border-bottom border-secondary border-opacity-25 pb-2 mb-4 mt-2">
                                <i class="bi bi-key me-2"></i>새 비밀번호 설정
                            </h6>

                            <div class="form-floating mb-3">
                                <input type="password" class="form-control form-control-custom" id="newPassword" name="newPassword" placeholder="New Password" required disabled>
                                <label for="newPassword">새로운 비밀번호</label>
                                <div id="passwordError" class="validation-msg text-error" style="display:none;">
                                    <i class="bi bi-info-circle"></i> 영문+숫자 포함 5~20자
                                </div>
                            </div>

                            <div class="form-floating mb-4">
                                <input type="password" class="form-control form-control-custom" id="confirmPassword" placeholder="Confirm Password" required disabled>
                                <label for="confirmPassword">비밀번호 재확인</label>
                                <div id="passwordConfirmError" class="validation-msg text-error" style="display:none;">
                                    <i class="bi bi-exclamation-triangle"></i> 비밀번호가 일치하지 않습니다.
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="d-grid gap-2 mt-5">
                                <button type="submit" class="btn btn-login btn-lg" id="submitBtn" disabled>
                                    비밀번호 변경하기 <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>

                            <div class="text-center mt-4">
                                <a th:href="@{/members/login}" class="link-cyan small">
                                    <i class="bi bi-arrow-left"></i> 로그인 페이지로 돌아가기
                                </a>
                            </div>

                        </form>
                    </div>

                    <!-- Decorative Element -->
                    <div class="card-footer-glow"></div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- 푸터 -->
<div th:replace="~{fragments/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- 기능 스크립트 -->
<script>
    const csrfToken = document.getElementById('csrfToken').value;
    const sendCodeBtn = document.getElementById('sendCodeBtn');
    const verifySection = document.getElementById('verifySection');
    const verifyBtn = document.getElementById('verifyBtn');

    // 입력 필드들
    const memberIdInput = document.getElementById('memberId');
    const emailInput = document.getElementById('email');
    const authCodeInput = document.getElementById('authCode');
    const newPwInput = document.getElementById('newPassword');
    const confirmPwInput = document.getElementById('confirmPassword');
    const submitBtn = document.getElementById('submitBtn');

    // 메시지 요소들
    const verifySuccessMsg = document.getElementById('verifySuccessMsg');
    const verifyErrorMsg = document.getElementById('verifyErrorMsg');

    /* 1. 인증번호 발송 */
    sendCodeBtn.addEventListener('click', function() {
        const memberId = memberIdInput.value.trim();
        const email = emailInput.value.trim();

        if(!memberId || !email) {
            alert('아이디와 이메일을 모두 입력해주세요.');
            return;
        }

        // 버튼 로딩 상태로 변경
        const originalBtnText = sendCodeBtn.innerHTML;
        sendCodeBtn.disabled = true;
        sendCodeBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 발송 중...';

        fetch('/members/send-verification-code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': csrfToken
            },
            body: JSON.stringify({ memberId: memberId, email: email })
        })
        .then(async res => {
            // ⭐️ 응답이 JSON인지 확인 (HTML 에러 페이지 처리용)
            const isJson = res.headers.get('content-type')?.includes('application/json');
            const data = isJson ? await res.json() : null;

            if (!res.ok) {
                const errorMsg = (data && data.message)
                                 ? data.message
                                 : `오류 발생: ${res.status} ${res.statusText} (새로고침 후 다시 시도해주세요)`;
                throw new Error(errorMsg);
            }

            // ⭐️ [Fix] 200 OK지만 JSON이 없는 경우 (로그인 페이지 리다이렉트 등) 방어 코드
            if (!data) {
                throw new Error("서버 응답 형식이 올바르지 않습니다. (로그인 페이지로 리다이렉트 되었을 가능성이 있습니다. Security 설정을 확인하세요.)");
            }

            return data;
        })
        .then(data => {
            alert(data.message);
            verifySection.style.display = 'block'; // 인증번호 입력창 보이기
            authCodeInput.focus();
        })
        .catch(err => {
            console.error(err);
            alert(err.message); // 상세 에러 메시지 출력
        })
        .finally(() => {
            sendCodeBtn.disabled = false;
            sendCodeBtn.innerHTML = originalBtnText;
        });
    });

    /* 2. 인증번호 확인 */
    verifyBtn.addEventListener('click', function() {
        const code = authCodeInput.value.trim();
        if(!code) {
            alert("인증번호를 입력해주세요.");
            return;
        }

        fetch('/members/verify-code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': csrfToken
            },
            body: JSON.stringify({ code: code })
        })
        .then(async res => {
            const isJson = res.headers.get('content-type')?.includes('application/json');
            const data = isJson ? await res.json() : null;

            if (!res.ok) {
                throw new Error((data && data.message) || '인증 실패');
            }

            // ⭐️ [Fix] 데이터 null 체크
            if (!data) {
                 throw new Error("서버 응답 형식이 올바르지 않습니다.");
            }

            return data;
        })
        .then(data => {
            verifySuccessMsg.style.display = 'inline-block';
            verifyErrorMsg.style.display = 'none';

            memberIdInput.readOnly = true;
            emailInput.readOnly = true;
            document.getElementById('name').readOnly = true;
            authCodeInput.readOnly = true;
            verifyBtn.disabled = true;
            sendCodeBtn.disabled = true;

            newPwInput.disabled = false;
            confirmPwInput.disabled = false;
            submitBtn.disabled = false;

            newPwInput.focus();
        })
        .catch(err => {
            verifyErrorMsg.innerText = err.message || '인증번호 불일치';
            verifyErrorMsg.style.display = 'inline-block';
            verifySuccessMsg.style.display = 'none';
        });
    });

    /* 3. 비밀번호 유효성 검사 (폼 제출 시) */
    document.getElementById('resetForm').addEventListener('submit', function(event) {
        let valid = true;
        const password = newPwInput.value;
        const passwordPattern = /^(?=.*[a-zA-Z])(?=.*\d)[a-zA-Z\d]{5,20}$/;
        const passwordError = document.getElementById('passwordError');

        if (!passwordPattern.test(password)) {
            passwordError.style.display = 'flex';
            if(valid) newPwInput.focus();
            valid = false;
        } else {
            passwordError.style.display = 'none';
        }

        const confirm = confirmPwInput.value;
        const confirmError = document.getElementById('passwordConfirmError');

        if (password !== confirm) {
            confirmError.style.display = 'flex';
            if(valid) confirmPwInput.focus();
            valid = false;
        } else {
            confirmError.style.display = 'none';
        }

        if (!valid) {
            event.preventDefault();
        }
    });
</script>
</body>
</html>