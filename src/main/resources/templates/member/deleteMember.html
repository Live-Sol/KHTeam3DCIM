<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원정보 삭제</title>
    <!-- 회원 관련 CSS 연결 -->
    <link rel="stylesheet" th:href="@{/css/memberStyle.css}">
</head>
<body>

<h2>회원 정보 삭제</h2>

<div>
    <!-- 출력용 아이디 (수정 불가) -->
    <label>아이디</label>
    <input type="text" id="memberIdDisplay" th:value="${member.memberId}" disabled>

    <!-- 서버로 보낼 아이디 (hidden) -->
    <input type="hidden" id="memberId" th:value="${member.memberId}">
</div>

<div>
    <!-- 비밀번호 입력 -->
    <label>비밀번호 확인</label>
    <input type="password" id="password" placeholder="비밀번호를 입력하세요">
    <!-- 비밀번호 미입력 시 오류 메시지 -->
    <p id="passwordError" style="display:none;color:red;"></p>
</div>
<!-- 회원 탈퇴 버튼 -->
<button type="button" onclick="deleteMember()">회원탈퇴</button>
<!-- 결과 메시지 출력 -->
<p id="result" style="color:red;"></p>

<script>
    /**
     * 회원 탈퇴 함수
     * 1. 입력된 비밀번호 확인
     * 2. 서버로 DELETE 요청 전송
     * 3. 성공 시 성공 메시지 출력 후 2초 뒤 메인페이지 이동
     * 4. 실패 시 오류 메시지 출력
     */
    function deleteMember() {
        const memberId = document.getElementById("memberId").value; // hidden input에서 서버로 보낼 아이디 가져오기
        const password = document.getElementById("password").value; // 입력된 비밀번호 가져오기
        const passwordError = document.getElementById("passwordError"); // 비밀번호 오류 메시지 요소
        const result = document.getElementById("result"); // 결과 메시지 요소
        // 1. 비밀번호 입력 유효성 검사
        if (!password) {
            passwordError.innerText = "비밀번호를 입력해주세요."; // 오류 메시지 출력
            passwordError.style.display = 'block'; // 메시지 표시
            return; // 함수 종료
        } else {
            passwordError.style.display = 'none'; // 오류 메시지 숨김
        }
        // 2. 회원 삭제 요청 (AJAX)
        fetch(`/members/${memberId}`, {
            method: 'DELETE', // HTTP DELETE 메서드 사용
            headers: { 'Content-Type': 'application/json' }, // JSON 형식 전송
            body: JSON.stringify({ password: password }) // 서버로 비밀번호 전달
        })
            .then(res => {
                // 성공: 상태 코드 OK(200)인 경우
                if (res.ok) return res.json().catch(() => ({})); // body가 없으면 빈 객체 반환
                // 실패: 서버에서 반환한 메시지 에러 처리
                return res.json().then(json => { throw new Error(json.message); });
            })
            .then(() => {
                // 3. 삭제 성공 처리
                result.style.color = 'green';
                result.innerText = "회원 탈퇴 성공! 2초 후 메인페이지로 이동합니다.";
                // 2초 뒤 메인페이지로 이동
                setTimeout(() => { window.location.href = "/"; }, 2000);
            })
            .catch(err => {
                // 4. 삭제 실패 처리
                result.style.color = 'red';
                result.innerText = "회원 탈퇴 실패: " + err.message;
            });
    }
</script>

</body>
</html>
