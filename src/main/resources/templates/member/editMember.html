<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원정보 수정</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/memberStyle.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>

<div class="container mt-5">
    <h2 class="text-primary"><i class="bi bi-person-gear me-2"></i> 회원 정보 수정</h2>
    <hr>

    <div class="mb-3">
        <label for="memberIdDisplay" class="form-label">아이디</label>
        <input type="text" id="memberIdDisplay" class="form-control" th:value="${member.memberId}" disabled>
        <input type="hidden" id="memberId" th:value="${member.memberId}">
    </div>

    <div class="mb-3">
        <label for="password" class="form-label">새 비밀번호 (변경 시 입력)</label>
        <input type="password" id="password" class="form-control">
        <small class="form-text text-muted">비밀번호를 변경하지 않으려면 비워두세요.</small>
        <p id="passwordError" class="text-danger" style="display:none;">비밀번호는 4~20글자여야 합니다.</p>
    </div>

    <div class="mb-3">
        <label for="name" class="form-label">새 기업명 (이름)</label>
        <input type="text" id="name" class="form-control" th:value="${member.name}">
        <p id="nameError" class="text-danger" style="display:none;">이름은 한글 또는 알파벳 2~10글자여야 합니다.</p>
    </div>

    <div class="mb-3">
        <label for="email" class="form-label">이메일</label>
        <input type="email" id="email" class="form-control" th:value="${member.email}" required>
        <p id="emailError" class="text-danger" style="display:none;">유효한 이메일 형식이어야 합니다.</p>
    </div>

    <div class="mb-3">
        <label for="contact" class="form-label">연락처</label>
        <input type="text" id="contact" class="form-control" th:value="${member.contact}" required>
        <small class="form-text text-muted">형식: 000-0000-0000</small>
        <p id="contactError" class="text-danger" style="display:none;">연락처는 00-000-0000 또는 000-0000-0000 형식이어야 합니다.</p>
    </div>

    <button onclick="updateMember()" class="btn btn-primary mt-3">
        <i class="bi bi-check-circle me-1"></i> 정보 수정 적용
    </button>
    <a href="/" class="btn btn-secondary mt-3">취소</a>

    <p id="result" class="mt-3"></p>
</div>

<script>
    function updateMember() {
        const memberId = document.getElementById("memberId").value;
        const password = document.getElementById("password").value;
        const name = document.getElementById("name").value;
        const email = document.getElementById("email").value; // ⭐️ 추가
        const contact = document.getElementById("contact").value; // ⭐️ 추가

        let valid = true;

        // --- 1. 유효성 검사 시작 ---

        // 비밀번호 검사 (선택 사항이므로 입력된 경우에만 검사)
        const passwordError = document.getElementById('passwordError');
        if (password.length > 0) {
            const passwordPattern = /^.{4,20}$/;
            if (!passwordPattern.test(password)) {
                passwordError.style.display = 'block';
                document.getElementById('password').focus();
                valid = false;
            } else {
                passwordError.style.display = 'none';
            }
        } else {
            passwordError.style.display = 'none';
        }


        // 이름 검사
        const namePattern = /^[a-zA-Z가-힣]{2,10}$/;
        const nameError = document.getElementById('nameError');
        if (!namePattern.test(name)) {
            nameError.style.display = 'block';
            if (valid) document.getElementById('name').focus(); // 첫 번째 에러에 포커스
            valid = false;
        } else {
            nameError.style.display = 'none';
        }

        // ⭐️ 이메일 검사 ⭐️
        const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        const emailError = document.getElementById('emailError');
        if (!emailPattern.test(email)) {
            emailError.style.display = 'block';
            if (valid) document.getElementById('email').focus();
            valid = false;
        } else {
            emailError.style.display = 'none';
        }

        // ⭐️ 연락처 검사 ⭐️
        const contactPattern = /^\d{2,3}-\d{3,4}-\d{4}$/; // 예: 010-1234-5678 또는 02-123-4567
        const contactError = document.getElementById('contactError');
        if (!contactPattern.test(contact)) {
            contactError.style.display = 'block';
            if (valid) document.getElementById('contact').focus();
            valid = false;
        } else {
            contactError.style.display = 'none';
        }


        if (!valid) {
            document.getElementById("result").innerText = "입력 값을 다시 확인해 주세요.";
            document.getElementById("result").style.color = 'red';
            return;
        }

        // --- 2. 서버 전송 데이터 준비 ---

        // DTO 형식에 맞춰 변경된 값만 전송하도록 구성 (PATCH 요청의 장점 활용)
        const data = {};

        // 비밀번호는 입력된 경우에만 전송
        if (password.length > 0) {
            data.password = password;
        }

        // 이름, 이메일, 연락처는 필수 값이므로 항상 전송
        data.name = name;
        // ⭐️ 추가된 필드 ⭐️
        data.email = email;
        data.contact = contact;


        // --- 3. Fetch API 요청 ---
        fetch(`/members/${memberId}`, {
            // CSRF 토큰 처리가 필요하다면 이 부분에 헤더를 추가해야 합니다.
            // 현재는 Spring Security 설정을 REST API 방식으로 했다고 가정합니다.
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(res => {
                if (res.ok) {
                    // 성공적으로 수정되었지만, 서버에서 반환되는 DTO 형식이 MemberResponse여서
                    // 비밀번호가 null이 아닌 이상 200 OK와 함께 응답 본문을 반환할 것입니다.
                    return res.json();
                }
                // 400 Bad Request 등의 오류 발생 시
                throw new Error("서버 수정 처리 실패");
            })
            .then(json => {
                document.getElementById("result").style.color = 'green';
                document.getElementById("result").innerText = "정보 수정 성공! (" + json.name + ")";
                setTimeout(() => { window.location.href = "/"; }, 2000);
            })
            .catch(err => {
                document.getElementById("result").style.color = 'red';
                console.error(err);
                document.getElementById("result").innerText = "회원 정보 수정에 실패했습니다. (서버 오류)";
            });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>