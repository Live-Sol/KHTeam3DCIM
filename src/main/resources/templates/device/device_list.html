<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>ì¥ë¹„ ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" th:href="@{/css/sidebar.css}">
    <link rel="stylesheet" th:href="@{/css/requests.css}">
    <link rel="stylesheet" th:href="@{/css/devices.css}"> </head>
<body>

<div th:replace="~{fragments/header :: header}"></div>

<div class="d-flex">
    <div th:replace="fragments/sidebar :: sidebar"></div>

    <main class="main-content flex-grow-1">

        <h2 class="mb-4 text-white border-bottom pb-2">
            <i class="bi bi-hdd-stack me-2"></i> ì´ ì¥ë¹„ ë¦¬ìŠ¤íŠ¸
        </h2>

        <div class="d-flex justify-content-between mb-4 align-items-center">

            <form action="/devices" method="get" class="d-flex gap-2" style="flex-grow: 1; max-width: 800px;">

                <select name="sort" class="form-select custom-select" style="width: 160px;" onchange="this.form.submit()">
<!--                    <option value="latest" th:selected="${sort == 'latest'}">ID</option>-->
                    <option value="member" th:selected="${sort == 'member'}">ì‹ ì²­ì ì•„ì´ë””</option>
                    <option value="rack" th:selected="${sort == 'rack'}">ìœ„ì¹˜(Rack)</option>
                    <option value="category" th:selected="${sort == 'category'}">ì¥ë¹„ ì¢…ë¥˜</option>
                    <option value="serial" th:selected="${sort == 'serial'}">ì œì¡°ì‚¬/ëª¨ë¸</option>
                    <option value="power" th:selected="${sort == 'power'}">ì†Œë¹„ì „ë ¥</option>
                    <option value="ems" th:selected="${sort == 'ems'}">EMS</option>
                    <option value="location" th:selected="${sort == 'location'}">ì„¤ì¹˜ ìœ„ì¹˜</option>
                    <option value="contract" th:selected="${sort == 'contract'}">ì…ê³ ì¼(ê³„ì•½ì¼) ê¸°ì¤€</option>
                    <option value="expiry" th:selected="${sort == 'expiry'}">ë§Œë£Œì¼ ì„ë°• ìˆœ</option>
                    <option value="status" th:selected="${sort == 'status'}">ìƒíƒœ</option>
                </select>

                <select name="sortDir" class="form-select custom-select" style="width: 130px;" onchange="this.form.submit()">
                    <option value="desc" th:selected="${sortDir == 'desc'}">ë‚´ë¦¼ì°¨ìˆœ</option>
                    <option value="asc" th:selected="${sortDir == 'asc'}">ì˜¤ë¦„ì°¨ìˆœ</option>
                </select>

                <input type="text" name="keyword" class="form-control custom-form-control"
                       placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." th:value="${keyword}">

                <button type="submit" class="btn custom-btn-primary text-nowrap">ğŸ” ê²€ìƒ‰</button>
            </form>

            <div>
<!--                <a href="/" class="btn custom-btn-secondary me-2">ğŸ  í™ˆ</a>-->
                <a href="/devices/new" class="btn custom-btn-primary">â• ì‹ ê·œ ë“±ë¡</a>
            </div>
        </div>

        <div id="batch-control-bar" class="mb-3 p-3 bg-dark border rounded d-none">
            <div class="d-flex align-items-center gap-3">
                <span class="text-white fw-bold"><i class="bi bi-check2-square me-1"></i> <span id="selected-count">0</span>ê°œ ì„ íƒë¨</span>

                <div class="vr text-secondary"></div>

                <select id="batch-ems" class="form-select form-select-sm" style="width: 120px;">
                    <option value="">EMS ë³€ê²½</option>
                    <option value="ON">ON</option>
                    <option value="OFF">OFF</option>
                </select>

                <select id="batch-status" class="form-select form-select-sm" style="width: 130px;">
                    <option value="">ìƒíƒœ ë³€ê²½</option>
                    <option value="RUNNING">RUNNING</option>
                    <option value="OFF">OFF</option>
                </select>

                <button type="button" onclick="applyBatchAction()" class="btn btn-sm btn-primary">ì ìš©</button>
                <button type="button" onclick="deleteSelected()" class="btn btn-sm btn-danger ms-auto">ì„ íƒ ì‚­ì œ</button>
            </div>
        </div>

        <div class="table-responsive table-container">
            <table class="table table-hover admin-table">
                <thead>
                <tr class="text-center">
                    <th style="width: 3%">
                        <input type="checkbox" id="selectAll" class="form-check-input">
                    </th>
                    <th style="width: 12%">ì‹ ì²­ì</th>
                    <th style="width: 10%">ìœ„ì¹˜(Rack)</th>
                    <th style="width: 10%">ì¥ë¹„ ì¢…ë¥˜</th>
                    <th style="width: 15%">ì œì¡°ì‚¬/ëª¨ë¸</th>
                    <th style="width: 7%">ì†Œë¹„ì „ë ¥</th>
                    <th style="width: 7%">EMS</th>
                    <th style="width: 8%">ì„¤ì¹˜ìœ„ì¹˜</th>
                    <th style="width: 10%" class="text-start">ê³„ì•½ (ë§Œë£Œì¼)</th>
                    <th style="width: 8%">ìƒíƒœ</th>
                    <th style="width: 10%">ê´€ë¦¬</th>
                </tr>
                </thead>
                <tbody class="text-center">
                <tr th:each="device : ${devices}">
                    <td>
                        <input type="checkbox" name="deviceIds" th:value="${device.id}" class="form-check-input device-checkbox">
                    </td>
                    <td>
                        <span th:if="${device.member != null}">
                            <a th:href="@{/admin/members/{mId}(mId=${device.member.memberId})}"
                               class="text-info text-decoration-none"
                               data-bs-toggle="tooltip"
                               data-bs-placement="top"
                               th:title="'ì‹œìŠ¤í…œ ì¥ë¹„ ID: ' + ${device.id}">
                                <i class="bi bi-person-fill small"></i>
                                [[${device.member.memberId}]]
                            </a>
                        </span>
                        <span th:unless="${device.member != null}" class="text-sub-muted">-</span>
                    </td>

                    <td class="text-white fw-bold" th:text="${device.rack != null ? device.rack.rackName : 'ë¯¸ë°°ì •'}">A-01</td>

                    <td th:text="${device.category != null ? device.category.name : '-'}">ì„œë²„</td>

                    <td class="text-center">
                        <div class="fw-bold text-white" th:text="${device.vendor}">Dell</div>
                        <div class="text-sub-muted" th:text="${device.modelName}">R740</div>
                    </td>

                    <td class="text-white">
                        <span th:text="${device.powerWatt != null ? device.powerWatt : 0}">500</span>W
                    </td>

                    <td>
                        <span th:if="${device.emsStatus == 'ON'}" class="badge bg-primary px-2">ON</span>
                        <span th:unless="${device.emsStatus == 'ON'}" class="badge bg-secondary px-2">OFF</span>
                    </td>

                    <td class="text-white">
                        <span th:text="${device.startUnit ?: '-'}"></span>
                        -
                        <span th:text="${(device.startUnit ?: 0) + (device.heightUnit ?: 0) - 1}"></span>
                    </td>

                    <td class="text-start">
                        <div th:if="${device.contractDate != null and device.contractMonth != null}">
                            <span class="text-white small" th:text="${device.contractDate}">2025-01-01</span><br/>

                            <small class="fw-bold"
                                   th:with="expireDate=${device.contractDate.plusMonths(device.contractMonth)}"
                                   th:classappend="${expireDate.isBefore(#temporals.createToday())} ? 'text-danger' : 'text-success'">
                                ~ [[${expireDate}]]
                            </small>
                        </div>

                        <div th:unless="${device.contractDate != null and device.contractMonth != null}" class="text-sub-muted">
                            -
                        </div>
                    </td>

                    <td>
                    <span th:if="${device.status != null}">
                        <span class="badge bg-success" th:if="${device.status == 'RUNNING'}">RUNNING</span>
                        <span class="badge bg-danger" th:if="${device.status == 'ERROR'}">ERROR</span>
                        <span class="badge bg-secondary" th:if="${device.status == 'OFF'}">OFF</span>
                        <span class="badge bg-info" th:unless="${device.status == 'RUNNING' or device.status == 'ERROR' or device.status == 'OFF'}">[[${device.status}]]</span>
                    </span>
                        <span th:unless="${device.status != null}" class="badge bg-warning text-dark">UNKNOWN</span>
                    </td>

                    <td>
                        <div class="d-flex justify-content-center gap-1">
                            <a th:href="@{/devices/{id}/edit(id=${device.id})}" class="btn btn-sm btn-outline-warning">ìˆ˜ì •</a>
                            <a th:href="@{/devices/{id}/delete(id=${device.id})}"
                               class="btn btn-sm btn-outline-danger"
                               onclick="return confirm('ì •ë§ ì´ ì¥ë¹„ë¥¼ íê¸°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</a>
                        </div>
                    </td>
                </tr>
                <tr th:if="${devices.isEmpty()}">
                    <td colspan="10" class="text-center py-5 text-sub-muted">ë“±ë¡ëœ ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </main>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.device-checkbox');
        const batchBar = document.getElementById('batch-control-bar');
        const selectedCountSpan = document.getElementById('selected-count');

        // 1. ì „ì²´ ì„ íƒ/í•´ì œ ë¡œì§
        selectAll.addEventListener('change', function() {
            checkboxes.forEach(cb => cb.checked = this.checked);
            toggleBatchBar();
        });

        // 2. ê°œë³„ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ ìƒë‹¨ ë°” ë…¸ì¶œ ì œì–´
        checkboxes.forEach(cb => {
            cb.addEventListener('change', toggleBatchBar);
        });

        function toggleBatchBar() {
            const checkedCount = document.querySelectorAll('.device-checkbox:checked').length;
            selectedCountSpan.innerText = checkedCount;

            if (checkedCount > 0) {
                batchBar.classList.remove('d-none');
            } else {
                batchBar.classList.add('d-none');
                selectAll.checked = false;
            }
        }

        // 3. ì¼ê´„ ìˆ˜ì • ì ìš© (EMS, ìƒíƒœ)
        window.applyBatchAction = function() {
            const selectedIds = Array.from(document.querySelectorAll('.device-checkbox:checked')).map(cb => cb.value);
            const emsValue = document.getElementById('batch-ems').value;
            const statusValue = document.getElementById('batch-status').value;

            if (!emsValue && !statusValue) {
                Swal.fire('ì•Œë¦¼', 'ë³€ê²½í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'info');
                return;
            }

            Swal.fire({
                title: 'ì¼ê´„ ìˆ˜ì •ì„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                text: `${selectedIds.length}ê°œì˜ ì¥ë¹„ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ìˆ˜ì •',
                cancelButtonText: 'ì·¨ì†Œ'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Fetch APIë¥¼ ì´ìš©í•œ ë¹„ë™ê¸° ì „ì†¡ ì˜ˆì‹œ
                    sendBatchRequest('/devices/batch-update', {
                        ids: selectedIds,
                        emsStatus: emsValue,
                        status: statusValue
                    });
                }
            });
        };

        // 4. ì¼ê´„ ì‚­ì œ ì ìš©
        window.deleteSelected = function() {
            const selectedIds = Array.from(document.querySelectorAll('.device-checkbox:checked')).map(cb => cb.value);

            Swal.fire({
                title: 'ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                text: "ì„ íƒí•œ ì¥ë¹„ë“¤ì´ ëª¨ë‘ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤!",
                icon: 'danger',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'ì‚­ì œ'
            }).then((result) => {
                if (result.isConfirmed) {
                    sendBatchRequest('/devices/batch-delete', { ids: selectedIds });
                }
            });
        };

        // ê³µí†µ ì„œë²„ ì „ì†¡ í•¨ìˆ˜
        function sendBatchRequest(url, data) {
            // ë©”íƒ€ íƒœê·¸ì—ì„œ í† í° ì •ë³´ ì½ê¸°
            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [header]: token  // CSRF í† í° í—¤ë” ì¶”ê°€
                },
                body: JSON.stringify(data)
            }).then(response => {
                if (response.ok) {
                    // ì„±ê³µ ì‹œ SweetAlertë¡œ ì•Œë¦¼ í›„ í˜ì´ì§€ ì´ë™/ìƒˆë¡œê³ ì¹¨
                    Swal.fire('ì„±ê³µ', 'ìš”ì²­ì´ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success').then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire('ì—ëŸ¬', 'ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ê¶Œí•œ ë¶€ì¡± ë“±)', 'error');
                }
            }).catch(error => {
                console.error('Error:', error);
                Swal.fire('ì—ëŸ¬', 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            });
        }

        // --- íˆ´íŒ í™œì„±í™” ì½”ë“œ ì¶”ê°€ ---
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })

        // ì»¨íŠ¸ë¡¤ëŸ¬ì˜ RedirectAttributesì—ì„œ ë³´ë‚¸ ë©”ì‹œì§€ ì½ê¸°
        const successMessage = [[${successMessage}]];
        const errorMessage = [[${errorMessage}]];

        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
        });

        // ì„±ê³µ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ í† ìŠ¤íŠ¸ ë„ìš°ê¸°
        if (successMessage) {
            Toast.fire({
                icon: 'success',
                title: successMessage
            });
        }

        // ì—ëŸ¬ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ í† ìŠ¤íŠ¸ ë„ìš°ê¸° (ì‚­ì œ ì‹¤íŒ¨ ë“± ëŒ€ë¹„)
        if (errorMessage) {
            Toast.fire({
                icon: 'error',
                title: errorMessage
            });
        }
    });
</script>
</body>
</html>