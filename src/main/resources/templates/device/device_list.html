<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>장비 관리</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" th:href="@{/css/sidebar.css}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/deviceList.css}">
</head>
<body>

<div th:replace="~{fragments/header :: header}"></div>

<div class="d-flex">
    <div th:replace="fragments/sidebar :: sidebar"></div>

    <main class="main-content flex-grow-1">

        <h2 class="mb-4 text-white border-bottom pb-2">
            <i class="bi bi-hdd-stack me-2 text-primary"></i>장비 관리
            <span class="text-white-50 fs-6 ms-2 fw-normal">(Device Management)</span>
        </h2>

        <div class="d-flex justify-content-between mb-4 align-items-center">

            <form action="/devices" method="get" class="d-flex gap-2" style="flex-grow: 1; max-width: 900px;">

                <select name="sort" class="form-select custom-select" style="width: 160px;" onchange="this.form.submit()">
                    <option value="member" th:selected="${sort == 'member'}">신청자 아이디</option>
                    <option value="rack" th:selected="${sort == 'rack'}">위치(Rack)</option>
                    <option value="category" th:selected="${sort == 'category'}">장비 종류</option>
                    <option value="serial" th:selected="${sort == 'serial'}">제조사/모델</option>
                    <option value="power" th:selected="${sort == 'power'}">소비전력</option>
                    <option value="ems" th:selected="${sort == 'ems'}">EMS</option>
                    <option value="location" th:selected="${sort == 'location'}">설치 위치</option>
                    <option value="contract" th:selected="${sort == 'contract'}">입고일(계약일) 기준</option>
                    <option value="expiry" th:selected="${sort == 'expiry'}">만료일 임박 순</option>
                    <option value="status" th:selected="${sort == 'status'}">상태</option>
                </select>

                <select name="sortDir" class="form-select custom-select" style="width: 130px;" onchange="this.form.submit()">
                    <option value="desc" th:selected="${sortDir == 'desc'}">내림차순</option>
                    <option value="asc" th:selected="${sortDir == 'asc'}">오름차순</option>
                </select>

                <input type="text" name="keyword" class="form-control custom-form-control"
                       placeholder="검색어 입력..." th:value="${keyword}">

                <button type="submit" class="btn custom-btn-primary text-nowrap">
                    <i class="bi bi-search"></i> 검색
                </button>

                <a href="/devices" class="btn custom-btn-secondary text-nowrap">
                    <i class="bi bi-arrow-clockwise"></i> 초기화
                </a>
            </form>

            <div class="ms-2">
                <a href="/devices/new" class="btn custom-btn-primary text-nowrap shadow-sm">
                    <i class="bi bi-plus-lg"></i> 신규 장비 등록
                </a>
            </div>
        </div>

        <div id="batch-control-bar" class="mb-3 p-3 bg-dark border rounded d-none">
            <div class="d-flex align-items-center gap-3">
                <span class="text-white fw-bold"><i class="bi bi-check2-square me-1"></i> <span id="selected-count">0</span>개 선택됨</span>

                <div class="vr text-secondary"></div>

                <select id="batch-ems" class="form-select form-select-sm" style="width: 120px;">
                    <option value="">EMS 변경</option>
                    <option value="ON">ON</option>
                    <option value="OFF">OFF</option>
                </select>

                <select id="batch-status" class="form-select form-select-sm" style="width: 130px;">
                    <option value="">상태 변경</option>
                    <option value="RUNNING">RUNNING</option>
                    <option value="OFF">OFF</option>
                </select>

                <button type="button" onclick="applyBatchAction()" class="btn btn-sm btn-primary">적용</button>
                <button type="button" onclick="deleteSelected()" class="btn btn-sm btn-danger ms-auto">선택 삭제</button>
            </div>
        </div>

        <div class="table-responsive table-container">
            <table class="table table-hover admin-table">
                <thead>
                <tr class="text-center">
                    <th style="width: 3%">
                        <input type="checkbox" id="selectAll" class="form-check-input">
                    </th>
                    <th style="width: 11%">신청자</th>
                    <th style="width: 9%">위치(Rack)</th>
                    <th style="width: 10%">장비 종류</th>
                    <th style="width: 15%">제조사/모델</th>
                    <th style="width: 7%">소비전력</th>
                    <th style="width: 7%">EMS</th>
                    <th style="width: 8%">설치위치</th>
                    <th style="width: 10%" class="text-start">계약 (만료일)</th>
                    <th style="width: 8%">상태</th>
                    <th style="width: 12%">관리</th>
                </tr>
                </thead>
                <tbody class="text-center">
                <tr th:each="device : ${devices}"
                    th:classappend="${device.status == 'DELETED'} ? 'table-secondary opacity-75' : ''">

                    <td>
                        <input type="checkbox" name="deviceIds" th:value="${device.id}" class="form-check-input device-checkbox"
                               th:disabled="${device.status == 'DELETED'}">
                    </td>

                    <td>
            <span th:if="${device.member != null}">
                <a th:href="@{/admin/members/{mId}(mId=${device.member.memberId})}"
                   class="text-info text-decoration-none"
                   data-bs-toggle="tooltip"
                   data-bs-placement="top"
                   th:title="'시스템 장비 ID: ' + ${device.id}">
                    <i class="bi bi-person-fill small"></i>
                    [[${device.member.memberId}]]
                </a>
            </span>
                        <span th:unless="${device.member != null}" class="text-sub-muted">-</span>
                    </td>

                    <td class="text-white fw-bold" th:text="${device.rack != null ? device.rack.rackName : '미배정'}">A-01</td>

                    <td th:text="${device.category != null ? device.category.name : '-'}">서버</td>

                    <td class="text-center">
                        <div class="fw-bold text-white" th:text="${device.vendor}">Dell</div>
                        <div class="text-sub-muted" th:text="${device.modelName}">R740</div>
                    </td>

                    <td class="text-white">
                        <span th:text="${device.powerWatt != null ? device.powerWatt : 0}">500</span>W
                    </td>

                    <td>
                        <span th:if="${device.emsStatus == 'ON'}" class="badge bg-primary px-2">ON</span>
                        <span th:unless="${device.emsStatus == 'ON'}" class="badge bg-secondary px-2">OFF</span>
                    </td>

                    <td class="text-white">
                        <span th:text="${device.startUnit ?: '-'}"></span>
                        -
                        <span th:text="${(device.startUnit ?: 0) + (device.heightUnit ?: 0) - 1}"></span>
                    </td>

                    <td class="text-start">
                        <div th:if="${device.contractDate != null and device.contractMonth != null}">
                            <span class="text-white small" th:text="${device.contractDate}">2025-01-01</span><br/>

                            <small class="fw-bold"
                                   th:with="expireDate=${device.contractDate.plusMonths(device.contractMonth)}"
                                   th:classappend="${expireDate.isBefore(#temporals.createToday())} ? 'text-danger' : 'text-success'">
                                ~ [[${expireDate}]]
                            </small>
                        </div>

                        <div th:unless="${device.contractDate != null and device.contractMonth != null}" class="text-sub-muted">
                            -
                        </div>
                    </td>

                    <td>
            <span th:if="${device.status == 'DELETED'}" class="badge bg-danger text-white border border-secondary">
                <i class="bi bi-trash"></i> 삭제 예정
            </span>

                        <span th:unless="${device.status == 'DELETED'}">
                <span th:if="${device.status != null}">
                    <span class="badge bg-success" th:if="${device.status == 'RUNNING'}">RUNNING</span>
                    <span class="badge bg-danger" th:if="${device.status == 'ERROR'}">ERROR</span>
                    <span class="badge bg-secondary" th:if="${device.status == 'OFF'}">OFF</span>
                    <span class="badge bg-info" th:unless="${device.status == 'RUNNING' or device.status == 'ERROR' or device.status == 'OFF'}">[[${device.status}]]</span>
                </span>
                <span th:unless="${device.status != null}" class="badge bg-warning text-dark">UNKNOWN</span>
            </span>
                    </td>

                    <td>
                        <div th:if="${device.status != 'DELETED'}" class="d-flex justify-content-center gap-1">
                            <a th:href="@{/devices/{id}/edit(id=${device.id})}" class="btn btn-sm btn-outline-warning">수정</a>
                            <button type="button"
                                    class="btn btn-sm btn-outline-danger"
                                    th:onclick="confirmDelete([[${device.id}]], [[${device.serialNum}]])">
                                삭제
                            </button>
                        </div>

<!--                        <div th:if="${device.status == 'DELETED'}"-->
<!--                             class="text-center text-danger fw-bold small d-day-display"-->
<!--                             th:data-deleted-at="${device.deletedAt}">-->
<!--                            <i class="bi bi-calendar-event"></i> <span class="d-day-text">계산 중...</span>-->
<!--                        </div>-->
                        <div th:if="${device.status == 'DELETED'}"
                             class="text-center text-danger fw-bold small countdown-timer"
                             th:data-deleted-at="${device.deletedAt}">
                            <i class="bi bi-stopwatch"></i> <span class="timer-text">계산 중...</span>
                        </div>
                    </td>
                </tr>

                <tr th:if="${devices.isEmpty()}">
                    <td colspan="11" class="text-center py-5 text-sub-muted">등록된 장비가 없습니다.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </main>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.device-checkbox');
        const batchBar = document.getElementById('batch-control-bar');
        const selectedCountSpan = document.getElementById('selected-count');

        // 1. 전체 선택/해제 로직
        selectAll.addEventListener('change', function() {
            checkboxes.forEach(cb => cb.checked = this.checked);
            toggleBatchBar();
        });

        // 2. 개별 체크박스 변경 시 상단 바 노출 제어
        checkboxes.forEach(cb => {
            cb.addEventListener('change', toggleBatchBar);
        });

        function toggleBatchBar() {
            const checkedCount = document.querySelectorAll('.device-checkbox:checked').length;
            selectedCountSpan.innerText = checkedCount;

            if (checkedCount > 0) {
                batchBar.classList.remove('d-none');
            } else {
                batchBar.classList.add('d-none');
                selectAll.checked = false;
            }
        }

        // 3. 일괄 수정 적용 (EMS, 상태)
        window.applyBatchAction = function() {
            const selectedIds = Array.from(document.querySelectorAll('.device-checkbox:checked')).map(cb => cb.value);
            const emsValue = document.getElementById('batch-ems').value;
            const statusValue = document.getElementById('batch-status').value;

            if (!emsValue && !statusValue) {
                Swal.fire('알림', '변경할 항목을 선택해주세요.', 'info');
                return;
            }

            Swal.fire({
                title: '일괄 수정을 진행하시겠습니까?',
                text: `${selectedIds.length}개의 장비 정보가 업데이트됩니다.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '수정',
                cancelButtonText: '취소'
            }).then((result) => {
                if (result.isConfirmed) {
                    sendBatchRequest('/devices/batch-update', {
                        ids: selectedIds,
                        emsStatus: emsValue,
                        status: statusValue
                    });
                }
            });
        };

        // 4. 일괄 삭제 적용
        window.deleteSelected = function() {
            const selectedIds = Array.from(document.querySelectorAll('.device-checkbox:checked')).map(cb => cb.value);

            if (selectedIds.length === 0) {
                Swal.fire('알림', '삭제할 장비를 선택해주세요.', 'info');
                return;
            }

            Swal.fire({
                title: '일괄 삭제하시겠습니까?',
                // [수정] 안내 문구 변경 (영구 삭제 -> 30일 보관)
                html: `선택한 <b>${selectedIds.length}개</b>의 장비가 삭제 대기 상태로 변경됩니다.<br>보존 기간(30일) 후 자동으로 영구 삭제됩니다.`,
                icon: 'warning', // danger는 없는 아이콘이라 warning으로 수정 권장
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: '삭제 (휴지통 이동)',
                cancelButtonText: '취소'
            }).then((result) => {
                if (result.isConfirmed) {
                    sendBatchRequest('/devices/batch-delete', { ids: selectedIds });
                }
            });
        };

        // 공통 서버 전송 함수
        function sendBatchRequest(url, data) {
            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [header]: token
                },
                body: JSON.stringify(data)
            }).then(response => {
                if (response.ok) {
                    Swal.fire('성공', '요청이 처리되었습니다.', 'success').then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire('에러', '처리 중 오류가 발생했습니다. (권한 부족 등)', 'error');
                }
            }).catch(error => {
                console.error('Error:', error);
                Swal.fire('에러', '네트워크 오류가 발생했습니다.', 'error');
            });
        }

        // --- 툴팁 활성화 코드 추가 ---
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })

        const successMessage = [[${successMessage}]];
        const errorMessage = [[${errorMessage}]];

        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
        });
        // [추가] 삭제 완료 후 새로고침 되었는지 확인하는 로직
        if (sessionStorage.getItem('deleteComplete') === 'true') {
            Toast.fire({
                icon: 'success',
                title: '장비가 영구 삭제되었습니다.'
            });
            // 알림을 띄운 후에는 저장소에서 기록을 지워야
            // 나중에 그냥 새로고침 했을 때 또 뜨지 않습니다.
            sessionStorage.removeItem('deleteComplete');
        }
        if (successMessage) {
            Toast.fire({ icon: 'success', title: successMessage });
        }

        if (errorMessage) {
            Toast.fire({ icon: 'error', title: errorMessage });
        }
    });

    function confirmDelete(deviceId, serialNum) {
        Swal.fire({
            title: '장비 삭제 선택',
            text: `[${serialNum}] 장비를 어떻게 처리하시겠습니까?`,
            icon: 'warning',
            showDenyButton: true,
            showCancelButton: true,
            confirmButtonText: '기록 보존 (논리 삭제)',
            denyButtonText: '영구 제거 (물리 삭제)',
            cancelButtonText: '취소',
            confirmButtonColor: '#3085d6',
            denyButtonColor: '#d33',
        }).then((result) => {
            if (result.isConfirmed) {
                // 논리 삭제: 사유 입력창
                Swal.fire({
                    title: '삭제 사유 입력',
                    input: 'text',
                    inputPlaceholder: '예: 계약 만료, 장비 노후화 등',
                    showCancelButton: true,
                    confirmButtonText: '확인',
                    inputValidator: (value) => {
                        if (!value) {
                            return '삭제 사유를 반드시 입력해야 합니다!';
                        }
                    }
                }).then((res) => {
                    if (res.isConfirmed && res.value) {
                        location.href = `/devices/${deviceId}/soft-delete?reason=` + encodeURIComponent(res.value);
                    }
                });
            } else if (result.isDenied) {
                // 물리 삭제: 2차 확인
                Swal.fire({
                    title: '정말 영구 삭제하시겠습니까?',
                    text: "이 작업은 DB에서 데이터를 완전히 지우며 복구할 수 없습니다.",
                    icon: 'error',
                    showCancelButton: true,
                    confirmButtonText: '네, 삭제합니다',
                    confirmButtonColor: '#d33'
                }).then((secondRes) => {
                    if (secondRes.isConfirmed) {
                        location.href = `/devices/${deviceId}/hard-delete`;
                    }
                });
            }
        });
    }

    // ===============================================
    // [TEST 1분 카운트다운 로직]
    // ===============================================
    const timerElements = document.querySelectorAll('.countdown-timer');

    timerElements.forEach(el => {
        const deletedAtStr = el.getAttribute('data-deleted-at');
        if (!deletedAtStr) return;

        const deletedAt = new Date(deletedAtStr);
        // 만료 시간 = 삭제 시간 + 60초 (1분)
        const expireTime = new Date(deletedAt.getTime() + 60 * 1000);

        // [추가] 점 개수를 저장할 변수 (0 ~ 3)
        let dotCount = 0;
        // [추가] 새로고침 예약이 중복으로 걸리는 것을 방지하는 플래그
        let isReloadScheduled = false;

        function updateTimer() {
            const now = new Date();
            const diff = expireTime - now;
            const textSpan = el.querySelector('.timer-text');

            if (diff <= 0) {
                el.classList.remove('text-danger');
                el.classList.add('text-secondary');

                // [수정] 1초마다 점 개수 변경 로직 (0 -> 1 -> 2 -> 3 -> 0 ...)
                // dotCount를 1씩 증가시키고 4로 나눈 나머지를 구함
                dotCount = (dotCount + 1) % 4;
                const dots = ".".repeat(dotCount); // 점 개수만큼 문자열 생성
                textSpan.innerText = "삭제 처리중" + dots;

                // [수정] 10초 뒤 새로고침 (단, 한 번만 예약되도록 설정)
                if (!isReloadScheduled) {
                    isReloadScheduled = true; // 예약됨 상태로 변경
                    setTimeout(() => {
                        // 1. 브라우저 저장소에 '삭제 완료' 플래그 저장
                        sessionStorage.setItem('deleteComplete', 'true');
                        // 2. 페이지 새로고침 (현재 페이지 유지)
                        location.reload();
                    }, 10000);
                }
                return;
            }

            const secondsLeft = Math.floor(diff / 1000);
            textSpan.innerText = `${secondsLeft}초 후 삭제`;
        }

        updateTimer();
        setInterval(updateTimer, 1000);
    });

    // ===============================================
    // [PROD 30일 D-Day 로직] (활성화됨)
    // ===============================================
    // const dDayElements = document.querySelectorAll('.d-day-display');
    //
    // dDayElements.forEach(el => {
    //     const deletedAtStr = el.getAttribute('data-deleted-at');
    //     if (!deletedAtStr) return;
    //
    //     const deletedAt = new Date(deletedAtStr);
    //     // 만료 시간 = 삭제 시간 + 30일
    //     // 30일 * 24시간 * 60분 * 60초 * 1000밀리초
    //     const expireTime = new Date(deletedAt.getTime() + 30 * 24 * 60 * 60 * 1000);
    //
    //     const now = new Date();
    //     const diff = expireTime - now;
    //     const textSpan = el.querySelector('.d-day-text');
    //
    //     if (diff <= 0) {
    //         // 이미 30일이 지난 경우 (스케줄러 동작 전)
    //         el.classList.remove('text-danger');
    //         el.classList.add('text-secondary');
    //         textSpan.innerText = "삭제 예정 (오늘)";
    //     } else {
    //         // D-Day 계산 (밀리초 -> 일)
    //         // 올림(Math.ceil)을 해야 "D-1" (내일 삭제) 등이 정확히 나옵니다.
    //         const daysLeft = Math.ceil(diff / (1000 * 60 * 60 * 24));
    //         textSpan.innerText = `D-${daysLeft} 삭제 예정`;
    //     }
    // });

</script>
</body>
</html>