<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>장비 관리</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" th:href="@{/css/sidebar.css}">
    <!-- [통합] admin.css 하나만 사용 -->
    <link rel="stylesheet" th:href="@{/css/admin.css}">
</head>
<body>

<div th:replace="~{fragments/header :: header}"></div>

<div class="d-flex">
    <div th:replace="fragments/sidebar :: sidebar"></div>

    <main class="main-content flex-grow-1">

        <h2 class="mb-4 text-white border-bottom pb-2">
            <i class="bi bi-hdd-stack me-2 text-primary"></i>장비 관리
            <span class="text-white-50 fs-6 ms-2 fw-normal">(Device Management)</span>
        </h2>

        <div class="d-flex justify-content-between mb-4 align-items-center">

            <form action="/devices" method="get" class="d-flex gap-2" style="flex-grow: 1; max-width: 900px;">

                <select name="sort" class="form-select custom-select" style="width: 160px;" onchange="this.form.submit()">
                    <option value="member" th:selected="${sort == 'member'}">신청자 아이디</option>
                    <option value="rack" th:selected="${sort == 'rack'}">위치(Rack)</option>
                    <option value="category" th:selected="${sort == 'category'}">장비 종류</option>
                    <option value="serial" th:selected="${sort == 'serial'}">제조사/모델</option>
                    <option value="power" th:selected="${sort == 'power'}">소비전력</option>
                    <option value="ems" th:selected="${sort == 'ems'}">EMS</option>
                    <option value="location" th:selected="${sort == 'location'}">설치 위치</option>
                    <option value="contract" th:selected="${sort == 'contract'}">입고일(계약일) 기준</option>
                    <option value="expiry" th:selected="${sort == 'expiry'}">만료일 임박 순</option>
                    <option value="status" th:selected="${sort == 'status'}">상태</option>
                </select>

                <select name="sortDir" class="form-select custom-select" style="width: 130px;" onchange="this.form.submit()">
                    <option value="desc" th:selected="${sortDir == 'desc'}">내림차순</option>
                    <option value="asc" th:selected="${sortDir == 'asc'}">오름차순</option>
                </select>

                <input type="text" name="keyword" class="form-control custom-form-control"
                       placeholder="검색어 입력..." th:value="${keyword}">

                <button type="submit" class="btn custom-btn-primary text-nowrap">
                    <i class="bi bi-search"></i> 검색
                </button>

                <a href="/devices" class="btn custom-btn-secondary text-nowrap">
                    <i class="bi bi-arrow-clockwise"></i> 초기화
                </a>
            </form>

            <div class="ms-2">
                <a href="/devices/new" class="btn custom-btn-primary text-nowrap shadow-sm">
                    <i class="bi bi-plus-lg"></i> 신규 장비 등록
                </a>
            </div>
        </div>

        <div id="batch-control-bar" class="mb-3 p-3 bg-dark border rounded d-none">
            <div class="d-flex align-items-center gap-3">
                <span class="text-white fw-bold"><i class="bi bi-check2-square me-1"></i> <span id="selected-count">0</span>개 선택됨</span>

                <div class="vr text-secondary"></div>

                <select id="batch-ems" class="form-select form-select-sm" style="width: 120px;">
                    <option value="">EMS 변경</option>
                    <option value="ON">ON</option>
                    <option value="OFF">OFF</option>
                </select>

                <select id="batch-status" class="form-select form-select-sm" style="width: 130px;">
                    <option value="">상태 변경</option>
                    <option value="RUNNING">RUNNING</option>
                    <option value="OFF">OFF</option>
                </select>

                <button type="button" onclick="applyBatchAction()" class="btn btn-sm btn-primary">적용</button>
                <button type="button" onclick="deleteSelected()" class="btn btn-sm btn-danger ms-auto">선택 삭제</button>
            </div>
        </div>

        <div class="table-responsive table-container">
            <table class="table table-hover admin-table">
                <thead>
                <tr class="text-center">
                    <th style="width: 3%">
                        <input type="checkbox" id="selectAll" class="form-check-input">
                    </th>
                    <th style="width: 12%">신청자</th>
                    <th style="width: 10%">위치(Rack)</th>
                    <th style="width: 10%">장비 종류</th>
                    <th style="width: 15%">제조사/모델</th>
                    <th style="width: 7%">소비전력</th>
                    <th style="width: 7%">EMS</th>
                    <th style="width: 8%">설치위치</th>
                    <th style="width: 10%" class="text-start">계약 (만료일)</th>
                    <th style="width: 8%">상태</th>
                    <th style="width: 10%">관리</th>
                </tr>
                </thead>
                <tbody class="text-center">
                <tr th:each="device : ${devices}">
                    <td>
                        <input type="checkbox" name="deviceIds" th:value="${device.id}" class="form-check-input device-checkbox">
                    </td>
                    <td>
                        <span th:if="${device.member != null}">
                            <a th:href="@{/admin/members/{mId}(mId=${device.member.memberId})}"
                               class="text-info text-decoration-none"
                               data-bs-toggle="tooltip"
                               data-bs-placement="top"
                               th:title="'시스템 장비 ID: ' + ${device.id}">
                                <i class="bi bi-person-fill small"></i>
                                [[${device.member.memberId}]]
                            </a>
                        </span>
                        <span th:unless="${device.member != null}" class="text-sub-muted">-</span>
                    </td>

                    <td class="text-white fw-bold" th:text="${device.rack != null ? device.rack.rackName : '미배정'}">A-01</td>

                    <td th:text="${device.category != null ? device.category.name : '-'}">서버</td>

                    <td class="text-center">
                        <div class="fw-bold text-white" th:text="${device.vendor}">Dell</div>
                        <div class="text-sub-muted" th:text="${device.modelName}">R740</div>
                    </td>

                    <td class="text-white">
                        <span th:text="${device.powerWatt != null ? device.powerWatt : 0}">500</span>W
                    </td>

                    <td>
                        <span th:if="${device.emsStatus == 'ON'}" class="badge bg-primary px-2">ON</span>
                        <span th:unless="${device.emsStatus == 'ON'}" class="badge bg-secondary px-2">OFF</span>
                    </td>

                    <td class="text-white">
                        <span th:text="${device.startUnit ?: '-'}"></span>
                        -
                        <span th:text="${(device.startUnit ?: 0) + (device.heightUnit ?: 0) - 1}"></span>
                    </td>

                    <td class="text-start">
                        <div th:if="${device.contractDate != null and device.contractMonth != null}">
                            <span class="text-white small" th:text="${device.contractDate}">2025-01-01</span><br/>

                            <small class="fw-bold"
                                   th:with="expireDate=${device.contractDate.plusMonths(device.contractMonth)}"
                                   th:classappend="${expireDate.isBefore(#temporals.createToday())} ? 'text-danger' : 'text-success'">
                                ~ [[${expireDate}]]
                            </small>
                        </div>

                        <div th:unless="${device.contractDate != null and device.contractMonth != null}" class="text-sub-muted">
                            -
                        </div>
                    </td>

                    <td>
                    <span th:if="${device.status != null}">
                        <span class="badge bg-success" th:if="${device.status == 'RUNNING'}">RUNNING</span>
                        <span class="badge bg-danger" th:if="${device.status == 'ERROR'}">ERROR</span>
                        <span class="badge bg-secondary" th:if="${device.status == 'OFF'}">OFF</span>
                        <span class="badge bg-info" th:unless="${device.status == 'RUNNING' or device.status == 'ERROR' or device.status == 'OFF'}">[[${device.status}]]</span>
                    </span>
                        <span th:unless="${device.status != null}" class="badge bg-warning text-dark">UNKNOWN</span>
                    </td>

                    <td>
                        <div class="d-flex justify-content-center gap-1">
                            <a th:href="@{/devices/{id}/edit(id=${device.id})}" class="btn btn-sm btn-outline-warning">수정</a>
                            <a th:href="@{/devices/{id}/delete(id=${device.id})}"
                               class="btn btn-sm btn-outline-danger"
                               onclick="return confirm('정말 이 장비를 폐기하시겠습니까?');">삭제</a>
                        </div>
                    </td>
                </tr>
                <tr th:if="${devices.isEmpty()}">
                    <td colspan="10" class="text-center py-5 text-sub-muted">등록된 장비가 없습니다.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </main>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.device-checkbox');
        const batchBar = document.getElementById('batch-control-bar');
        const selectedCountSpan = document.getElementById('selected-count');

        // 1. 전체 선택/해제 로직
        selectAll.addEventListener('change', function() {
            checkboxes.forEach(cb => cb.checked = this.checked);
            toggleBatchBar();
        });

        // 2. 개별 체크박스 변경 시 상단 바 노출 제어
        checkboxes.forEach(cb => {
            cb.addEventListener('change', toggleBatchBar);
        });

        function toggleBatchBar() {
            const checkedCount = document.querySelectorAll('.device-checkbox:checked').length;
            selectedCountSpan.innerText = checkedCount;

            if (checkedCount > 0) {
                batchBar.classList.remove('d-none');
            } else {
                batchBar.classList.add('d-none');
                selectAll.checked = false;
            }
        }

        // 3. 일괄 수정 적용 (EMS, 상태)
        window.applyBatchAction = function() {
            const selectedIds = Array.from(document.querySelectorAll('.device-checkbox:checked')).map(cb => cb.value);
            const emsValue = document.getElementById('batch-ems').value;
            const statusValue = document.getElementById('batch-status').value;

            if (!emsValue && !statusValue) {
                Swal.fire('알림', '변경할 항목을 선택해주세요.', 'info');
                return;
            }

            Swal.fire({
                title: '일괄 수정을 진행하시겠습니까?',
                text: `${selectedIds.length}개의 장비 정보가 업데이트됩니다.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '수정',
                cancelButtonText: '취소'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Fetch API를 이용한 비동기 전송 예시
                    sendBatchRequest('/devices/batch-update', {
                        ids: selectedIds,
                        emsStatus: emsValue,
                        status: statusValue
                    });
                }
            });
        };

        // 4. 일괄 삭제 적용
        window.deleteSelected = function() {
            const selectedIds = Array.from(document.querySelectorAll('.device-checkbox:checked')).map(cb => cb.value);

            Swal.fire({
                title: '정말 삭제하시겠습니까?',
                text: "선택한 장비들이 모두 영구 삭제됩니다!",
                icon: 'danger',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: '삭제'
            }).then((result) => {
                if (result.isConfirmed) {
                    sendBatchRequest('/devices/batch-delete', { ids: selectedIds });
                }
            });
        };

        // 공통 서버 전송 함수
        function sendBatchRequest(url, data) {
            // 메타 태그에서 토큰 정보 읽기
            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [header]: token  // CSRF 토큰 헤더 추가
                },
                body: JSON.stringify(data)
            }).then(response => {
                if (response.ok) {
                    // 성공 시 SweetAlert로 알림 후 페이지 이동/새로고침
                    Swal.fire('성공', '요청이 처리되었습니다.', 'success').then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire('에러', '처리 중 오류가 발생했습니다. (권한 부족 등)', 'error');
                }
            }).catch(error => {
                console.error('Error:', error);
                Swal.fire('에러', '네트워크 오류가 발생했습니다.', 'error');
            });
        }

        // --- 툴팁 활성화 코드 추가 ---
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })

        // 컨트롤러의 RedirectAttributes에서 보낸 메시지 읽기
        const successMessage = [[${successMessage}]];
        const errorMessage = [[${errorMessage}]];

        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
        });

        // 성공 메시지가 있으면 토스트 띄우기
        if (successMessage) {
            Toast.fire({
                icon: 'success',
                title: successMessage
            });
        }

        // 에러 메시지가 있으면 토스트 띄우기 (삭제 실패 등 대비)
        if (errorMessage) {
            Toast.fire({
                icon: 'error',
                title: errorMessage
            });
        }
    });
</script>
</body>
</html>