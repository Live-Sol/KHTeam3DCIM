<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì…ê³  ì¥ë¹„ í˜„í™©</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&family=Orbitron:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/myRequestList.css">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/myDevice.css">
</head>
<body>

<div th:replace="~{fragments/header :: header}"></div>

<div class="main-content container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-white border-bottom pb-2">
            <i class="bi bi-clipboard-data me-2"></i>ì…ê³  ì¥ë¹„ í˜„í™©
        </h3>
        <div class="text-sub-muted">
            <i class="bi bi-info-circle me-1"></i> ìŠ¹ì¸ ì™„ë£Œ í›„ ìš´ì˜ ì¤‘ì´ê±°ë‚˜ ê³„ì•½ ì¢…ë£Œëœ ì¥ë¹„ ëª©ë¡ì…ë‹ˆë‹¤.
        </div>
    </div>

    <div class="d-flex justify-content-between mb-4 align-items-center">
        <form action="/devices/my" method="get" class="d-flex gap-2" style="flex-grow: 1; max-width: 800px;">
            <select name="sort" class="form-select custom-select" style="width: 160px;" onchange="this.form.submit()">
                <option value="contractDate" th:selected="${sort == 'contractDate'}">ë§ˆê°ì¼ ê¸°ì¤€</option>
                <option value="serialNum" th:selected="${sort == 'serialNum'}">ê´€ë¦¬ë²ˆí˜¸ ê¸°ì¤€</option>
                <option value="status" th:selected="${sort == 'status'}">ìƒíƒœ ê¸°ì¤€</option>
            </select>

            <input type="text" name="keyword" class="form-control custom-form-control"
                   placeholder="ê´€ë¦¬ë²ˆí˜¸ ë˜ëŠ” ëª¨ë¸ëª… ê²€ìƒ‰..." th:value="${keyword}">

            <button type="submit" class="btn custom-btn-primary text-nowrap">ğŸ” ê²€ìƒ‰</button>
        </form>
    </div>

    <div class="table-responsive table-container">
        <table class="table table-hover admin-table">
            <thead>
            <tr>
                <th style="width: 18%">ê´€ë¦¬ ë²ˆí˜¸(SN)</th>
                <th style="width: 27%">ì¥ë¹„ ì •ë³´ (ì œì¡°ì‚¬/ëª¨ë¸)</th>
                <th style="width: 10%">ê·œê²©</th>
                <th style="width: 15%">ë§ˆê°ì¼ (ê³„ì•½ì¢…ë£Œ)</th>
                <th style="width: 20%">ìƒíƒœ</th>
                <th style="width: 10%">ìƒì„¸</th>
            </tr>
            </thead>
            <tbody class="text-center">
            <tr th:each="device : ${devices}">
                <td>
                    <strong class="text-info font-orbitron" th:text="${device.serialNum}">SN-20231201</strong>
                </td>
                <td class="text-center ps-4">
                    <strong class="text-white" th:text="${device.vendor}">Dell</strong>
                    <span class="text-sub-muted mx-1">/</span>
                    <span class="text-white" th:text="${device.modelName}">PowerEdge R740</span>
                </td>
                <td>
                    <span class="badge bg-secondary px-2" th:text="${device.heightUnit} + ' U'">2 U</span>
                </td>
                <td>
                    <span th:class="${device.isExpired ? 'text-danger fw-bold' : 'text-white'}"
                          th:text="${#temporals.format(device.endDate, 'yyyy-MM-dd')}">
                    </span>
                </td>
                <td>
                    <span th:if="${device.status == 'RUNNING'}" class="badge bg-success status-badge">
                        <i class="bi bi-play-circle-fill me-1"></i> Running
                    </span>

                    <span th:if="${device.status == 'OFF'}" class="badge bg-secondary status-badge">
                        <i class="bi bi-power me-1"></i> Off
                    </span>

                    <div th:if="${device.status == 'DELETED'}">
                        <span class="badge bg-danger status-badge mb-1"
                            role="button"
                            data-bs-toggle="collapse"
                            th:attr="data-bs-target='#deleteReason-' + ${device.id}">
                            <i class="bi bi-trash-fill me-1"></i>ì‚­ì œ(ì‚¬ìœ )
                        </span>

                        <div th:id="'deleteReason-' + ${device.id}" class="collapse mt-2 text-start">
                            <div class="alert alert-danger py-2 px-3 mb-0" style="font-size: 0.85rem;">
                                <strong><i class="bi bi-exclamation-triangle me-1"></i> ì‚­ì œ ì‚¬ìœ </strong><br>
                                <span th:text="${device.deleteReason ?: 'ê³„ì•½ ê¸°ê°„ ë§Œë£Œë¡œ ì¸í•œ ìë™ ì‚­ì œ'}"></span>
                            </div>
                        </div>
                    </div>
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-light"
                            th:onclick="showDeviceDetail([[${device.id}]])">
                        <i class="bi bi-search"></i>
                    </button>
                </td>
            </tr>
            </tbody>

            <tbody th:if="${#lists.isEmpty(devices)}">
            <tr>
                <td colspan="6" class="text-center py-5 text-sub-muted">
                    <i class="bi bi-hdd-network fs-1 d-block mb-3"></i>
                    ì…ê³ ëœ ì¥ë¹„ í˜„í™©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                </td>
            </tr>
            </tbody>
        </table>
        <nav th:if="${page.totalPages > 1}" class="mt-4">
            <ul class="pagination justify-content-center custom-pagination">
                <li class="page-item" th:classappend="${page.first} ? 'disabled'">
                    <a class="page-link" th:href="@{/devices/my(page=${page.number - 1}, keyword=${keyword}, sort=${sort}, sortDir=${sortDir})}">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>

                <li class="page-item" th:each="idx : ${#numbers.sequence(0, page.totalPages - 1)}"
                    th:classappend="${idx == page.number} ? 'active'">
                    <a class="page-link" th:href="@{/devices/my(page=${idx}, keyword=${keyword}, sort=${sort}, sortDir=${sortDir})}"
                       th:text="${idx + 1}">1</a>
                </li>

                <li class="page-item" th:classappend="${page.last} ? 'disabled'">
                    <a class="page-link" th:href="@{/devices/my(page=${page.number + 1}, keyword=${keyword}, sort=${sort}, sortDir=${sortDir})}">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <div class="mt-4 text-end">
        <a th:href="@{/}" class="btn custom-btn-secondary">í™ˆìœ¼ë¡œ ì´ë™</a>
    </div>
</div>

<div class="modal fade" id="deviceDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content bg-dark text-white border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title font-orbitron"><i class="bi bi-info-circle me-2 text-info"></i>ì¥ë¹„ ìƒì„¸ ëª…ì„¸</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label text-sub-muted small">ê´€ë¦¬ ë²ˆí˜¸ (S/N)</label>
                        <p id="modalSerial" class="form-control bg-black text-info border-secondary mb-0"></p>
                    </div>
                    <div class="col-6">
                        <label class="form-label text-sub-muted small">ì œì¡°ì‚¬</label>
                        <p id="modalVendor" class="form-control bg-black text-white border-secondary mb-0"></p>
                    </div>
                    <div class="col-6">
                        <label class="form-label text-sub-muted small">ëª¨ë¸ëª…</label>
                        <p id="modalModel" class="form-control bg-black text-white border-secondary mb-0"></p>
                    </div>
                    <div class="col-6">
                        <label class="form-label text-sub-muted small">ì¥ë¹„ ê·œê²©</label>
                        <p id="modalHeight" class="form-control bg-black text-white border-secondary mb-0"></p>
                    </div>
                    <div class="col-6">
                        <label class="form-label text-sub-muted small">ì†Œë¹„ì „ë ¥</label>
                        <p id="modalPower" class="form-control bg-black text-white border-secondary mb-0"></p>
                    </div>
                    <div class="col-6">
                        <label class="form-label text-sub-muted small">EMS ìœ ë¬´</label>
                        <p id="modalEms" class="form-control bg-black text-white border-secondary mb-0"></p>
                    </div>
                    <div class="col-12">
                        <label class="form-label text-sub-muted small">ìš©ë„ ë° ì„¤ëª…</label>
                        <p id="modalDesc" class="form-control bg-black text-white border-secondary mb-0" style="min-height: 60px;"></p>
                    </div>
                    <div class="col-6">
                        <label class="form-label text-sub-muted small">ê³„ì•½ ì¢…ë£Œì¼</label>
                        <p id="modalEndDate" class="form-control bg-black text-white border-secondary mb-0"></p>
                    </div>
                    <div id="modalReasonArea" class="col-12" style="display: none;">
                        <label class="form-label text-danger small">ì‚­ì œ ì‚¬ìœ </label>
                        <div class="alert alert-danger py-2 px-3 mb-0" style="font-size: 0.85rem;">
                            <span id="modalDeleteReason"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    function showDeviceDetail(deviceId) {
        // ì„œë²„ì˜ ìƒì„¸ ì¡°íšŒ API í˜¸ì¶œ (ì´ë¯¸ ë§Œë“¤ì–´ë‘ì‹  ID ê¸°ë°˜ ì¡°íšŒ ì—”ë“œí¬ì¸íŠ¸)
        fetch(`/api/mydevices/${deviceId}`)
            .then(response => {
                if (!response.ok) throw new Error('ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                return response.json();
            })
            .then(device => {
                // ë°ì´í„° ë§¤í•‘
                document.getElementById('modalSerial').innerText = device.serialNum;
                document.getElementById('modalVendor').innerText = device.vendor;
                document.getElementById('modalModel').innerText = device.modelName;
                document.getElementById('modalHeight').innerText = device.heightUnit + " U";
                document.getElementById('modalPower').innerText = (device.powerWatt || 0) + " W";
                document.getElementById('modalEms').innerText = device.emsStatus || "OFF";
                document.getElementById('modalDesc').innerText = device.description || "ë“±ë¡ëœ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.";

                if (device.contractDate) {
                    const date = new Date(device.contractDate);
                    const day = date.getDate(); // ì›ë˜ 'ì¼' ì €ì¥

                    // ì›” ë‹¨ìœ„ í•©ì‚° ì‹œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì˜¤ì°¨ ë°©ì§€ ë¡œì§
                    date.setMonth(date.getMonth() + (device.contractMonth || 0));

                    // ë§Œì•½ ê³„ì‚°ëœ ì›”ì˜ ì¼ìˆ˜ê°€ ì›ë˜ ì¼ìˆ˜ë³´ë‹¤ ì‘ìœ¼ë©´ ìë™ìœ¼ë¡œ ë§ì¼ë¡œ ì¡°ì •ë¨
                    if (date.getDate() < day) {
                        date.setDate(0);
                    }
                    // ë§Œì•½ ë‚ ì§œê°€ í•˜ë£¨ ì „ìœ¼ë¡œ ë‚˜ì˜¨ë‹¤ë©´ ì´ ì½”ë“œë¡œ ì ìš©í•´ ë³´ì„¸ìš”
                    const offset = date.getTimezoneOffset() * 60000;
                    const localISOTime = new Date(date.getTime() - offset).toISOString().split('T')[0];
                    document.getElementById('modalEndDate').innerText = localISOTime;
                } else {
                    document.getElementById('modalEndDate').innerText = "ì •ë³´ ì—†ìŒ";
                }

                // ì‚­ì œ ì‚¬ìœ  í‘œì‹œ ì—¬ë¶€
                const reasonArea = document.getElementById('modalReasonArea');
                if (device.status === 'DELETED') {
                    reasonArea.style.display = 'block';
                    document.getElementById('modalDeleteReason').innerText = device.deleteReason || "ê³„ì•½ ê¸°ê°„ ë§Œë£Œë¡œ ì¸í•œ ìë™ ì‚­ì œ";
                } else {
                    reasonArea.style.display = 'none';
                }

                // ëª¨ë‹¬ ë„ìš°ê¸°
                const detailModal = new bootstrap.Modal(document.getElementById('deviceDetailModal'));
                detailModal.show();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ì¥ë¹„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
    }
</script>
</body>
</html>