<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>장비 관리</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="container mt-5" style="max-width: 600px;">

    <h2 class="mb-4" th:text="${isEdit == true} ? '🛠️ 장비 정보 수정' : '➕ 신규 장비 등록'"></h2>

    <div class="alert alert-success" th:if="${reqId != null}">
        🔔 <strong>장비 신청 승인</strong> 건입니다. 정보가 자동으로 입력되었습니다.<br>
        랙 위치와 시리얼 번호만 입력하고 등록하세요.
    </div>

    <form th:action="${isEdit == true} ? @{/devices/{id}/edit(id=${device.id})} : @{/devices/new}" method="post">

        <div class="card bg-light mb-4 border-primary" th:if="${waitingRequests != null and !waitingRequests.isEmpty()}">
            <div class="card-body p-3">
                <label class="form-label fw-bold text-primary">📋 입주 대기 신청서 불러오기</label>
                <select id="requestSelect" class="form-select" onchange="loadRequestData(this)">
                    <option value="">--- 선택 안 함 (직접 입력) ---</option>

                    <th:block th:each="req : ${waitingRequests}">
                        <option th:value="${req.id}"
                                th:data-vendor="${req.vendor}"
                                th:data-model="${req.modelName}"
                                th:data-cate="${req.cateId}"
                                th:data-height="${req.heightUnit}"
                                data-ip="">
                            No.[[${req.id}]] [[${req.userName}]] - [[${req.vendor}]] [[${req.modelName}]] ([[${req.heightUnit}]]U)
                        </option>
                    </th:block>
                </select>
                <div class="form-text">선택 시 신청서 내용이 아래 폼에 자동으로 입력됩니다.</div>
            </div>
        </div>

        <input type="hidden" id="reqIdField" name="reqId" th:value="${reqId}">

        <div class="mb-3">
            <label class="form-label">설치된 랙</label>
            <select name="rackId" class="form-select"
                    th:disabled="${selectedRackId != null or isEdit == true}"
                    th:classappend="${selectedRackId != null or isEdit == true} ? 'bg-light'">

                <option value="" disabled selected>--- 설치할 랙을 선택하세요 ---</option>

                <option th:each="rack : ${racks}"
                        th:value="${rack.id}"
                        th:text="|${rack.rackName} (${rack.locationDesc})|"
                        th:selected="${rack.id == selectedRackId or (device.rack != null and device.rack.id == rack.id)}">
                </option>
            </select>
            <input th:if="${selectedRackId != null}" type="hidden" name="rackId" th:value="${selectedRackId}">
        </div>

        <div class="mb-3">
            <label class="form-label">장비 종류</label>
            <select name="cateId" class="form-select"
                    th:disabled="${reqId != null or isEdit == true}"
                    th:classappend="${reqId != null or isEdit == true} ? 'bg-light'">
                <option th:each="cate : ${categories}"
                        th:value="${cate.id}"
                        th:text="${cate.name}"
                        th:selected="${device.category != null and cate.id == device.category.id}">서버</option>
            </select>
            <input th:if="${reqId != null or isEdit == true}" type="hidden" name="cateId"
                   th:value="${device.category != null ? device.category.id : selectedCateId}">
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">제조사</label>
                <input type="text" name="vendor" class="form-control"
                       th:value="${device.vendor}"
                       th:readonly="${reqId != null}"
                       th:classappend="${reqId != null} ? 'bg-light'">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">모델명</label>
                <input type="text" name="modelName" class="form-control"
                       th:value="${device.modelName}"
                       th:readonly="${reqId != null}"
                       th:classappend="${reqId != null} ? 'bg-light'">
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">시리얼 번호</label>
            <input type="text" name="serialNum" class="form-control"
                   th:value="${device.serialNum}" required>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">시작 위치 (U)</label>
                <input type="number" name="startUnit" class="form-control"
                       th:value="${device.startUnit}"
                       th:readonly="${isEdit == true}"
                       th:classappend="${isEdit == true} ? 'bg-light'" required>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">장비 높이 (U)</label>
                <input type="number" name="heightUnit" class="form-control"
                       th:value="${device.heightUnit != null ? device.heightUnit : 1}"
                       th:readonly="${reqId != null or isEdit == true}"
                       th:classappend="${reqId != null or isEdit == true} ? 'bg-light'" required>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">관리 IP 주소</label>
            <input type="text" name="ipAddr" class="form-control"
                   th:value="${device.ipAddr}" required>
        </div>

        <hr>
        <button type="submit" class="btn btn-primary w-100" th:text="${isEdit == true} ? '수정 저장' : '등록 완료'"></button>
        <a href="/devices" class="btn btn-secondary w-100 mt-2">취소</a>
    </form>
</div>

<script src="/js/device_form.js"></script>

</body>
</html>