<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>장비 관리</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="container mt-5" style="max-width: 600px;">

    <!-- 제목: 모드에 따라 다르게 표시 -->
    <!-- isEdit이 null일 수도 있으므로 안전하게 비교 (isEdit == true) -->
    <h2 class="mb-4" th:text="${isEdit == true} ? '🛠️ 장비 정보 수정' : '➕ 신규 장비 등록'"></h2>

    <!-- 승인 건 안내 (등록 모드일 때만) -->
    <div class="alert alert-success" th:if="${reqId != null}">
        🔔 <strong>장비 신청 승인</strong> 건입니다. 정보가 자동으로 입력되었습니다.<br>
        랙 위치와 시리얼 번호만 입력하고 등록하세요.
    </div>

    <!--⭐ 핵심: th:action 동적 처리
        isEdit이 true면 수정 주소로, false면 등록 주소로 보냄-->
    <form th:action="${isEdit == true} ? @{/devices/{id}/edit(id=${device.id})} : @{/devices/new}" method="post">

        <!-- 신청서 번호 (히든) -->
        <input type="hidden" name="reqId" th:value="${reqId}">

        <!-- 1. 랙 & 위치 (수정 모드에서는 변경 불가 - 복잡성 방지) -->
        <div class="mb-3">
            <label class="form-label">설치된 랙</label>

            <select name="rackId" class="form-select"
                    th:disabled="${selectedRackId != null or isEdit == true}"
                    th:classappend="${selectedRackId != null or isEdit == true} ? 'bg-light'">

                <option value="" disabled selected>--- 설치할 랙을 선택하세요 ---</option>

                <option th:each="rack : ${racks}"
                        th:value="${rack.id}"
                        th:text="|${rack.rackName} (${rack.locationDesc})|"
                        th:selected="${rack.id == selectedRackId or (device.rack != null and device.rack.id == rack.id)}">
                </option>
            </select>

            <input th:if="${selectedRackId != null}" type="hidden" name="rackId" th:value="${selectedRackId}">
        </div>

        <!-- 2. 장비 종류 -->
        <div class="mb-3">
            <label class="form-label">장비 종류</label>
            <!-- 신청서 승인 or 수정 모드일 때: 수정 불가 -->
            <!-- isEdit을 안전하게 boolean으로 처리하기 위해 (isEdit == true) 사용 -->
            <select name="cateId" class="form-select"
                    th:disabled="${reqId != null or isEdit == true}"
                    th:classappend="${reqId != null or isEdit == true} ? 'bg-light'">
                <option th:each="cate : ${categories}"
                        th:value="${cate.id}"
                        th:text="${cate.name}"
                        th:selected="${device.category != null and cate.id == device.category.id}">서버</option>
            </select>

            <!-- disabled 상태일 때 값 전송용 -->
            <input th:if="${reqId != null or isEdit == true}" type="hidden" name="cateId"
                   th:value="${device.category != null ? device.category.id : selectedCateId}">
        </div>

        <!-- 3. 제조사 & 모델명 -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">제조사</label>
                <!-- 수정 모드에서는 수정 가능! -->
                <input type="text" name="vendor" class="form-control"
                       th:value="${device.vendor}"
                       th:readonly="${reqId != null}"
                       th:classappend="${reqId != null} ? 'bg-light'">
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">모델명</label>
                <input type="text" name="modelName" class="form-control"
                       th:value="${device.modelName}"
                       th:readonly="${reqId != null}"
                       th:classappend="${reqId != null} ? 'bg-light'">
            </div>
        </div>

        <!-- 4. 시리얼 번호 (언제든 수정 가능) -->
        <div class="mb-3">
            <label class="form-label">시리얼 번호</label>
            <input type="text" name="serialNum" class="form-control"
                   th:value="${device.serialNum}" required>
        </div>

        <!-- 5. 위치 & 높이 (수정 모드에서는 변경 불가) -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">시작 위치 (U)</label>
                <input type="number" name="startUnit" class="form-control"
                       th:value="${device.startUnit}"
                       th:readonly="${isEdit == true}"
                       th:classappend="${isEdit == true} ? 'bg-light'" required>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">장비 높이 (U)</label>
                <input type="number" name="heightUnit" class="form-control"
                       th:value="${device.heightUnit != null ? device.heightUnit : 1}"
                       th:readonly="${reqId != null or isEdit == true}"
                       th:classappend="${reqId != null or isEdit == true} ? 'bg-light'" required>
            </div>
        </div>

        <!-- 6. IP 주소 (언제든 수정 가능) -->
        <div class="mb-3">
            <label class="form-label">관리 IP 주소</label>
            <input type="text" name="ipAddr" class="form-control"
                   th:value="${device.ipAddr}" required>
        </div>

        <hr>
        <button type="submit" class="btn btn-primary w-100" th:text="${isEdit == true} ? '수정 저장' : '등록 완료'"></button>
        <a href="/devices" class="btn btn-secondary w-100 mt-2">취소</a>
    </form>
</div>
</body>
</html>