<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${isEdit == true} ? 'ì¥ë¹„ ì •ë³´ ìˆ˜ì •' : 'ì‹ ê·œ ì¥ë¹„ ë“±ë¡'"></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <link rel="stylesheet" th:href="@{/css/requests.css}">
    <link rel="stylesheet" th:href="@{/css/device_form.css}">

    <style>
        /* requests.cssì˜ --dark-bg ë³€ìˆ˜ ì‚¬ìš© */
        body {
            background-color: var(--dark-bg, #0f172a);
            display: flex;
            justify-content: center;
            align-items: flex-start; /* ìƒë‹¨ì—ì„œ ì‹œì‘ */
            padding-top: 3rem; /* ìƒë‹¨ ì—¬ë°± */
        }
        /* í¼ ì»¨í…Œì´ë„ˆì˜ ìµœëŒ€ ë„ˆë¹„ì™€ ë§ˆì§„ì„ ì„¤ì • */
        .device-form-container {
            width: 100%;
            max-width: 800px;
            margin-bottom: 3rem;
        }
    </style>

</head>
<body>

<div class="device-form-container">

    <div class="card custom-card-dark shadow-lg border-0 mb-5">

        <div class="card-header bg-primary custom-card-header text-white p-3">
            <h4 class="mb-0 fw-bold" th:text="${isEdit == true} ? 'ì¥ë¹„ ì •ë³´ ìˆ˜ì •' : 'ì‹ ê·œ ì¥ë¹„ ë“±ë¡'"></h4>
<!--            <h4 class="mb-0 fw-bold" th:text="${isEdit == true} ? 'ğŸ› ï¸ ì¥ë¹„ ì •ë³´ ìˆ˜ì •' : 'â• ì‹ ê·œ ì¥ë¹„ ë“±ë¡'"></h4>-->
        </div>

        <div class="card-body p-4">

            <div class="alert custom-alert-info d-flex align-items-center" th:if="${reqId != null}">
                <span class="fs-4 me-2">ğŸ””</span>
                <div>
                    <strong>ì¥ë¹„ ì‹ ì²­ ìŠ¹ì¸(No.[[${reqId}]])</strong> ê±´ì…ë‹ˆë‹¤.<br>
                    ì‹ ì²­ì„œì˜ [íšŒì‚¬ëª…/ì—°ë½ì²˜/ì¥ë¹„ì •ë³´]ê°€ ìë™ìœ¼ë¡œ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.
                </div>
            </div>

            <form th:action="${isEdit == true} ? @{/devices/{id}/edit(id=${device.id})} : @{/devices/new}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" id="reqIdField" name="reqId" th:value="${reqId}">

                <div class="card custom-card-light mb-4 border-secondary border-opacity-25"
                     th:if="${isEdit != true and waitingRequests != null and !waitingRequests.isEmpty()}">
                    <div class="card-body p-3">
                        <label class="form-label fw-bold text-primary">ì…ì£¼ ëŒ€ê¸° ì‹ ì²­ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</label>
<!--                        <label class="form-label fw-bold text-primary">ğŸ“¥ ì…ì£¼ ëŒ€ê¸° ì‹ ì²­ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</label>-->
                        <select id="requestSelect" class="form-select custom-select border-primary" onchange="loadRequestData(this)">
                            <option value="">--- ì„ íƒ ì•ˆ í•¨ (ì§ì ‘ ì…ë ¥) ---</option>

                            <th:block th:each="req : ${waitingRequests}">
                                <option th:value="${req.id}"
                                        th:data-company="${req.companyName}"
                                        th:data-company-phone="${req.companyPhone}"
                                        th:data-username="${req.userName}"
                                        th:data-contact="${req.contact}"
                                        th:data-purpose="${req.purpose}"
                                        th:data-vendor="${req.vendor}"
                                        th:data-model="${req.modelName}"
                                        th:data-cate="${req.cateId}"
                                        th:data-height="${req.heightUnit}"
                                        th:data-cdate="${req.startDate}"
                                        th:data-cmonth="${req.termMonth}"
                                        th:data-power="${req.powerWatt}"
                                        th:data-ems="${req.emsStatus}">
                                    No.[[${req.id}]] [[${req.companyName}]] ([[${req.userName}]]) - [[${req.modelName}]]
                                </option>
                            </th:block>
                        </select>
                        <div class="form-text text-sub">ì„ íƒ ì‹œ ì•„ë˜ í¼ì— ë‚´ìš©ì´ ìë™ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤.</div>
                    </div>
                </div>


                <h5 class="mb-3 text-primary border-bottom pb-2">1. ì†Œìœ ì ì •ë³´</h5>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">íšŒì‚¬ëª…</label>
                        <input type="text" name="companyName"
                               class="form-control custom-form-control"
                               th:value="${device.companyName != null ? device.companyName : (member != null ? member.companyName : '')}"
                               th:readonly="${reqId != null}"
                               th:classappend="${reqId != null} ? 'bg-secondary bg-opacity-25'"
                               placeholder="ì˜ˆ: (ì£¼)KHì •ë³´í†µì‹ ">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">íšŒì‚¬ ëŒ€í‘œ ë²ˆí˜¸</label>
                        <input type="text" name="companyPhone"
                               class="form-control custom-form-control"
                               th:value="${device.companyPhone != null ? device.companyPhone : (member != null ? member.contact : '')}"
                               th:readonly="${reqId != null}"
                               th:classappend="${reqId != null} ? 'bg-secondary bg-opacity-25'"
                               placeholder="ì˜ˆ: 02-1234-5678">
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">ë‹´ë‹¹ì ì„±í•¨</label>
                        <input type="text" name="userName"
                               class="form-control custom-form-control"
                               th:value="${device.userName != null ? device.userName : (member != null ? member.name : '')}"
                               th:readonly="${reqId != null}"
                               th:classappend="${reqId != null} ? 'bg-secondary bg-opacity-25'">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">ë‹´ë‹¹ì ì—°ë½ì²˜</label>
                        <input type="text" name="contact"
                               class="form-control custom-form-control"
                               th:value="${device.contact != null ? device.contact : (member != null ? member.contact : '')}"
                               th:readonly="${reqId != null}"
                               th:classappend="${reqId != null} ? 'bg-secondary bg-opacity-25'"
                               placeholder="ì˜ˆ: 010-0000-0000">
                    </div>
                </div>


                <h5 class="mb-3 text-primary border-bottom pb-2">2. ì¥ë¹„ ìƒì„¸ ì •ë³´</h5>

                <div class="mb-3">
                    <label class="form-label">ì„¤ì¹˜ ìœ„ì¹˜ (Rack)</label>
                    <div class="input-group">
                        <span class="input-group-text custom-bg-light"><i class="bi bi-hdd-rack"></i></span>
                        <select name="rackId" class="form-select custom-select"
                                onchange="updateMaxUnit(this)"
                                th:disabled="${selectedRackId != null}"
                                th:autofocus="${selectedRackId == null and (device.rack == null or device.rack.id == null)}"
                                th:classappend="${(errorMessage != null and device.rack == null) ? 'is-invalid ' : ''} + (${selectedRackId != null} ? 'bg-secondary bg-opacity-25' : '')">
                            <option value="" disabled selected>--- ì„¤ì¹˜í•  ë™ ì„ íƒ ---</option>
                            <option th:each="rack : ${racks}"
                                    th:value="${rack.id}"
                                    th:data-total-unit="${rack.totalUnit}"
                                    th:text="|${rack.rackName} (${rack.locationDesc}) - ${rack.totalUnit}U|"
                                    th:selected="${rack.id == selectedRackId or (device.rack != null and device.rack.id == rack.id)}">
                            </option>
                        </select>
                    </div>
                    <input th:if="${selectedRackId != null}" type="hidden" name="rackId" th:value="${selectedRackId}">
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">ì¥ë¹„ ì¢…ë¥˜</label>
                        <select name="cateId" class="form-select custom-select"
                                th:disabled="${reqId != null}"
                                th:classappend="${reqId != null} ? 'bg-secondary bg-opacity-25'">
                            <option th:each="cate : ${categories}"
                                    th:value="${cate.id}"
                                    th:text="${cate.name}"
                                    th:selected="${device.category != null and cate.id == device.category.id}">Server</option>
                        </select>
                        <input th:if="${reqId != null}" type="hidden" name="cateId"
                               th:value="${device.category != null ? device.category.id : selectedCateId}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">ì‹œë¦¬ì–¼ ë²ˆí˜¸<small class="text-danger"> (ê´€ë¦¬ì)</small></label>
<!--                        ì—ëŸ¬ ë©”ì‹œì§€ì— 'ì‹œë¦¬ì–¼'ì´ë¼ëŠ” ë‹¨ì–´ê°€ í¬í•¨ëœ ê²½ìš°ì—ë§Œ is-invalid ì¶”ê°€-->
                        <input type="text" name="serialNum"
                               class="form-control custom-form-control"
                        th:classappend="${errorMessage != null and #strings.contains(errorMessage, 'ì‹œë¦¬ì–¼')} ? 'is-invalid'"
                        th:value="${device.serialNum}"
                        placeholder="SN-XXXX-XXXX">
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">ì œì¡°ì‚¬</label>
                        <input type="text" name="vendor" class="form-control custom-form-control"
                               th:value="${device.vendor}"
                               th:readonly="${reqId != null}"
                               th:classappend="${reqId != null} ? 'bg-secondary bg-opacity-25'" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">ëª¨ë¸ëª…</label>
                        <input type="text" name="modelName" class="form-control custom-form-control"
                               th:value="${device.modelName}"
                               th:readonly="${reqId != null}"
                               th:classappend="${reqId != null} ? 'bg-secondary bg-opacity-25'" required>
                    </div>
                </div>

                <div class="row mb-3 custom-highlight-box p-2 rounded mx-1 border">
                    <div class="col-md-6">
                        <label class="form-label fw-bold text-danger"><i class="bi bi-lightning-charge-fill"></i> ì†Œë¹„ ì „ë ¥ (W)</label>
                        <input type="number" name="powerWatt" class="form-control custom-form-control"
                               th:value="${device.powerWatt != null ? device.powerWatt : 0}"
                               th:readonly="${reqId != null}"
                               th:classappend="${reqId != null} ? 'bg-secondary bg-opacity-25'"
                               placeholder="ì˜ˆ: 500" min="0">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold text-success"><i class="bi bi-activity"></i> EMS ê´€ì œ ì—°ë™</label>
                        <select name="emsStatus" class="form-select custom-select"
                                th:disabled="${reqId != null}"
                                th:classappend="${reqId != null} ? 'bg-secondary bg-opacity-25'">
                            <option value="OFF" th:selected="${device.emsStatus == 'OFF'}">ì—°ë™ ì•ˆ í•¨ (OFF)</option>
                            <option value="ON" th:selected="${device.emsStatus == 'ON'}">ì—°ë™ í•¨ (ON)</option>
                        </select>
                        <input th:if="${reqId != null}" type="hidden" name="emsStatus" th:value="${device.emsStatus}">
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-4">
                        <label class="form-label">ì‹œì‘ ìœ ë‹› (U)</label>
                        <input type="number" name="startUnit" class="form-control custom-form-control"
                               th:value="${device.startUnit}"
                               th:readonly="${reqId != null}"
                               th:classappend="${reqId != null} ? 'bg-secondary bg-opacity-25'" min="1" max="100" value="1">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">ì¥ë¹„ ë†’ì´ (U)</label>
                        <input type="number" name="heightUnit" class="form-control custom-form-control"
                               th:value="${device.heightUnit != null ? device.heightUnit : 1}"
                               th:readonly="${reqId != null}"
                               th:classappend="${reqId != null} ? 'bg-secondary bg-opacity-25'" min="1" max="100">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">ê´€ë¦¬ IP<small class="text-danger"> (ê´€ë¦¬ì)</small></label>
                        <input type="text" name="ipAddr" class="form-control custom-form-control"
                               th:value="${device.ipAddr}" placeholder="192.168.x.x" required>
                    </div>
                </div>


                <h5 class="mb-3 text-primary border-bottom pb-2">3. ê³„ì•½ ë° ê¸°íƒ€ ì •ë³´</h5>

                <div class="mb-3">
                    <label class="form-label">ìš©ë„ / ì„¤ëª… (Description)</label>
                    <textarea name="description" class="form-control custom-form-control" rows="2"
                              th:text="${device.description}"
                              th:readonly="${reqId != null}"
                              th:classappend="${reqId != null} ? 'bg-secondary bg-opacity-25'"
                              placeholder="ì¥ë¹„ì˜ ìš©ë„ë‚˜ íŠ¹ì´ì‚¬í•­ì„ ê¸°ë¡í•˜ì„¸ìš”."></textarea>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label">ì…ê³ ì¼ (ê³„ì•½ ì‹œì‘ì¼)</label>
                        <input type="date" name="contractDate" class="form-control custom-form-control"
                               th:value="${device.contractDate}"
                               th:readonly="${reqId != null}"
                               th:classappend="${reqId != null} ? 'bg-secondary bg-opacity-25'" required>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">ê³„ì•½ ê¸°ê°„</label>
                        <select name="contractMonth" class="form-select custom-select"
                                th:disabled="${reqId != null}"
                                th:classappend="${reqId != null} ? 'bg-secondary bg-opacity-25'">
                            <option value="12" th:selected="${device.contractMonth == 12}">1ë…„ (12ê°œì›”)</option>
                            <option value="24" th:selected="${device.contractMonth == 24 or device.contractMonth == null}">2ë…„ (24ê°œì›”) - í‘œì¤€</option>
                            <option value="36" th:selected="${device.contractMonth == 36}">3ë…„ (36ê°œì›”)</option>
                            <option value="0" th:selected="${device.contractMonth == 0}">ê¸°íƒ€</option>
                        </select>
                        <input th:if="${reqId != null}" type="hidden" name="contractMonth" th:value="${device.contractMonth}">
                    </div>
                </div>

                <hr class="custom-hr">

                <div class="d-grid gap-2">
                    <button type="submit" class="btn custom-btn-primary btn-lg fw-bold"
                            th:text="${isEdit == true} ? 'ìˆ˜ì • ë‚´ìš© ì €ì¥' : 'ì¥ë¹„ ë“±ë¡ ì™„ë£Œ'"></button>
                    <a th:href="${isEdit == true} ? @{/racks} : @{/requests}"
                       class="btn custom-btn-secondary"
                       th:text="${isEdit == true} ? 'ì·¨ì†Œ í›„ Rack ëª©ë¡ìœ¼ë¡œ' : 'ì·¨ì†Œ í›„ ì‹ ì²­ ëª©ë¡ìœ¼ë¡œ'">
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script src="/js/device_form.js"></script>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function() {
        const errorMessage = [[${errorMessage}]];
        const successMessage = [[${successMessage}]];

        // ê³µí†µ í† ìŠ¤íŠ¸ ì„¤ì •
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });

        // ì—ëŸ¬ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ í† ìŠ¤íŠ¸ ë„ìš°ê¸°
        if (errorMessage) {
            Toast.fire({
                icon: 'error',
                title: errorMessage
            });
        }

        // ì„±ê³µ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ í† ìŠ¤íŠ¸ ë„ìš°ê¸°
        if (successMessage) {
            Toast.fire({
                icon: 'success',
                title: successMessage
            });
        }

        // ê¸°ì¡´ì— ì“°ì‹œë˜ í¼ ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ (ì—ëŸ¬ ë©”ì‹œì§€ ì „ë‹¬)
        if (typeof initializeForm === "function") {
            initializeForm(errorMessage);
        }
    });
</script>

</body>
</html>