<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>랙 실장도</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/index.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <link href="/css/rack_view.css" rel="stylesheet">
</head>
<body>

<div th:replace="~{fragments/header :: header}"></div>

<div class="container mt-4 mb-5">

    <div class="d-flex justify-content-between align-items-end mb-3">
        <div>
            <h2 class="mb-0">
                <i class="bi bi-hdd-rack-fill text-secondary"></i>
                Rack : <span class="text-primary fw-bold">[[${rack.rackName}]]</span>
            </h2>
            <p class="text-muted mb-0 ms-1">📍 [[${rack.locationDesc}]]</p>
        </div>
        <div class="d-flex gap-3">
            <a href="/devices" class="btn btn-outline-primary"><i class="bi bi-list-ul"></i> 장비 목록</a>
            <a href="/racks" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> 랙 목록</a>
        </div>
    </div>

    <div class="alert alert-success border-success shadow-sm" th:if="${reqId != null}">
        <div class="d-flex align-items-center">
            <i class="bi bi-magic fs-3 me-3"></i>
            <div>
                <strong>🚀 자리 배정 모드 (승인 처리 중)</strong><br>
                신청서(No.[[${reqId}]]) 처리를 위해, 아래 실장도에서 <strong>[빈 슬롯]</strong>을 클릭하여 장비를 설치하세요.
            </div>
        </div>
    </div>

    <div class="d-flex gap-2 mb-3 justify-content-center">
        <span class="badge rounded-pill bg-light text-dark border"><span class="status-led led-running"></span> 가동중</span>
        <span class="badge rounded-pill bg-light text-dark border"><span class="status-led led-off"></span> OFF</span>
        <span class="vr"></span>

        <span class="badge" style="background-color: #3a473f; color: var(--text-main);">Server</span>
        <span class="badge" style="background-color: #4e4a36; color: var(--text-main);">Network</span>
        <span class="badge" style="background-color: #314449; color: var(--text-main);">Storage</span>
        <span class="badge" style="background-color: #453c51; color: var(--text-main);">UPS</span>
    </div>

    <div class="card rack-container mx-auto" style="max-width: 900px;">
        <div class="card-header rack-header text-center">
            TOP (Fan Unit)
        </div>
        <div class="card-body p-0"> <table class="table table-bordered rack-table mb-0">
            <tbody>
            <tr th:each="slot : ${rackView}">

                <td class="unit-col">[[${slot.unitNum}]]U</td>

                <td th:if="${slot.status == 'FULL'}"
                    th:rowspan="${slot.rowSpan}"
                    class="device-occupied"

                    th:classappend="${slot.type == 'SVR' ? 'type-server' :
                    (slot.type == 'NET' ? 'type-network' :
                    (slot.type == 'STO' ? 'type-storage' :
                    (slot.type == 'UPS' ? 'type-ups' : 'type-etc')))}"

                    th:onclick="|showDeviceModal(${slot.deviceId})|">

                    <div class="d-flex justify-content-between align-items-center px-3">
                        <div class="text-start">
                            <div class="fw-bold">
                                <i class="bi" th:classappend="${slot.type == 'SVR' ? 'bi-server' :
                                                                  (slot.type == 'NET' ? 'bi-router' :
                                                                  (slot.type == 'STO' ? 'bi-hdd-network' : 'bi-battery-charging'))}"></i>
                                [[${slot.deviceName}]]
                            </div>
                            <small class="opacity-75">[[${slot.type}]] / [[${slot.rowSpan}]]U</small>
                        </div>

                        <div class="text-end" title="전원 상태">
                                <span class="status-led"
                                      th:classappend="${slot.runStatus == 'RUNNING'} ? 'led-running' : 'led-off'"></span>
                            <span style="font-size: 0.8em;" th:text="${slot.runStatus == 'RUNNING' ? 'ON' : 'OFF'}"></span>
                        </div>
                    </div>
                </td>

<!--                <td th:if="${slot.status == 'EMPTY'}"-->
<!--                    class="device-empty"-->
<!--                    th:onclick="|location.href='@{/devices/new(rackId=${rack.id}, startUnit=${slot.unitNum}, reqId=${reqId})}'|">-->
<!--                    <i class="bi bi-plus-lg"></i> Empty-->
<!--                </td>-->

                <td th:if="${slot.status == 'EMPTY'}"
                    class="device-empty"
                    th:onclick="|assignRack(${slot.unitNum}, ${rack.id})|"
                    style="cursor: pointer;">
                    <i class="bi bi-plus-lg"></i> Empty
                </td>

            </tr>
            </tbody>
        </table>
        </div>
        <div class="card-footer rack-footer text-center">
            BOTTOM
        </div>
    </div>
</div>

<div class="modal fade" id="deviceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title">🖥️ 장비 상세 정보</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-8">
                        <table class="table table-sm table-borderless">
                            <tr><th class="text-muted" style="width: 30%">제조사</th><td id="modalVendor"></td></tr>
                            <tr><th class="text-muted">모델명</th><td id="modalModel" class="fw-bold text-primary"></td></tr>
                            <tr><th class="text-muted">시리얼</th><td id="modalSerial" style="font-family: monospace;"></td></tr>
                            <tr><th class="text-muted">IP 주소</th><td id="modalIp" style="font-family: monospace;"></td></tr>
                            <tr><th class="text-muted">소비전력</th><td id="modalPower"></td></tr>
                            <tr><th class="text-muted">EMS</th><td id="modalEms"></td></tr>
                            <tr><th class="text-muted">상태</th><td id="modalStatus"></td></tr>
                            <tr><th class="text-muted">입고일</th><td id="modalContractDate"></td></tr>
                            <tr><th class="text-muted">계약만료</th><td id="modalExpiry"></td></tr>
                        </table>
                    </div>
                    <div class="col-4 d-flex flex-column align-items-center justify-content-center border-start bg-light rounded">
                        <div id="qrcode" class="mb-2 bg-white p-1 border"></div>
                        <small class="text-muted fw-bold" style="font-size: 0.7em;">ASSET TAG</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" id="modalPowerBtn" class="btn btn-outline-danger" onclick="togglePower()">
                    <i class="bi bi-power"></i> 전원 제어
                </button>
                <div>
                    <a href="/devices" class="btn btn-info text-white ms-1">
                        <i class="bi bi-list-ul"></i> 목록
                    </a>
                    <a href="#" id="modalEditBtn" class="btn btn-warning"><i class="bi bi-pencil-square"></i> 수정</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/rack_view.js"></script>

</body>
</html>