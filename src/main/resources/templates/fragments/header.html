<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Header Fragment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark navbar-custom" th:fragment="header">
    <div class="container-fluid px-3 px-lg-5">
        <!-- 로고 (왼쪽 정렬) -->
        <a class="navbar-brand brand-logo" href="/">
            <i class="bi bi-stars text-info me-1"></i>StarRoot
        </a>

        <!-- 모바일 토글 버튼 -->
        <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <!-- 메뉴 영역 -->
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto align-items-center">

                <!-- 1-1. 장비 제원 -->
                <li class="nav-item dropdown">
                    <a class="nav-link nav-link-custom dropdown-toggle" href="#" id="navbarDropdown1" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-grid-fill me-1"></i> 장비 제원
                    </a>
                    <ul class="dropdown-menu dropdown-menu-custom" aria-labelledby="navbarDropdown1">
                        <li><a class="dropdown-item dropdown-item-custom" href="/specs/racks"><i class="bi bi-terminal-split me-2 text-info"></i>랙 장비</a></li>
                        <li><a class="dropdown-item dropdown-item-custom" href="/specs/servers"><i class="bi bi-router me-2 text-danger"></i>서버 장비</a></li>
                        <li><a class="dropdown-item dropdown-item-custom" href="/specs/power"><i class="bi bi-plugin me-2 text-warning"></i>배전 장치</a></li>
                        <li><a class="dropdown-item dropdown-item-custom" href="/specs/cooling"><i class="bi bi-thermometer-snow me-2 text-primary"></i>공조 장치</a></li>
                    </ul>
                </li>

                <!-- 1-2. 관리 정보 -->
                <li class="nav-item dropdown">
                    <a class="nav-link nav-link-custom dropdown-toggle" href="#" id="navbarDropdown2" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-grid-fill me-1"></i> 관리 정보
                    </a>
                    <ul class="dropdown-menu dropdown-menu-custom" aria-labelledby="navbarDropdown2">
                        <li><a class="dropdown-item dropdown-item-custom" href="/solutions/racks"><i class="bi bi-hdd-rack me-2 text-info"></i>랙 관리</a></li>
                        <li><a class="dropdown-item dropdown-item-custom" href="/solutions/assets"><i class="bi bi-qr-code-scan me-2 text-danger"></i>실시간 현황 관리</a></li>
                        <li><a class="dropdown-item dropdown-item-custom" href="/solutions/power"><i class="bi bi-lightning-charge me-2 text-warning"></i>전력 모니터링</a></li>
                        <li><a class="dropdown-item dropdown-item-custom" href="/solutions/cooling"><i class="bi bi-snow me-2 text-primary"></i>냉방 시스템</a></li>
                        <li><a class="dropdown-item dropdown-item-custom" href="/solutions/topology"><i class="bi bi-diagram-3 me-2 text-success"></i>네트워크 토폴로지</a></li>
                    </ul>
                </li>

                <!-- 1-3. 이용 약관 및 조건 -->
                <li class="nav-item dropdown">
                    <a class="nav-link nav-link-custom dropdown-toggle" href="#" id="navbarDropdown3" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-grid-fill me-1"></i> 이용 약관
                    </a>
                    <ul class="dropdown-menu dropdown-menu-custom" aria-labelledby="navbarDropdown3">
                        <li><a class="dropdown-item dropdown-item-custom" href="/info/terms"><i class="bi bi-info-square me-2 text-info"></i>이용 약관</a></li>
                        <li><a class="dropdown-item dropdown-item-custom" href="/info/legal"><i class="bi bi-journal-text me-2 text-danger"></i>법적 고지</a></li>
                        <li><a class="dropdown-item dropdown-item-custom" href="/info/privacy"><i class="bi bi-person-check me-2 text-warning"></i>개인정보처리방침</a></li>
                        <li><a class="dropdown-item dropdown-item-custom" href="/info/contact"><i class="bi bi-headset me-2 text-primary"></i>고객센터</a></li>
                    </ul>
                </li>

                <!-- 2. 장비 (USER 권한 이상) -->
                <li class="nav-item dropdown" sec:authorize="hasRole('USER')">
                    <a class="nav-link nav-link-custom dropdown-toggle" href="#" id="navbarDropdown4" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-hdd-stack me-2"></i> 장비
                    </a>
                    <ul class="dropdown-menu dropdown-menu-custom" aria-labelledby="navbarDropdown4">
                        <li sec:authorize="!hasRole('ADMIN')">
                            <a class="dropdown-item dropdown-item-custom" href="/requests/new">
                                <i class="bi-plus-circle-dotted me-2 text-success"></i>장비 입고 신청
                            </a>
                        </li>
                        <li sec:authorize="!hasRole('ADMIN')">
                            <a class="dropdown-item dropdown-item-custom" href="/requests/my">
                                <i class="bi-clock-history me-2 text-success"></i>나의 입고 이력
                            </a>
                        </li>
                        <li sec:authorize="!hasRole('ADMIN')">
                            <a class="dropdown-item dropdown-item-custom" href="/devices/my">
                                <i class="bi-clock-history me-2 text-success"></i>입고 장비 현황
                            </a>
                        </li>
                    </ul>
                </li>

                <!-- 3. 사용자 정보 (비로그인 시 숨김, 로그인 시 노출) -->
                <li class="nav-item dropdown" sec:authorize="isAuthenticated()">
                    <a class="nav-link nav-link-custom dropdown-toggle d-flex align-items-center position-relative"
                       href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">

                        <th:block th:if="${#authentication.principal instanceof T(com.example.KHTeam3DCIM.security.CustomUserDetails)}">
                            <img th:if="${#authentication.principal.profileImage != null}"
                                 th:src="@{/uploads/{img}(img=${#authentication.principal.profileImage})}"
                                 class="rounded-circle me-2"
                                 style="width: 35px; height: 35px; object-fit: cover; border: 2px solid rgba(255,255,255,0.2); box-shadow: 0 0 10px rgba(0,0,0,0.3);"
                                 alt="Profile">

                            <div th:unless="${#authentication.principal.profileImage != null}"
                                 class="rounded-circle me-2 d-flex align-items-center justify-content-center"
                                 style="width: 35px; height: 35px;
                 background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
                 border: 2px solid var(--accent-cyan);
                 box-shadow: 0 0 8px rgba(6, 182, 212, 0.4);">
                                <i class="bi bi-person-fill" style="font-size: 1.2rem; color: var(--accent-cyan);"></i>
                            </div>
                        </th:block>

                        <th:block th:unless="${#authentication.principal instanceof T(com.example.KHTeam3DCIM.security.CustomUserDetails)}">
                            <div class="rounded-circle me-2 d-flex align-items-center justify-content-center"
                                 style="width: 35px; height: 35px; background: #334155; border: 1px solid #475569;">
                                <i class="bi bi-person-fill text-white"></i>
                            </div>
                        </th:block>

                        <span class="fw-bold"
                              style="text-shadow: 0 0 10px rgba(255,255,255,0.2);"
                              th:text="${#authentication.principal instanceof T(com.example.KHTeam3DCIM.security.CustomUserDetails)
                                        ? #authentication.principal.name
                                        : #authentication.principal.username}">User</span> 님

                        <i class="bi bi-circle-fill ms-2 header-alert-icon"
                           th:if="${globalPendingCount != null and globalPendingCount > 0}"
                           title="승인 대기중인 요청이 있습니다!"></i>
                    </a>

                    <ul class="dropdown-menu dropdown-menu-custom dropdown-menu-end" aria-labelledby="userDropdown">
                        <li sec:authorize="hasRole('ADMIN')">
                            <a class="dropdown-item dropdown-item-custom" th:href="@{/admin}">
                                <i class="bi bi-house-door me-2 text-danger"></i>
                                관리자 페이지

                                <span th:if="${globalPendingCount != null and globalPendingCount > 0}"
                                      class="badge bg-danger ms-2 header-alert-icon text-white"
                                      style="font-size:0.7rem;">
                    <i class="bi bi-bell-fill"></i> [[${globalPendingCount}]]
                </span>
                            </a>
                        </li>

                        <li sec:authorize="hasRole('USER')">
                            <a class="dropdown-item dropdown-item-custom" href="/members/my">
                                <i class="bi bi-gear me-2 text-info"></i> 내 정보
                            </a>
                        </li>
                        <li><hr class="dropdown-divider" style="border-color: rgba(255,255,255,0.1);"></li>
                        <li>
                            <a class="dropdown-item dropdown-item-custom" th:href="@{/members/logout}">
                                <i class="bi bi-box-arrow-right me-2 text-secondary"></i> 로그아웃
                            </a>
                        </li>
                    </ul>
                </li>

                <!-- 4. 로그인/회원가입 (비로그인 시 노출) -->
                <li class="nav-item" sec:authorize="!isAuthenticated()">
                    <a class="nav-link nav-link-custom" href="/members/signup">
                        <i class="bi bi-person-plus me-1"></i> 회원가입
                    </a>
                </li>
                <li class="nav-item" sec:authorize="!isAuthenticated()">
                    <a class="nav-link nav-link-custom" href="/members/login">
                        <i class="bi bi-box-arrow-in-right me-1"></i> 로그인
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // 1. 현재 주소(URL) 가져오기
            const currentPath = window.location.pathname;

            // 2. 모든 내비게이션 링크 가져오기
            const navLinks = document.querySelectorAll('.navbar-nav .nav-link, .dropdown-item');

            navLinks.forEach(link => {
                const linkPath = link.getAttribute('href');
                if (linkPath === currentPath || (linkPath !== '/' && currentPath.startsWith(linkPath))) {
                    link.classList.add('active');
                    if (link.classList.contains('dropdown-item')) {
                        const parentDropdown = link.closest('.nav-item.dropdown');
                        if (parentDropdown) {
                            const parentLink = parentDropdown.querySelector('.nav-link.dropdown-toggle');
                            if (parentLink) {
                                parentLink.classList.add('active');
                            }
                        }
                    }
                }
            });
        });
    </script>
    </nav>
</body>
</html>