<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Header Fragment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark navbar-custom" th:fragment="header">
    <div class="container-fluid px-3 px-lg-5">
        <!-- 1. 로고 영역 -->
        <a class="navbar-brand brand-logo" href="/">
            <i class="bi bi-stars text-info me-1"></i>StarRoot
        </a>

        <!-- 모바일 화면용 토글 버튼 (Bootstrap Component) -->
        <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <!-- 2. 네비게이션 메뉴 영역 -->
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto align-items-center">

                <!-- [메뉴 그룹 1] 장비 제원 (누구나 접근 가능) -->
                <li class="nav-item dropdown">
                    <a class="nav-link nav-link-custom dropdown-toggle" href="#" id="navbarDropdown1" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-grid-fill me-1"></i> 장비 제원
                    </a>
                    <ul class="dropdown-menu dropdown-menu-custom" aria-labelledby="navbarDropdown1">
                        <li><a class="dropdown-item dropdown-item-custom" href="/specs/racks"><i class="bi bi-terminal-split me-2 text-info"></i>랙 장비</a></li>
                        <li><a class="dropdown-item dropdown-item-custom" href="/specs/servers"><i class="bi bi-router me-2 text-danger"></i>서버 장비</a></li>
                        <li><a class="dropdown-item dropdown-item-custom" href="/specs/power"><i class="bi bi-plugin me-2 text-warning"></i>배전 장치</a></li>
                        <li><a class="dropdown-item dropdown-item-custom" href="/specs/cooling"><i class="bi bi-thermometer-snow me-2 text-primary"></i>공조 장치</a></li>
                    </ul>
                </li>

                <!-- [메뉴 그룹 2] 관리 정보 (누구나 접근 가능) -->
                <li class="nav-item dropdown">
                    <a class="nav-link nav-link-custom dropdown-toggle" href="#" id="navbarDropdown2" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-grid-fill me-1"></i> 관리 정보
                    </a>
                    <ul class="dropdown-menu dropdown-menu-custom" aria-labelledby="navbarDropdown2">
                        <li><a class="dropdown-item dropdown-item-custom" href="/solutions/racks"><i class="bi bi-hdd-rack me-2 text-info"></i>랙 관리</a></li>
                        <li><a class="dropdown-item dropdown-item-custom" href="/solutions/assets"><i class="bi bi-qr-code-scan me-2 text-danger"></i>실시간 현황 관리</a></li>
                        <li><a class="dropdown-item dropdown-item-custom" href="/solutions/power"><i class="bi bi-lightning-charge me-2 text-warning"></i>전력 모니터링</a></li>
                        <li><a class="dropdown-item dropdown-item-custom" href="/solutions/cooling"><i class="bi bi-snow me-2 text-primary"></i>냉방 시스템</a></li>
                        <li><a class="dropdown-item dropdown-item-custom" href="/solutions/topology"><i class="bi bi-diagram-3 me-2 text-success"></i>네트워크 토폴로지</a></li>
                    </ul>
                </li>

                <!-- [메뉴 그룹 3] 이용 약관 -->
                <li class="nav-item dropdown">
                    <a class="nav-link nav-link-custom dropdown-toggle" href="#" id="navbarDropdown3" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-grid-fill me-1"></i> 이용 약관
                    </a>
                    <ul class="dropdown-menu dropdown-menu-custom" aria-labelledby="navbarDropdown3">
                        <li><a class="dropdown-item dropdown-item-custom" href="/info/terms"><i class="bi bi-info-square me-2 text-info"></i>이용 약관</a></li>
                        <li><a class="dropdown-item dropdown-item-custom" href="/info/legal"><i class="bi bi-journal-text me-2 text-danger"></i>법적 고지</a></li>
                        <li><a class="dropdown-item dropdown-item-custom" href="/info/privacy"><i class="bi bi-person-check me-2 text-warning"></i>개인정보처리방침</a></li>
                        <li><a class="dropdown-item dropdown-item-custom" href="/info/contact"><i class="bi bi-headset me-2 text-primary"></i>고객센터</a></li>
                    </ul>
                </li>

                <!--
                    [권한 제어 포인트 1: 장비 메뉴]
                    sec:authorize="hasRole('USER')" -> 로그인한 '일반 유저' 이상 권한 소유자에게만 이 메뉴를 보여줍니다.
                    비로그인 사용자에게는 이 <li> 태그 자체가 렌더링되지 않습니다.

                    [기술 설명] Server-Side RBAC (Role-Based Access Control)
                    - 클라이언트(브라우저)에서 display:none으로 숨기는 것이 아니라, 서버에서 아예 HTML 코드를 생성하지 않으므로
                      개발자 도구로 소스를 열어봐도 메뉴가 보이지 않아 보안성이 높습니다.
                -->
                <li class="nav-item dropdown" sec:authorize="hasRole('USER')">
                    <a class="nav-link nav-link-custom dropdown-toggle" href="#" id="navbarDropdown4" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-hdd-stack me-2"></i> 장비
                    </a>
                    <ul class="dropdown-menu dropdown-menu-custom" aria-labelledby="navbarDropdown4">
                        <!--
                             [권한 제어 포인트 2: 관리자 제외]
                             sec:authorize="!hasRole('ADMIN')" -> 관리자는 '신청'하는 사람이 아니므로 숨깁니다.
                             오직 일반 사용자(USER)만 입고 신청 메뉴를 볼 수 있습니다.

                             [기술 설명] 부정 논리 연산자(!) 활용
                             - 특정 권한을 '가진' 사람이 아니라 '가지지 않은' 사람을 타겟팅하여 정교한 UI 제어가 가능합니다.
                        -->
                        <li sec:authorize="!hasRole('ADMIN')">
                            <a class="dropdown-item dropdown-item-custom" href="/requests/new">
                                <i class="bi-plus-circle-dotted me-2 text-success"></i>장비 입고 신청
                            </a>
                        </li>
                        <li sec:authorize="!hasRole('ADMIN')">
                            <a class="dropdown-item dropdown-item-custom" href="/requests/my">
                                <i class="bi-clock-history me-2 text-success"></i>나의 입고 이력
                            </a>
                        </li>
                        <li sec:authorize="!hasRole('ADMIN')">
                            <a class="dropdown-item dropdown-item-custom" href="/devices/my">
                                <i class="bi-clock-history me-2 text-success"></i>입고 장비 현황
                            </a>
                        </li>
                    </ul>
                </li>

                <!--
                    [권한 제어 포인트 3: 사용자 정보]
                    sec:authorize="isAuthenticated()" -> 로그인 상태일 때만 보이는 프로필 영역입니다.
                -->
                <li class="nav-item dropdown" sec:authorize="isAuthenticated()">
                    <a class="nav-link nav-link-custom dropdown-toggle d-flex align-items-center position-relative"
                       href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">

                        <!-- [Logic] 프로필 이미지 처리 -->
                        <!--
                            [기술 설명] Java Type Check in Thymeleaf (T operator)
                            - 로그인한 사용자 객체(#authentication.principal)가 우리가 정의한 CustomUserDetails 클래스의 인스턴스인지 확인합니다.
                            - 이를 통해 일반 로그인, 소셜 로그인 등 다양한 인증 방식에서 발생할 수 있는 캐스팅 에러를 방지합니다.
                        -->
                        <th:block th:if="${#authentication.principal instanceof T(com.example.KHTeam3DCIM.security.CustomUserDetails)}">

                            <!-- 2-A. 사용자가 업로드한 이미지가 있는 경우 -->
                            <!--
                                [기술 설명] Dynamic URL Generation (@{...})
                                - th:src="@{/uploads/{img}(img=${...})}"
                                - 경로 변수({img})에 실제 파일명을 동적으로 할당하여 이미지 경로를 생성합니다.
                            -->
                            <img th:if="${#authentication.principal.profileImage != null}"
                                 th:src="@{/uploads/{img}(img=${#authentication.principal.profileImage})}"
                                 class="rounded-circle me-2"
                                 style="width: 35px; height: 35px; object-fit: cover; border: 2px solid rgba(255,255,255,0.2); box-shadow: 0 0 10px rgba(0,0,0,0.3);"
                                 alt="Profile">

                            <!-- 2-B. 이미지가 없는 경우 (Fallback UI) -->
                            <div th:unless="${#authentication.principal.profileImage != null}"
                                 class="rounded-circle me-2 d-flex align-items-center justify-content-center"
                                 style="width: 35px; height: 35px;
                                        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
                                        border: 2px solid var(--accent-cyan);
                                        box-shadow: 0 0 8px rgba(6, 182, 212, 0.4);">
                                <i class="bi bi-person-fill" style="font-size: 1.2rem; color: var(--accent-cyan);"></i>
                            </div>
                        </th:block>

                        <!-- 예외 처리: 커스텀 유저 객체가 아닐 경우 -->
                        <th:block th:unless="${#authentication.principal instanceof T(com.example.KHTeam3DCIM.security.CustomUserDetails)}">
                            <div class="rounded-circle me-2 d-flex align-items-center justify-content-center"
                                 style="width: 35px; height: 35px; background: #334155; border: 1px solid #475569;">
                                <i class="bi bi-person-fill text-white"></i>
                            </div>
                        </th:block>

                        <!-- 사용자 이름 출력 -->
                        <span class="fw-bold"
                              style="text-shadow: 0 0 10px rgba(255,255,255,0.2);"
                              th:text="${#authentication.principal instanceof T(com.example.KHTeam3DCIM.security.CustomUserDetails)
                                        ? #authentication.principal.name
                                        : #authentication.principal.username}">User</span> 님

                        <!--
                            [알림 시스템 1: 빨간 점(Red Dot)]
                            관리자에게 승인 대기중인 요청이 있을 때만 빨간 점을 표시합니다.
                            ${globalPendingCount} > 0 조건이 참일 때만 렌더링됩니다.

                            [기술 설명] Conditional Rendering (th:if)
                            - 단순히 숨기는(hidden) 것이 아니라, 조건이 거짓이면 DOM 트리 자체에 요소를 추가하지 않아 렌더링 성능을 최적화합니다.
                        -->
                        <i class="bi bi-circle-fill ms-2 header-alert-icon"
                           th:if="${globalPendingCount != null and globalPendingCount > 0}"
                           title="승인 대기중인 요청이 있습니다!"></i>
                    </a>

                    <!-- 드롭다운 메뉴 내부 -->
                    <ul class="dropdown-menu dropdown-menu-custom dropdown-menu-end" aria-labelledby="userDropdown">

                        <!-- [권한 제어 포인트 4: 관리자 전용] -->
                        <li sec:authorize="hasRole('ADMIN')">
                            <a class="dropdown-item dropdown-item-custom" th:href="@{/admin}">
                                <i class="bi bi-house-door me-2 text-danger"></i>
                                관리자 페이지

                                <!-- [알림 시스템 2: 숫자 배지] -->
                                <!--
                                    [기술 설명] Inline Expressions ([[...]])
                                    - 자바 컨트롤러에서 전달받은 모델 데이터(globalPendingCount)를 HTML 텍스트 사이에 자연스럽게 삽입합니다.
                                -->
                                <span th:if="${globalPendingCount != null and globalPendingCount > 0}"
                                      class="badge bg-danger ms-2 header-alert-icon text-white"
                                      style="font-size:0.7rem;">
                                    <i class="bi bi-bell-fill"></i> [[${globalPendingCount}]]
                                </span>
                            </a>
                        </li>

                        <!-- 일반 유저 메뉴 -->
                        <li sec:authorize="hasRole('USER')">
                            <a class="dropdown-item dropdown-item-custom" href="/members/my">
                                <i class="bi bi-gear me-2 text-info"></i> 내 정보
                            </a>
                        </li>
                        <li><hr class="dropdown-divider" style="border-color: rgba(255,255,255,0.1);"></li>

                        <!-- 로그아웃 (누구나 접근 가능하지만 로그인 상태에서만 보임) -->
                        <li>
                            <a class="dropdown-item dropdown-item-custom" th:href="@{/members/logout}">
                                <i class="bi bi-box-arrow-right me-2 text-secondary"></i> 로그아웃
                            </a>
                        </li>
                    </ul>
                </li>

                <!--
                    [권한 제어 포인트 5: 비로그인 상태]
                    sec:authorize="!isAuthenticated()" -> 로그인하지 않은 사람에게만 회원가입/로그인 버튼을 보여줍니다.
                -->
                <li class="nav-item" sec:authorize="!isAuthenticated()">
                    <a class="nav-link nav-link-custom" href="/members/signup">
                        <i class="bi bi-person-plus me-1"></i> 회원가입
                    </a>
                </li>
                <li class="nav-item" sec:authorize="!isAuthenticated()">
                    <a class="nav-link nav-link-custom" href="/members/login">
                        <i class="bi bi-box-arrow-in-right me-1"></i> 로그인
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!--
        [UX Script: 현재 페이지 활성화]
        사용자가 현재 보고 있는 페이지의 메뉴에 'Active' 클래스를 추가하여
        글자색을 시안(Cyan) 색으로 밝혀주는 로직입니다.
    -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // [기술 설명] DOM API & Location Object
            // 1. window.location.pathname: 현재 브라우저의 URL 경로를 가져옵니다.
            const currentPath = window.location.pathname;

            // 2. querySelectorAll: 문서 내의 모든 네비게이션 링크 요소를 선택합니다.
            const navLinks = document.querySelectorAll('.navbar-nav .nav-link, .dropdown-item');

            navLinks.forEach(link => {
                const linkPath = link.getAttribute('href');

                // [기술 설명] Path Matching Logic
                // 현재 경로와 링크 경로가 일치하거나(Exact match), 하위 경로인 경우(Prefix match) 활성화합니다.
                if (linkPath === currentPath || (linkPath !== '/' && currentPath.startsWith(linkPath))) {

                    // classList.add: CSS 클래스를 동적으로 추가하여 스타일을 변경합니다.
                    link.classList.add('active');

                    // [기술 설명] DOM Traversal (closest)
                    // 하위 메뉴(드롭다운 아이템)가 선택되었을 때, 상위 부모 메뉴(드롭다운 토글 버튼)도 함께 활성화하여
                    // 사용자가 어떤 상위 카테고리에 있는지 인지하도록 돕습니다.
                    if (link.classList.contains('dropdown-item')) {
                        const parentDropdown = link.closest('.nav-item.dropdown');
                        if (parentDropdown) {
                            const parentLink = parentDropdown.querySelector('.nav-link.dropdown-toggle');
                            if (parentLink) {
                                parentLink.classList.add('active');
                            }
                        }
                    }
                }
            });
        });
    </script>
</nav>
</body>
</html>