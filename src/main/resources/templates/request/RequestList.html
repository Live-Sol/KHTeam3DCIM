<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ìš”ì²­ ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" th:href="@{/css/sidebar.css}">
    <link rel="stylesheet" th:href="@{/css/requests.css}">

    <style>
        /* ë°˜ë ¤ ëª¨ë‹¬ ì „ìš© ë‹¤í¬ í…Œë§ˆ ìŠ¤íƒ€ì¼ */
        #rejectModal .modal-content {
            background-color: #212529; /* ì–´ë‘ìš´ ë°°ê²½ìƒ‰ (Bootstrap ë‹¤í¬ í…Œë§ˆ ê¸°ì¤€) */
            color: #ffffff;            /* í°ìƒ‰ í…ìŠ¤íŠ¸ */
            border: 1px solid #495057; /* í…Œë‘ë¦¬ ìƒ‰ìƒ */
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.7); /* ê·¸ë¦¼ì íš¨ê³¼ */
        }

        #rejectModal .modal-header {
            border-bottom: 1px solid #373b3e; /* í—¤ë” êµ¬ë¶„ì„  */
        }

        #rejectModal .modal-footer {
            border-top: 1px solid #373b3e; /* í‘¸í„° êµ¬ë¶„ì„  */
        }

        #rejectModal .modal-title {
            font-weight: 700;
            color: #ff6b6b; /* ì œëª©ì— ë¶‰ì€ìƒ‰ í¬ì¸íŠ¸ (ë°˜ë ¤ ëŠë‚Œ) */
        }

        /* ë‹«ê¸° ë²„íŠ¼(X) í°ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
        #rejectModal .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }

        /* í…ìŠ¤íŠ¸ ì…ë ¥ì°½ ë‹¤í¬ ìŠ¤íƒ€ì¼ */
        #rejectModal textarea.form-control {
            background-color: #2c3034;
            color: #e0e0e0;
            border: 1px solid #495057;
        }

        #rejectModal textarea.form-control:focus {
            background-color: #2c3034;
            color: #ffffff;
            border-color: #ff6b6b; /* í¬ì»¤ìŠ¤ ì‹œ ë¶‰ì€ í…Œë‘ë¦¬ */
            box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
        }

        #rejectModal textarea.form-control::placeholder {
            color: #adb5bd; /* í”Œë ˆì´ìŠ¤í™€ë” ìƒ‰ìƒ */
        }
    </style>
</head>
<body>

<div th:replace="~{fragments/header :: header}"></div>

<div class="d-flex">
    <div th:replace="fragments/sidebar :: sidebar"></div>

    <main class="main-content flex-grow-1">

        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <span th:text="${errorMessage}">ì—ëŸ¬ ë©”ì‹œì§€ ë‚´ìš©</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            <span th:text="${successMessage}">ì„±ê³µ ë©”ì‹œì§€ ë‚´ìš©</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <h2 class="mb-4 text-white border-bottom pb-2">
            <i class="bi bi-bell-fill me-2"></i> ì…ê³  ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡
        </h2>

        <div class="d-flex justify-content-between mb-4 align-items-center">

            <form action="/requests" method="get" class="d-flex gap-2" style="flex-grow: 1; max-width: 800px;">

                <select name="emsStatus" class="form-select custom-select" style="width: 180px;" onchange="this.form.submit()">
                    <option value="ALL" th:selected="${paramEmsStatus == 'ALL'}">âš¡ EMS ì „ì²´</option>
                    <option value="ON" th:selected="${paramEmsStatus == 'ON'}">EMS ì‹ ì²­ (ON)</option>
                    <option value="OFF" th:selected="${paramEmsStatus == 'OFF'}">EMS ë¯¸ì‹ ì²­ (OFF)</option>
                </select>

                <input type="text" name="keyword" class="form-control custom-form-control"
                       placeholder="íšŒì‚¬ëª… ë˜ëŠ” ë‹´ë‹¹ìëª… ê²€ìƒ‰..."
                       th:value="${paramKeyword}">

                <button type="submit" class="btn custom-btn-primary text-nowrap">ğŸ” ê²€ìƒ‰</button>

                <a href="/requests" class="btn custom-btn-secondary text-nowrap" title="ê²€ìƒ‰ ì¡°ê±´ ì´ˆê¸°í™”">
                    <i class="bi bi-arrow-counterclockwise"></i>
                </a>
            </form>
        </div>


        <div class="text-center p-5 text-secondary" th:if="${requests.isEmpty()}">
            <i class="bi bi-inbox fs-1 d-block mb-3"></i>
            <h5>í˜„ì¬ ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</h5>
            <p>ìƒˆë¡œìš´ ì…ê³  ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>

        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">

            <div class="col" th:each="req : ${requests}">

                <div class="card custom-card-warning h-100 shadow-sm">
                    <div class="card-header custom-card-header-warning d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-dark custom-badge me-1">ëŒ€ê¸° ì¤‘</span>
                            <strong>No. [[${req.id}]]</strong>
                            <!-- ìš”ì²­ í˜ì´ì§€ì—ì„œ íšŒì› ìƒì„¸ ë³´ê¸° -->
                            <a th:href="@{/requests/members/{memberId}(memberId=${req.memberId})}" class="text-info">
                                <i class="bi bi-search"></i> [[${req.memberId}]]
                            </a>
                        </div>
                        <small class="text-white-50">ì‹ ì²­ì¼: [[${#temporals.format(req.reqDate, 'yyyy-MM-dd')}]]</small>
                    </div>

                    <div class="card-body">
                        <h5 class="card-title fw-bold">íšŒì‚¬ëª…: [[${req.companyName}]] <small class="text-white-50 fs-6">(íšŒì‚¬ë²ˆí˜¸: [[${req.companyPhone}]])</small></h5>
                        <h5 class="card-title fw-bold">ë‹´ë‹¹ì: [[${req.userName}]] <small class="text-white-50 fs-6">(ì—°ë½ì²˜: [[${req.contact}]])</small></h5>

                        <hr class="custom-hr">

                        <p class="card-text mb-1"><strong>ì œì¡°ì‚¬/ëª¨ë¸ëª…:</strong> [[${req.vendor}]]/[[${req.modelName}]] </p>

                        <p class="card-text mb-1"><strong>ì¥ë¹„ ë†’ì´:</strong> <span class="text-warning fw-bold">[[${req.heightUnit}]] (U)</span></p>

                        <p class="card-text mb-1"><strong>ì¥ë¹„ ì†Œë¹„ì „ë ¥:</strong> <span class="text-danger fw-bold">[[${req.powerWatt}]] (W)</span></p>

                        <p class="card-text mb-1"><strong>EMS(ì‹ ì²­ì—¬ë¶€):</strong>
                            <span th:if="${req.emsStatus == 'ON'}" class="badge custom-badge-success">EMS ì‹ ì²­</span>
                            <span th:unless="${req.emsStatus == 'ON'}" class="badge custom-badge-secondary">EMS ë¯¸ì‹ ì²­</span>
                        </p>

                        <p class="card-text mb-1"><strong>ì…ê³  í¬ë§ì¼:</strong> [[${req.startDate}]] <span class="text-white-50">(ê³„ì•½ ê¸°ê°„: [[${req.termMonth}]]ê°œì›”)</span></p>

                        <hr class="custom-hr">

                        <p class="card-text mb-1 mt-3"><strong>ì…ê³  ëª©ì :</strong></p>
                        <p class="card-text custom-purpose-box p-2 rounded">[[${req.purpose}]]</p>

                        <div class="d-flex gap-2 mt-3">
                            <a th:href="@{/racks(reqId=${req.id})}" class="btn custom-btn-primary flex-grow-1 approve-btn">
                                <i class="bi bi-check-lg"></i>
                                ìŠ¹ì¸(ìë¦¬ ë°°ì •)
                            </a>

                            <!-- ë°˜ë ¤ ëª¨ë‹¬ íŠ¸ë¦¬ê±° ë²„íŠ¼ -->
                            <button type="button"
                                    class="btn custom-btn-outline-danger flex-grow-1"
                                    data-bs-toggle="modal"
                                    data-bs-target="#rejectModal"
                                    th:data-id="${req.id}">
                                <i class="bi bi-x-circle me-1"></i>
                                ë°˜ë ¤
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- ë°˜ë ¤ ëª¨ë‹¬ -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-octagon-fill me-2"></i>ì‹ ì²­ ë°˜ë ¤ ì‚¬ìœ  ì…ë ¥
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form id="rejectForm" method="post">
                <div class="modal-body">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

                    <div class="mb-3">
                        <label class="form-label text-light">ë°˜ë ¤ ì‚¬ìœ </label>
                        <textarea name="rejectReason" class="form-control" rows="5"
                                  placeholder="êµ¬ì²´ì ì¸ ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì„ íƒì‚¬í•­)"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-danger">ë°˜ë ¤ í™•ì •</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function() {

        // 1. Toast ì•Œë¦¼ ì„¤ì •
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });

        // 2. ì„œë²„ ë©”ì‹œì§€ í™•ì¸ ë° Toast ì¶œë ¥
        const successMessage = [[${successMessage}]];
        const errorMessage = [[${errorMessage}]];

        if (successMessage) Toast.fire({ icon: 'success', title: successMessage });
        if (errorMessage) Toast.fire({ icon: 'error', title: errorMessage });


        // ---------------------------------------------------------
        // [ê¸°ëŠ¥ 1] ë°˜ë ¤(Reject) ê´€ë ¨ ë¡œì§ (ëª¨ë‹¬ + AJAX)
        // ---------------------------------------------------------
        const rejectModal = document.getElementById('rejectModal');
        const rejectForm = document.getElementById('rejectForm');

        if (rejectModal) {
            rejectModal.addEventListener('show.bs.modal', event => {
                const button = event.relatedTarget;
                const reqId = button.getAttribute('data-id');
                rejectForm.setAttribute('action', `/requests/${reqId}/reject`);
            });
        }

        if (rejectForm) {
            rejectForm.addEventListener('submit', function(e) {
                e.preventDefault();

                Swal.fire({
                    title: 'ë°˜ë ¤ í™•ì •',
                    text: "ì •ë§ ì´ ì‹ ì²­ì„ ë°˜ë ¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'ë„¤, ë°˜ë ¤í•©ë‹ˆë‹¤',
                    cancelButtonText: 'ì·¨ì†Œ'
                }).then((result) => {
                    if (result.isConfirmed) {
                        submitRejectAjax(this);
                    }
                });
            });
        }

        function submitRejectAjax(form) {
            const url = form.getAttribute('action');
            const formData = new FormData(form);
            const csrfToken = document.querySelector('input[name="_csrf"]').value;

            const submitBtn = form.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>ì²˜ë¦¬ ì¤‘...`;

            fetch(url, {
                method: 'POST',
                headers: { 'X-CSRF-TOKEN': csrfToken },
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    const modalInstance = bootstrap.Modal.getInstance(rejectModal);
                    modalInstance.hide();
                    Toast.fire({ icon: 'success', title: 'ë°˜ë ¤ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' }).then(() => location.reload());
                } else {
                    throw new Error('Server Error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                Swal.fire({ icon: 'error', title: 'ì²˜ë¦¬ ì‹¤íŒ¨', text: 'ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
            });
        }


        // ---------------------------------------------------------
        // [ê¸°ëŠ¥ 2] ìŠ¹ì¸(Approve) ë²„íŠ¼ ì•ˆì „ì¥ì¹˜
        // ---------------------------------------------------------
        const approveBtns = document.querySelectorAll('.approve-btn');

        approveBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault(); // ë°”ë¡œ ì´ë™í•˜ëŠ” ê²ƒì„ ë§‰ìŒ

                const targetUrl = this.getAttribute('href'); // ì´ë™í•˜ë ¤ë˜ ì£¼ì†Œ ì €ì¥

                Swal.fire({
                    title: 'ì…ê³  ìŠ¹ì¸ ì§„í–‰',
                    text: "í•´ë‹¹ ìš”ì²­ì„ ìŠ¹ì¸í•˜ê³  ë™(Rack) ë°°ì • ë‹¨ê³„ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                    icon: 'question', // ë¬¼ìŒí‘œ ì•„ì´ì½˜
                    showCancelButton: true,
                    confirmButtonColor: '#0d6efd',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'ë„¤, ì§„í–‰í•©ë‹ˆë‹¤',
                    cancelButtonText: 'ì·¨ì†Œ'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // ì‚¬ìš©ìê°€ í™•ì¸ì„ ëˆ„ë¥´ë©´ í˜ì´ì§€ ì´ë™
                        window.location.href = targetUrl;
                    }
                });
            });
        });

    });
</script>
</body>
</html>