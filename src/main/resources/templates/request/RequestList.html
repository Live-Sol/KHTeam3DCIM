<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>요청 관리</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" th:href="@{/css/sidebar.css}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">

    <style>
        /* 반려 모달 전용 다크 테마 스타일 */
        #rejectModal .modal-content {
            background-color: #212529;
            color: #ffffff;
            border: 1px solid #495057;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
        }

        #rejectModal .modal-header {
            border-bottom: 1px solid #373b3e;
        }

        #rejectModal .modal-footer {
            border-top: 1px solid #373b3e;
        }

        #rejectModal .modal-title {
            font-weight: 700;
            color: #ff6b6b;
        }

        #rejectModal .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }

        #rejectModal textarea.form-control {
            background-color: #2c3034;
            color: #e0e0e0;
            border: 1px solid #495057;
        }

        #rejectModal textarea.form-control:focus {
            background-color: #2c3034;
            color: #ffffff;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
        }

        #rejectModal textarea.form-control::placeholder {
            color: #adb5bd;
        }
    </style>
</head>
<body>

<div th:replace="~{fragments/header :: header}"></div>

<div class="d-flex">
    <div th:replace="fragments/sidebar :: sidebar"></div>

    <main class="main-content flex-grow-1">

        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <span th:text="${errorMessage}">에러 메시지 내용</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            <span th:text="${successMessage}">성공 메시지 내용</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <h2 class="mb-4 text-white border-bottom pb-2">
            <i class="bi bi-bell-fill me-2 text-warning"></i>입고 승인 관리
            <span class="text-white-50 fs-6 ms-2 fw-normal">(Requests Management)</span>
        </h2>

        <div class="d-flex justify-content-between mb-4 align-items-center">

            <form action="/requests" method="get" class="d-flex gap-2" style="flex-grow: 1; max-width: 800px;">

                <select name="emsStatus" class="form-select custom-select" style="width: 180px;" onchange="this.form.submit()">
                    <option value="ALL" th:selected="${paramEmsStatus == 'ALL'}">⚡ EMS 전체</option>
                    <option value="ON" th:selected="${paramEmsStatus == 'ON'}">EMS 신청 (ON)</option>
                    <option value="OFF" th:selected="${paramEmsStatus == 'OFF'}">EMS 미신청 (OFF)</option>
                </select>

                <input type="text" name="keyword" class="form-control custom-form-control"
                       placeholder="회사명 또는 담당자명 검색..."
                       th:value="${paramKeyword}">

                <button type="submit" class="btn custom-btn-primary text-nowrap">
                    <i class="bi bi-search"></i> 검색
                </button>

                <a href="/requests" class="btn custom-btn-secondary text-nowrap" title="검색 조건 초기화">
                    <i class="bi bi-arrow-clockwise"></i> 초기화
                </a>
            </form>
        </div>


        <div class="text-center p-5 text-secondary" th:if="${requests.isEmpty()}">
            <i class="bi bi-inbox fs-1 d-block mb-3"></i>
            <h5>현재 대기 중인 신청 내역이 없습니다.</h5>
            <p>새로운 입고 요청이 들어오면 이곳에 표시됩니다.</p>
        </div>

        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">

            <div class="col" th:each="req : ${requests}">

                <div class="card h-100 shadow-sm">
                    <div class="card-header custom-card-header-warning d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-dark custom-badge me-1">대기 중</span>
                            <strong>No. [[${req.id}]]</strong>

                            <a href="#"
                               class="text-decoration-none"
                               th:classappend="${req.deleted} ? 'text-danger fw-bold' : 'text-info'"
                               data-bs-toggle="modal"
                               data-bs-target="#memberDetailModal"
                               th:data-id="${req.memberId}"
                               th:data-name="${req.userName}"
                               th:data-company="${req.companyName}"
                               th:data-cphone="${req.companyPhone}"
                               th:data-contact="${req.contact}"
                               th:data-email="${req.email}"
                               th:data-role="${req.role}"
                               th:data-is-deleted="${req.deleted}"> <i th:class="${req.deleted} ? 'bi bi-person-x-fill me-1' : 'bi bi-search me-1'"></i>
                                [[${req.memberId}]]
                                <span th:if="${req.deleted}" class="badge bg-danger ms-1" style="font-size: 0.7em;">탈퇴</span>
                            </a>
                        </div>
                        <small class="text-white-50">신청일: [[${#temporals.format(req.reqDate, 'yyyy-MM-dd')}]]</small>
                    </div>

                    <div class="card-body">
                        <h5 class="card-title fw-bold">회사명: [[${req.companyName}]] <small class="text-white-50 fs-6">(회사번호: [[${req.companyPhone}]])</small></h5>
                        <h5 class="card-title fw-bold">담당자: [[${req.userName}]] <small class="text-white-50 fs-6">(연락처: [[${req.contact}]])</small></h5>

                        <hr class="custom-hr">

                        <p class="card-text mb-1"><strong>제조사/모델명:</strong> [[${req.vendor}]]/[[${req.modelName}]] </p>

                        <p class="card-text mb-1"><strong>장비 높이:</strong> <span class="text-warning fw-bold">[[${req.heightUnit}]] (U)</span></p>

                        <p class="card-text mb-1"><strong>장비 소비전력:</strong> <span class="text-danger fw-bold">[[${req.powerWatt}]] (W)</span></p>

                        <p class="card-text mb-1"><strong>EMS(신청여부):</strong>
                            <span th:if="${req.emsStatus == 'ON'}" class="badge custom-badge-success">EMS 신청</span>
                            <span th:unless="${req.emsStatus == 'ON'}" class="badge custom-badge-secondary">EMS 미신청</span>
                        </p>

                        <p class="card-text mb-1"><strong>입고 희망일:</strong> [[${req.startDate}]] <span class="text-white-50">(계약 기간: [[${req.termMonth}]]개월)</span></p>

                        <hr class="custom-hr">

                        <p class="card-text mb-1 mt-3"><strong>입고 목적:</strong></p>
                        <p class="card-text custom-purpose-box p-2 rounded">[[${req.purpose}]]</p>

                        <div class="d-flex gap-2 mt-3">
                            <a th:href="@{/racks(reqId=${req.id})}"
                               class="btn custom-btn-primary flex-grow-1 approve-btn"
                               th:data-is-deleted="${req.deleted}"> <i class="bi bi-check-lg"></i>
                                승인(자리 배정)
                            </a>

                            <button type="button"
                                    class="btn custom-btn-outline-danger flex-grow-1"
                                    data-bs-toggle="modal"
                                    data-bs-target="#rejectModal"
                                    th:data-id="${req.id}">
                                <i class="bi bi-x-circle me-1"></i>
                                반려
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div class="modal fade" id="memberDetailModal" tabindex="-1" aria-labelledby="memberDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title ps-2 text-white" id="memberDetailModalLabel">
                    <i class="bi bi-person-vcard-fill me-2"></i>회원 상세 정보
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body pt-4 px-4 pb-2">
                <div class="member-detail-row">
                    <strong class="text-cyan-label">ID:</strong>
                    <span id="modalId" class="text-white fs-5 fw-bold align-middle"></span>
                    <span id="modalRole" class="badge ms-2 align-middle"></span>
                </div>

                <div class="member-detail-row">
                    <strong class="text-cyan-label">이름:</strong>
                    <span id="modalName" class="text-white"></span>
                </div>

                <div class="member-detail-row">
                    <strong class="text-cyan-label">이메일:</strong>
                    <span id="modalEmail" class="text-white"></span>
                </div>

                <div class="member-detail-row">
                    <strong class="text-cyan-label">연락처:</strong>
                    <span id="modalContact" class="text-white"></span>
                </div>

                <hr class="my-4">

                <div class="member-detail-row">
                    <strong class="text-cyan-label">회사명:</strong>
                    <span id="modalCompany" class="text-white"></span>
                </div>

                <div class="member-detail-row">
                    <strong class="text-cyan-label">회사 전화번호:</strong>
                    <span id="modalCPhone" class="text-white"></span>
                </div>
            </div>

            <div class="modal-footer border-0 pt-0 pb-4 pe-4">
                <button type="button" class="btn-glass-close" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-octagon-fill me-2"></i>신청 반려 사유 입력
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form id="rejectForm" method="post">
                <div class="modal-body">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

                    <div class="mb-3">
                        <label class="form-label text-light">반려 사유</label>
                        <textarea name="rejectReason" class="form-control" rows="5"
                                  placeholder="구체적인 반려 사유를 입력해주세요. (선택사항)"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-danger">반려 확정</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function() {

        // 1. Toast 알림 설정
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });

        const successMessage = [[${successMessage}]];
        const errorMessage = [[${errorMessage}]];

        if (successMessage) Toast.fire({ icon: 'success', title: successMessage });
        if (errorMessage) Toast.fire({ icon: 'error', title: errorMessage });

        // ---------------------------------------------------------
        // [기능 0] 회원 상세 정보 모달 데이터 바인딩 (수정됨: 탈퇴 회원 표시 로직 추가)
        // ---------------------------------------------------------
        const memberDetailModal = document.getElementById('memberDetailModal');
        if (memberDetailModal) {
            memberDetailModal.addEventListener('show.bs.modal', event => {
                // 1. 클릭된 버튼(링크) 요소 가져오기
                const button = event.relatedTarget;

                // 2. data-* 속성 값 읽기
                const id = button.getAttribute('data-id');
                // 'true' 문자열인지 확인하여 boolean으로 변환
                const isDeleted = button.getAttribute('data-is-deleted') === 'true';

                let name = button.getAttribute('data-name');
                let email = button.getAttribute('data-email');
                let company = button.getAttribute('data-company');
                let contact = button.getAttribute('data-contact');
                let cphone = button.getAttribute('data-cphone');
                let role = button.getAttribute('data-role');

                // 3. [핵심 로직] 탈퇴한 회원일 경우 표시 정보 덮어쓰기
                const modalRoleBadge = document.getElementById('modalRole');
                const modalName = document.getElementById('modalName');

                if (isDeleted) {
                    // (1) 탈퇴 회원용 스타일 및 텍스트 적용
                    modalRoleBadge.textContent = '탈퇴 회원';
                    modalRoleBadge.className = 'badge bg-danger ms-2 align-middle'; // 빨간색 뱃지

                    modalName.textContent = name + " (탈퇴)";
                    modalName.className = 'text-danger fw-bold'; // 빨간색 텍스트

                    document.getElementById('modalEmail').textContent = email + " (계정 삭제됨)";
                    document.getElementById('modalEmail').className = 'text-white-50 text-decoration-line-through';
                } else {
                    // (2) 일반 회원용 스타일 적용 (원상복구)
                    modalRoleBadge.textContent = role ? role : 'USER';
                    if (role === 'ADMIN') {
                        modalRoleBadge.className = 'badge bg-danger ms-2 align-middle';
                    } else {
                        modalRoleBadge.className = 'badge bg-secondary ms-2 align-middle';
                    }

                    modalName.textContent = name;
                    modalName.className = 'text-white';

                    document.getElementById('modalEmail').textContent = email ? email : '-';
                    document.getElementById('modalEmail').className = 'text-white';
                }

                // 4. 나머지 공통 데이터 바인딩
                document.getElementById('modalId').textContent = id;
                document.getElementById('modalCompany').textContent = company;
                document.getElementById('modalCPhone').textContent = cphone;
                document.getElementById('modalContact').textContent = contact;
            });
        }


        // ---------------------------------------------------------
        // [기능 1] 반려(Reject) 관련 로직
        // ---------------------------------------------------------
        const rejectModal = document.getElementById('rejectModal');
        const rejectForm = document.getElementById('rejectForm');

        if (rejectModal) {
            rejectModal.addEventListener('show.bs.modal', event => {
                const button = event.relatedTarget;
                const reqId = button.getAttribute('data-id');
                rejectForm.setAttribute('action', `/requests/${reqId}/reject`);
            });
        }

        if (rejectForm) {
            rejectForm.addEventListener('submit', function(e) {
                e.preventDefault();

                Swal.fire({
                    title: '반려 확정',
                    text: "정말 이 신청을 반려하시겠습니까?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '네, 반려합니다',
                    cancelButtonText: '취소'
                }).then((result) => {
                    if (result.isConfirmed) {
                        submitRejectAjax(this);
                    }
                });
            });
        }

        function submitRejectAjax(form) {
            const url = form.getAttribute('action');
            const formData = new FormData(form);
            const csrfToken = document.querySelector('input[name="_csrf"]').value;

            const submitBtn = form.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>처리 중...`;

            fetch(url, {
                method: 'POST',
                headers: { 'X-CSRF-TOKEN': csrfToken },
                body: formData
            })
                .then(response => {
                    if (response.ok) {
                        const modalInstance = bootstrap.Modal.getInstance(rejectModal);
                        modalInstance.hide();
                        Toast.fire({ icon: 'success', title: '반려 처리가 완료되었습니다.' }).then(() => location.reload());
                    } else {
                        throw new Error('Server Error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    Swal.fire({ icon: 'error', title: '처리 실패', text: '서버 통신 중 오류가 발생했습니다.' });
                });
        }


        // ---------------------------------------------------------
        // [기능 2] 승인(Approve) 버튼 안전장치 (수정됨)
        // ---------------------------------------------------------
        const approveBtns = document.querySelectorAll('.approve-btn');

        approveBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault(); // 일단 링크 이동 막기

                // 1. 탈퇴 여부 확인
                const isDeleted = this.getAttribute('data-is-deleted') === 'true';

                // [★ 추가된 로직] 탈퇴한 회원이면 경고창 띄우고 중단
                if (isDeleted) {
                    Swal.fire({
                        icon: 'error',
                        title: '승인 불가',
                        text: '탈퇴한 회원의 요청은 승인할 수 없습니다.',
                        confirmButtonColor: '#d33',
                        confirmButtonText: '확인'
                    });
                    return; // 함수 종료 (페이지 이동 안 함)
                }

                // 2. 정상 회원이면 기존 승인 프로세스 진행
                const targetUrl = this.getAttribute('href');

                Swal.fire({
                    title: '입고 승인 진행',
                    text: "해당 요청을 승인하고 랙(Rack) 배정 단계로 이동하시겠습니까?",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#0d6efd',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '네, 진행합니다',
                    cancelButtonText: '취소'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = targetUrl;
                    }
                });
            });
        });

    });
</script>
</body>
</html>