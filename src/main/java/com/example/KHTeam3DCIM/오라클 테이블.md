/* * [DCIM 프로젝트 오라클 DB 초기화 스크립트]
 * * 작성일: 2024.05.21
 * 설명: 데이터센터 관리 시스템을 위한 테이블 및 시퀀스 생성
 * 주의: 기존에 같은 이름의 테이블이 있다면 삭제되고 새로 생성됩니다.
 */

-- ==========================================
-- 1. 기존 테이블 및 시퀀스 삭제 (초기화용)
-- ==========================================
-- 외래키(FK) 관계 때문에 자식 테이블부터 지워야 에러가 안 납니다.
DROP TABLE DC_LOG CASCADE CONSTRAINTS;
DROP TABLE DC_DEVICE CASCADE CONSTRAINTS;
DROP TABLE DC_CATEGORY CASCADE CONSTRAINTS;
DROP TABLE DC_RACK CASCADE CONSTRAINTS;
DROP TABLE DC_MEMBER CASCADE CONSTRAINTS;
DROP TABLE DC_REQUEST CASCADE CONSTRAINTS;

-- ... (나머지 동일)

DROP SEQUENCE SEQ_RACK_ID;
DROP SEQUENCE SEQ_DEVICE_ID;
DROP SEQUENCE SEQ_LOG_ID;



-- ==========================================
-- 2. 시퀀스 생성 (Auto Increment 대용)
-- ==========================================
CREATE SEQUENCE SEQ_RACK_ID START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_DEVICE_ID START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_LOG_ID START WITH 1 INCREMENT BY 1;


-- ==========================================
-- 3. 테이블 생성
-- ==========================================

-- (1) MEMBER: 관리자 테이블
CREATE TABLE DC_MEMBER (
    MEMBER_ID   VARCHAR2(50)  NOT NULL, -- 아이디
    PASSWORD    VARCHAR2(100) NOT NULL, -- 암호 (암호화 저장 권장)
    NAME        VARCHAR2(50)  NOT NULL, -- 이름
    ROLE        VARCHAR2(20)  DEFAULT 'USER', -- 권한 (ADMIN, USER)
    CONSTRAINT PK_MEMBER PRIMARY KEY (MEMBER_ID)
);

-- (2) DC_RACK: 랙 정보 (부모)
CREATE TABLE DC_RACK (
    RACK_ID       NUMBER        NOT NULL, -- 시퀀스 사용
    RACK_NAME     VARCHAR2(50)  NOT NULL, -- 랙 이름 (A-01)
    TOTAL_UNIT    NUMBER        DEFAULT 42, -- 총 높이 (기본 42U)
    LOCATION_DESC VARCHAR2(200),          -- 위치 설명
    CONSTRAINT PK_DC_RACK PRIMARY KEY (RACK_ID)
);

-- (3) DC_CATEGORY: 장비 분류 (기준정보)
CREATE TABLE DC_CATEGORY (
    CATE_ID     VARCHAR2(20)  NOT NULL, -- 코드 (SVR, NET, ETC)
    CATE_NAME   VARCHAR2(50)  NOT NULL, -- 이름 (Server, Network)
    CONSTRAINT PK_DC_CATEGORY PRIMARY KEY (CATE_ID)
);

-- (4) DC_DEVICE: 장비 상세 (자식) - 가장 중요
CREATE TABLE DC_DEVICE (
    DEVICE_ID   NUMBER        NOT NULL, -- 시퀀스 사용
    RACK_ID     NUMBER        NOT NULL, -- 어느 랙에?
    CATE_ID     VARCHAR2(20)  NOT NULL, -- 어떤 종류?
    VENDOR      VARCHAR2(50),           -- 제조사 (Dell)
    MODEL_NAME  VARCHAR2(100),          -- 모델명
    SERIAL_NUM  VARCHAR2(100) NOT NULL, -- 시리얼 (고유값)
    START_UNIT  NUMBER        NOT NULL, -- 시작 위치 (1~42)
    HEIGHT_UNIT NUMBER        NOT NULL, -- 높이 (1U, 2U, 4U)
    STATUS      VARCHAR2(20)  DEFAULT 'OFF', -- 상태 (RUNNING, OFF)
    IP_ADDR     VARCHAR2(50),           -- 관리 IP
    REG_DATE    DATE          DEFAULT SYSDATE, -- 등록일
    
    CONSTRAINT PK_DC_DEVICE PRIMARY KEY (DEVICE_ID),
    CONSTRAINT UK_DC_DEVICE_SERIAL UNIQUE (SERIAL_NUM), -- 시리얼 중복 방지
    
    -- 외래키(FK) 설정
    CONSTRAINT FK_DEVICE_RACK FOREIGN KEY (RACK_ID) 
        REFERENCES DC_RACK(RACK_ID) ON DELETE CASCADE, -- 랙 지우면 장비도 삭제
    CONSTRAINT FK_DEVICE_CATE FOREIGN KEY (CATE_ID) 
        REFERENCES DC_CATEGORY(CATE_ID)
);

-- (5) DC_LOG: 이력 관리
CREATE TABLE DC_LOG (
    LOG_ID        NUMBER        NOT NULL,
    MEMBER_ID     VARCHAR2(50),           -- 누가 (FK 안걸고 문자열로 남김)
    TARGET_DEVICE VARCHAR2(100),          -- 어떤 장비를 (이름이나 ID 기록)
    ACTION_TYPE   VARCHAR2(20),           -- INSERT, UPDATE, DELETE
    LOG_DATE      DATE          DEFAULT SYSDATE,
    CONSTRAINT PK_DC_LOG PRIMARY KEY (LOG_ID)
);


-- (6) REQUEST 고객 장비 입주 신청서 테이블 (추가)
CREATE TABLE DC_REQUEST (
    REQ_ID      NUMBER        NOT NULL, -- 신청서 번호
    USER_NAME   VARCHAR2(50)  NOT NULL, -- 신청자 이름 (또는 ID)
    CONTACT     VARCHAR2(50),           -- 연락처
    
    -- 장비 스펙 (아직 어떤 랙에 갈지는 모름)
    CATE_ID     VARCHAR2(20)  NOT NULL, -- 장비 종류 (SVR 등)
    VENDOR      VARCHAR2(50),           -- 제조사
    MODEL_NAME  VARCHAR2(100),          -- 모델명
    HEIGHT_UNIT NUMBER        NOT NULL, -- 몇 칸짜리인지 (중요)
    
    -- 처리 상태
    STATUS      VARCHAR2(20)  DEFAULT 'WAITING', -- WAITING, APPROVED, REJECTED
    REQ_DATE    DATE          DEFAULT SYSDATE,   -- 신청일
    
    CONSTRAINT PK_DC_REQUEST PRIMARY KEY (REQ_ID)
);

CREATE SEQUENCE SEQ_REQ_ID START WITH 1 INCREMENT BY 1;





-- ==========================================
-- 4. 기초 데이터(샘플) 입력 (테스트용)
-- ==========================================

-- (1) 관리자 생성
INSERT INTO DC_MEMBER (MEMBER_ID, PASSWORD, NAME, ROLE) 
VALUES ('admin', '1234', '관리자', 'ADMIN');

INSERT INTO DC_MEMBER (MEMBER_ID, PASSWORD, NAME, ROLE) 
VALUES ('user1', '1234', '김운영', 'USER');

-- (2) 카테고리 등록
INSERT INTO DC_CATEGORY VALUES ('SVR', 'Server');
INSERT INTO DC_CATEGORY VALUES ('NET', 'Network/Switch');
INSERT INTO DC_CATEGORY VALUES ('STO', 'Storage');
INSERT INTO DC_CATEGORY VALUES ('UPS', 'UPS/Power');

-- (3) 랙 등록 (A존 1번 랙)
INSERT INTO DC_RACK (RACK_ID, RACK_NAME, TOTAL_UNIT, LOCATION_DESC)
VALUES (SEQ_RACK_ID.NEXTVAL, 'A-01', 42, '3층 메인 전산실 입구 좌측');

-- (4) 장비 등록 (A-01 랙의 10번 위치에 2U짜리 서버 등록)
-- 주의: RACK_ID는 위에서 생성된 번호를 넣어야 함 (여기선 1번이라 가정)
INSERT INTO DC_DEVICE (
    DEVICE_ID, RACK_ID, CATE_ID, VENDOR, MODEL_NAME, SERIAL_NUM, 
    START_UNIT, HEIGHT_UNIT, STATUS, IP_ADDR
) VALUES (
    SEQ_DEVICE_ID.NEXTVAL, 
    1, -- RACK_ID (위에서 만든 A-01)
    'SVR', 
    'Dell', 'PowerEdge R740', 'SN-1001-TEST', 
    10, -- 10번 Unit부터
    2,  -- 2칸 차지 (10, 11 사용)
    'RUNNING', '192.168.0.101'
);

-- (5) 로그 남기기
INSERT INTO DC_LOG (LOG_ID, MEMBER_ID, TARGET_DEVICE, ACTION_TYPE)
VALUES (SEQ_LOG_ID.NEXTVAL, 'admin', 'SN-1001-TEST', 'INSERT');

-- ==========================================
-- 5. 변경사항 저장
-- ==========================================
COMMIT;

-- 확인 조회
SELECT * FROM DC_MEMBER;
SELECT * FROM DC_RACK;
SELECT * FROM DC_CATEGORY;
SELECT * FROM DC_DEVICE;
SELECT * FROM DC_LOG;
SELECT * FROM DC_REQUEST




-- ====== 25.12.11. DC_RACK 랙 테이블 데이터 수정!! =======

-- 1. 일단 싹 비우기 (자식인 장비부터 지워야 함)
DELETE FROM DC_DEVICE;
DELETE FROM DC_RACK;

-- 2. 시퀀스(번호표)도 초기화하고 싶다면 (선택사항 - 안 해도 됨)
DROP SEQUENCE SEQ_RACK_ID;
CREATE SEQUENCE SEQ_RACK_ID START WITH 1 INCREMENT BY 1;

-- 3. 깔끔한 샘플 데이터 2개만 넣기
INSERT INTO DC_RACK (RACK_ID, RACK_NAME, TOTAL_UNIT, LOCATION_DESC)
VALUES (SEQ_RACK_ID.NEXTVAL, 'A-01', 42, '3층 메인 전산실 입구 좌측');

INSERT INTO DC_RACK (RACK_ID, RACK_NAME, TOTAL_UNIT, LOCATION_DESC)
VALUES (SEQ_RACK_ID.NEXTVAL, 'B-05', 42, '3층 메인 전산실 안쪽');

-- 4. 저장
COMMIT;

-- 5. 확인해보기
SELECT * FROM DC_RACK;

-- 251212
-- 관리자페이지 로그
SELECT * FROM AUDIT_LOG;