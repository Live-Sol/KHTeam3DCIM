-- ==========================================================
-- 1. [초기화] 기존 테이블 및 시퀀스 전체 삭제
-- ==========================================================
-- FK 관계가 있어도 강제로 끊고 삭제(CASCADE CONSTRAINTS)
DROP TABLE DC_DEVICE CASCADE CONSTRAINTS;
DROP TABLE DC_REQUEST CASCADE CONSTRAINTS;
DROP TABLE DC_RACK CASCADE CONSTRAINTS;
DROP TABLE DC_CATEGORY CASCADE CONSTRAINTS;
DROP TABLE DC_MEMBER CASCADE CONSTRAINTS;
DROP TABLE AUDIT_LOG CASCADE CONSTRAINTS;

DROP SEQUENCE SEQ_RACK_ID;
DROP SEQUENCE SEQ_DEVICE_ID;
DROP SEQUENCE SEQ_REQ_ID;

-- ==========================================================
-- 2. [시퀀스] 번호표 생성기 생성
-- ==========================================================
CREATE SEQUENCE SEQ_RACK_ID START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_DEVICE_ID START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_REQ_ID START WITH 1 INCREMENT BY 1;

-- ==========================================================
-- 3. [테이블] DC_MEMBER 수정 (EMAIL 추가)
-- ==========================================================
CREATE TABLE DC_MEMBER (
MEMBER_ID     VARCHAR2(50)  NOT NULL, -- 아이디 (PK)
PASSWORD      VARCHAR2(100) NOT NULL, -- 암호
NAME          VARCHAR2(50)  NOT NULL, -- 담당자 성함
EMAIL         VARCHAR2(50)  NOT NULL, -- 이메일 (필수)
CONTACT       VARCHAR2(20),           -- 담당자 직통 번호
ROLE          VARCHAR2(20)  DEFAULT 'USER', -- 권한 (USER, ADMIN)
COMPANY_NAME  VARCHAR2(50),           -- 회사명
COMPANY_PHONE VARCHAR2(20),           -- 회사 대표 번호

CONSTRAINT PK_MEMBER PRIMARY KEY (MEMBER_ID)
);

-- (2) DC_CATEGORY: 장비 분류 (기준 정보)
CREATE TABLE DC_CATEGORY (
CATE_ID       VARCHAR2(20)  NOT NULL, -- 코드 (SVR, NET...)
CATE_NAME     VARCHAR2(50)  NOT NULL, -- 이름 (Server...)
CONSTRAINT PK_DC_CATEGORY PRIMARY KEY (CATE_ID)
);

-- (3) DC_RACK: 랙 정보
CREATE TABLE DC_RACK (
RACK_ID       NUMBER        NOT NULL, -- 시퀀스 적용
RACK_NAME     VARCHAR2(50)  NOT NULL UNIQUE, -- 랙 이름 (A-01) 중복금지
TOTAL_UNIT    NUMBER        DEFAULT 42, -- 총 높이
LOCATION_DESC VARCHAR2(200),          -- 위치 설명
CONSTRAINT PK_DC_RACK PRIMARY KEY (RACK_ID)
);

-- (4) DC_REQUEST: 입주 신청서 (상세 정보 포함)
CREATE TABLE DC_REQUEST (
REQ_ID        NUMBER        NOT NULL, -- 신청서 번호

    -- [신청자 및 회사 정보]
    USER_NAME     VARCHAR2(50)  NOT NULL, -- 담당자 성함
    CONTACT       VARCHAR2(20),           -- 담당자 직통 번호
    COMPANY_NAME  VARCHAR2(50),           -- 회사명
    COMPANY_PHONE VARCHAR2(20),           -- 회사 대표 번호
    
    -- [장비 스펙]
    CATE_ID       VARCHAR2(20),           -- 장비 종류
    VENDOR        VARCHAR2(50),           -- 제조사
    MODEL_NAME    VARCHAR2(100),          -- 모델명
    HEIGHT_UNIT   NUMBER        NOT NULL, -- 높이 (U)
    
    -- [계약 정보]
    PURPOSE       VARCHAR2(200),          -- 입고 목적
    START_DATE    DATE,                   -- 희망 입고일
    TERM_MONTH    NUMBER,                 -- 계약 기간 (개월)
    
    -- [관리 정보]
    STATUS        VARCHAR2(20)  DEFAULT 'WAITING', -- WAITING, APPROVED, REJECTED
    REQ_DATE      DATE          DEFAULT SYSDATE,   -- 신청 작성일
    
    CONSTRAINT PK_DC_REQUEST PRIMARY KEY (REQ_ID)
);

-- (5) DC_DEVICE: 장비 상세 (모든 정보 통합됨)
CREATE TABLE DC_DEVICE (
DEVICE_ID      NUMBER        NOT NULL, -- 장비 ID

    -- [연관 관계]
    RACK_ID        NUMBER        NOT NULL, -- 어느 랙?
    CATE_ID        VARCHAR2(20),           -- 어떤 종류?
    MEMBER_ID      VARCHAR2(50),           -- 실제 소유 회원 (FK)
    COMPANY_PHONE  VARCHAR2(20),           -- 회사 대표 번호
    USER_NAME      VARCHAR2(50),           -- 담당자 성함
    
    -- [장비 스펙]
    VENDOR         VARCHAR2(50),           -- 제조사
    MODEL_NAME     VARCHAR2(100),          -- 모델명
    SERIAL_NUM     VARCHAR2(100) NOT NULL UNIQUE, -- 시리얼 (중복불가)
    IP_ADDR        VARCHAR2(50),           -- 관리 IP
    
    -- [위치 및 상태]
    START_UNIT     NUMBER        NOT NULL, -- 시작 위치
    HEIGHT_UNIT    NUMBER        NOT NULL, -- 크기
    STATUS         VARCHAR2(20)  DEFAULT 'OFF', -- RUNNING, OFF
    REG_DATE       DATE          DEFAULT SYSDATE, -- 등록일
    
    -- [계약 및 소유자 텍스트 정보 (신청서 연동)]
    CONTRACT_DATE  DATE,                   -- 입고일
    CONTRACT_MONTH NUMBER,                 -- 계약기간
    OWNER_NAME     VARCHAR2(50),           -- 소유자명 (회사명)
    CONTACT_INFO   VARCHAR2(50),           -- 담당자 연락처
    DESCRIPTION    VARCHAR2(500),          -- 용도 및 설명
    
    CONSTRAINT PK_DC_DEVICE PRIMARY KEY (DEVICE_ID),
    
    -- 외래키(FK) 설정
    CONSTRAINT FK_DEVICE_RACK FOREIGN KEY (RACK_ID) 
        REFERENCES DC_RACK(RACK_ID) ON DELETE CASCADE,
    CONSTRAINT FK_DEVICE_CATE FOREIGN KEY (CATE_ID) 
        REFERENCES DC_CATEGORY(CATE_ID),
    CONSTRAINT FK_DEVICE_MEMBER FOREIGN KEY (MEMBER_ID)
        REFERENCES DC_MEMBER(MEMBER_ID)
);

-- (6) AUDIT_LOG: 감사 로그
CREATE TABLE AUDIT_LOG (
ID                 NUMBER GENERATED BY DEFAULT AS IDENTITY,
ACTOR              VARCHAR2(255 CHAR),
ACTION_DESCRIPTION VARCHAR2(500 CHAR),
LOG_TYPE           VARCHAR2(255 CHAR),
TIMESTAMP          TIMESTAMP,
CONSTRAINT PK_AUDIT_LOG PRIMARY KEY (ID)
);

-- ==========================================================
-- 4. 카테고리 (필수)
-- ==========================================================

INSERT INTO DC_CATEGORY VALUES ('SVR', 'Server');
INSERT INTO DC_CATEGORY VALUES ('NET', 'Network/Switch');
INSERT INTO DC_CATEGORY VALUES ('STO', 'Storage');
INSERT INTO DC_CATEGORY VALUES ('UPS', 'UPS/Power');


-- ==========================================================
-- 5. [완료] 저장 및 확인
-- ==========================================================
COMMIT;

SELECT * FROM DC_MEMBER;
SELECT * FROM DC_DEVICE;

-- 1. 전력 소비량 (단위: Watt) - 최대 99999W까지
ALTER TABLE DC_DEVICE ADD POWER_WATT NUMBER(5) DEFAULT 0;
-- 2. EMS 감시 모드 여부 (ON/OFF 또는 YES/NO)
ALTER TABLE DC_DEVICE ADD EMS_STATUS VARCHAR2(10) DEFAULT 'OFF';

-- 멤버 테이블에 프로필 이미지 추가(25.12.17.)
ALTER TABLE DC_MEMBER ADD PROFILE_IMAGE VARCHAR2(200);

-- 신청 반려 사유 추가 (25.12.22)
ALTER TABLE DC_REQUEST ADD REJECT_REASON VARCHAR2(300);

-- 탈퇴한 회원 관리 (25.12.22)
ALTER TABLE DC_MEMBER
ADD IS_DELETED NUMBER(1);

UPDATE DC_MEMBER
SET IS_DELETED = 0
WHERE IS_DELETED IS NULL;

ALTER TABLE DC_MEMBER
MODIFY IS_DELETED NUMBER(1) NOT NULL;

ALTER TABLE DC_MEMBER
ADD CONSTRAINT CK_DC_MEMBER_IS_DELETED
CHECK (IS_DELETED IN (0,1));




